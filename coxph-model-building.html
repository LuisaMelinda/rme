<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Regression Models for Epidemiology - 7&nbsp; Building Cox Proportional Hazards models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./parametric-survival-models.html" rel="next">
<link href="./proportional-hazards-models.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./coxph-model-building.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Regression Models for Epidemiology</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/d-morrison/rme" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-GLMs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Statistical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalized Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linear-models-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Linear (Gaussian) Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Logistic Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./count-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Models for Count Outcomes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./time-to-event-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time to Event Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-survival-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./proportional-hazards-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coxph-model-building.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric-survival-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#configuring-r" id="toc-configuring-r" class="nav-link active" data-scroll-target="#configuring-r">Configuring R</a></li>
  <li>
<a href="#building-cox-proportional-hazards-models" id="toc-building-cox-proportional-hazards-models" class="nav-link" data-scroll-target="#building-cox-proportional-hazards-models"><span class="header-section-number">8</span> Building Cox Proportional Hazards models</a>
  <ul class="collapse">
<li>
<a href="#hodg-lymphoma-data-set-from-kmsurv" id="toc-hodg-lymphoma-data-set-from-kmsurv" class="nav-link" data-scroll-target="#hodg-lymphoma-data-set-from-kmsurv"><span class="header-section-number">8.1</span> <code>hodg</code> Lymphoma Data Set from <code>KMsurv</code></a>
  <ul class="collapse">
<li><a href="#participants" id="toc-participants" class="nav-link" data-scroll-target="#participants">Participants</a></li>
  <li><a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables">Variables</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  </ul>
</li>
  <li><a href="#proportional-hazards-model" id="toc-proportional-hazards-model" class="nav-link" data-scroll-target="#proportional-hazards-model"><span class="header-section-number">8.2</span> Proportional hazards model</a></li>
  </ul>
</li>
  <li>
<a href="#diagnostic-graphs-for-proportional-hazards-assumption" id="toc-diagnostic-graphs-for-proportional-hazards-assumption" class="nav-link" data-scroll-target="#diagnostic-graphs-for-proportional-hazards-assumption"><span class="header-section-number">9</span> Diagnostic graphs for proportional hazards assumption</a>
  <ul class="collapse">
<li><a href="#analysis-plan" id="toc-analysis-plan" class="nav-link" data-scroll-target="#analysis-plan"><span class="header-section-number">9.1</span> Analysis plan</a></li>
  <li><a href="#kaplan-meier-survival-functions" id="toc-kaplan-meier-survival-functions" class="nav-link" data-scroll-target="#kaplan-meier-survival-functions"><span class="header-section-number">9.2</span> Kaplan-Meier survival functions</a></li>
  <li><a href="#observed-and-expected-survival-curves" id="toc-observed-and-expected-survival-curves" class="nav-link" data-scroll-target="#observed-and-expected-survival-curves"><span class="header-section-number">9.3</span> Observed and expected survival curves</a></li>
  <li><a href="#cumulative-hazard-log-scale-curves" id="toc-cumulative-hazard-log-scale-curves" class="nav-link" data-scroll-target="#cumulative-hazard-log-scale-curves"><span class="header-section-number">9.4</span> Cumulative hazard (log-scale) curves</a></li>
  </ul>
</li>
  <li>
<a href="#predictions-and-residuals" id="toc-predictions-and-residuals" class="nav-link" data-scroll-target="#predictions-and-residuals"><span class="header-section-number">10</span> Predictions and Residuals</a>
  <ul class="collapse">
<li><a href="#review-predictions-in-linear-regression" id="toc-review-predictions-in-linear-regression" class="nav-link" data-scroll-target="#review-predictions-in-linear-regression"><span class="header-section-number">10.1</span> Review: Predictions in Linear Regression</a></li>
  <li><a href="#review-residuals-in-linear-regression" id="toc-review-residuals-in-linear-regression" class="nav-link" data-scroll-target="#review-residuals-in-linear-regression"><span class="header-section-number">10.2</span> Review: Residuals in Linear Regression</a></li>
  <li><a href="#predictions-and-residuals-in-survival-models" id="toc-predictions-and-residuals-in-survival-models" class="nav-link" data-scroll-target="#predictions-and-residuals-in-survival-models"><span class="header-section-number">10.3</span> Predictions and Residuals in survival models</a></li>
  <li><a href="#wide-prediction-intervals" id="toc-wide-prediction-intervals" class="nav-link" data-scroll-target="#wide-prediction-intervals"><span class="header-section-number">10.4</span> Wide prediction intervals</a></li>
  <li><a href="#types-of-residuals-in-time-to-event-models" id="toc-types-of-residuals-in-time-to-event-models" class="nav-link" data-scroll-target="#types-of-residuals-in-time-to-event-models"><span class="header-section-number">10.5</span> Types of Residuals in Time-to-Event Models</a></li>
  <li>
<a href="#schoenfeld-residuals" id="toc-schoenfeld-residuals" class="nav-link" data-scroll-target="#schoenfeld-residuals"><span class="header-section-number">10.6</span> Schoenfeld residuals</a>
  <ul class="collapse">
<li><a href="#gtype" id="toc-gtype" class="nav-link" data-scroll-target="#gtype"><code>gtype</code></a></li>
  <li><a href="#dtype" id="toc-dtype" class="nav-link" data-scroll-target="#dtype"><code>dtype</code></a></li>
  <li><a href="#score" id="toc-score" class="nav-link" data-scroll-target="#score"><code>score</code></a></li>
  <li><a href="#wtime" id="toc-wtime" class="nav-link" data-scroll-target="#wtime"><code>wtime</code></a></li>
  <li><a href="#gtypedtype" id="toc-gtypedtype" class="nav-link" data-scroll-target="#gtypedtype"><code>gtype:dtype</code></a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#goodness-of-fit-using-the-cox-snell-residuals" id="toc-goodness-of-fit-using-the-cox-snell-residuals" class="nav-link" data-scroll-target="#goodness-of-fit-using-the-cox-snell-residuals"><span class="header-section-number">11</span> Goodness of Fit using the Cox-Snell Residuals</a></li>
  <li>
<a href="#martingale-residuals" id="toc-martingale-residuals" class="nav-link" data-scroll-target="#martingale-residuals"><span class="header-section-number">12</span> Martingale Residuals</a>
  <ul class="collapse">
<li>
<a href="#using-martingale-residuals" id="toc-using-martingale-residuals" class="nav-link" data-scroll-target="#using-martingale-residuals"><span class="header-section-number">12.1</span> Using Martingale Residuals</a>
  <ul class="collapse">
<li><a href="#karnofsky-score" id="toc-karnofsky-score" class="nav-link" data-scroll-target="#karnofsky-score">Karnofsky score</a></li>
  <li><a href="#waiting-time" id="toc-waiting-time" class="nav-link" data-scroll-target="#waiting-time">Waiting time</a></li>
  <li><a href="#updating-the-model" id="toc-updating-the-model" class="nav-link" data-scroll-target="#updating-the-model">Updating the model</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#checking-for-outliers-and-influential-observations" id="toc-checking-for-outliers-and-influential-observations" class="nav-link" data-scroll-target="#checking-for-outliers-and-influential-observations"><span class="header-section-number">13</span> Checking for Outliers and Influential Observations</a>
  <ul class="collapse">
<li><a href="#deviance-residuals" id="toc-deviance-residuals" class="nav-link" data-scroll-target="#deviance-residuals"><span class="header-section-number">13.1</span> Deviance Residuals</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">13.2</span> </a></li>
  <li>
<a href="#dfbeta" id="toc-dfbeta" class="nav-link" data-scroll-target="#dfbeta"><span class="header-section-number">13.3</span> dfbeta</a>
  <ul class="collapse">
<li><a href="#graft-type" id="toc-graft-type" class="nav-link" data-scroll-target="#graft-type">Graft type</a></li>
  <li><a href="#disease-type" id="toc-disease-type" class="nav-link" data-scroll-target="#disease-type">Disease type</a></li>
  <li><a href="#karnofsky-score-1" id="toc-karnofsky-score-1" class="nav-link" data-scroll-target="#karnofsky-score-1">Karnofsky score</a></li>
  <li><a href="#waiting-time-dichotomized" id="toc-waiting-time-dichotomized" class="nav-link" data-scroll-target="#waiting-time-dichotomized">Waiting time (dichotomized)</a></li>
  <li><a href="#interaction-graft-type-and-disease-type" id="toc-interaction-graft-type-and-disease-type" class="nav-link" data-scroll-target="#interaction-graft-type-and-disease-type">Interaction: graft type and disease type</a></li>
  </ul>
</li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"><span class="header-section-number">13.4</span> </a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2"><span class="header-section-number">13.5</span> </a></li>
  <li><a href="#action-items" id="toc-action-items" class="nav-link" data-scroll-target="#action-items"><span class="header-section-number">13.6</span> Action Items</a></li>
  </ul>
</li>
  <li>
<a href="#stratified-survival-models" id="toc-stratified-survival-models" class="nav-link" data-scroll-target="#stratified-survival-models"><span class="header-section-number">14</span> Stratified survival models</a>
  <ul class="collapse">
<li><a href="#revisiting-the-leukemia-dataset-anderson" id="toc-revisiting-the-leukemia-dataset-anderson" class="nav-link" data-scroll-target="#revisiting-the-leukemia-dataset-anderson"><span class="header-section-number">14.1</span> Revisiting the leukemia dataset (<code>anderson</code>)</a></li>
  <li>
<a href="#cox-semi-parametric-proportional-hazards-model" id="toc-cox-semi-parametric-proportional-hazards-model" class="nav-link" data-scroll-target="#cox-semi-parametric-proportional-hazards-model"><span class="header-section-number">14.2</span> Cox semi-parametric proportional hazards model</a>
  <ul class="collapse">
<li><a href="#test-the-proportional-hazards-assumption" id="toc-test-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#test-the-proportional-hazards-assumption">Test the proportional hazards assumption</a></li>
  <li><a href="#graph-the-k-m-survival-curves" id="toc-graph-the-k-m-survival-curves" class="nav-link" data-scroll-target="#graph-the-k-m-survival-curves">Graph the K-M survival curves</a></li>
  </ul>
</li>
  <li><a href="#graph-the-nelson-aalen-cumulative-hazard" id="toc-graph-the-nelson-aalen-cumulative-hazard" class="nav-link" data-scroll-target="#graph-the-nelson-aalen-cumulative-hazard"><span class="header-section-number">14.3</span> Graph the Nelson-Aalen cumulative hazard</a></li>
  <li><a href="#the-stratified-cox-model" id="toc-the-stratified-cox-model" class="nav-link" data-scroll-target="#the-stratified-cox-model"><span class="header-section-number">14.4</span> The Stratified Cox Model</a></li>
  <li><a href="#conclusions-1" id="toc-conclusions-1" class="nav-link" data-scroll-target="#conclusions-1"><span class="header-section-number">14.5</span> Conclusions</a></li>
  <li><a href="#another-modeling-approach" id="toc-another-modeling-approach" class="nav-link" data-scroll-target="#another-modeling-approach"><span class="header-section-number">14.6</span> Another Modeling Approach</a></li>
  </ul>
</li>
  <li>
<a href="#time-varying-covariates" id="toc-time-varying-covariates" class="nav-link" data-scroll-target="#time-varying-covariates"><span class="header-section-number">15</span> Time-varying covariates</a>
  <ul class="collapse">
<li>
<a href="#motivating-example-back-to-the-leukemia-dataset" id="toc-motivating-example-back-to-the-leukemia-dataset" class="nav-link" data-scroll-target="#motivating-example-back-to-the-leukemia-dataset"><span class="header-section-number">15.1</span> Motivating example: back to the leukemia dataset</a>
  <ul class="collapse">
<li><a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing">Preprocessing</a></li>
  </ul>
</li>
  <li><a href="#time-dependent-covariates" id="toc-time-dependent-covariates" class="nav-link" data-scroll-target="#time-dependent-covariates"><span class="header-section-number">15.2</span> Time-Dependent Covariates</a></li>
  <li><a href="#analysis-in-r" id="toc-analysis-in-r" class="nav-link" data-scroll-target="#analysis-in-r"><span class="header-section-number">15.3</span> Analysis in R</a></li>
  <li><a href="#event-sequences" id="toc-event-sequences" class="nav-link" data-scroll-target="#event-sequences"><span class="header-section-number">15.4</span> Event sequences</a></li>
  <li><a href="#model-with-time-fixed-covariates" id="toc-model-with-time-fixed-covariates" class="nav-link" data-scroll-target="#model-with-time-fixed-covariates"><span class="header-section-number">15.5</span> Model with Time-Fixed Covariates</a></li>
  <li><a href="#model-with-time-dependent-covariates" id="toc-model-with-time-dependent-covariates" class="nav-link" data-scroll-target="#model-with-time-dependent-covariates"><span class="header-section-number">15.6</span> Model with Time-Dependent Covariates</a></li>
  </ul>
</li>
  <li>
<a href="#recurrent-events" id="toc-recurrent-events" class="nav-link" data-scroll-target="#recurrent-events"><span class="header-section-number">16</span> Recurrent Events</a>
  <ul class="collapse">
<li>
<a href="#bladder-cancer-data-set" id="toc-bladder-cancer-data-set" class="nav-link" data-scroll-target="#bladder-cancer-data-set"><span class="header-section-number">16.1</span> Bladder Cancer Data Set</a>
  <ul class="collapse">
<li><a href="#data-dictionary" id="toc-data-dictionary" class="nav-link" data-scroll-target="#data-dictionary">Data dictionary</a></li>
  <li><a href="#different-intervals-for-the-same-patient-are-correlated." id="toc-different-intervals-for-the-same-patient-are-correlated." class="nav-link" data-scroll-target="#different-intervals-for-the-same-patient-are-correlated.">Different intervals for the same patient are correlated.</a></li>
  <li><a href="#adding-cluster-id" id="toc-adding-cluster-id" class="nav-link" data-scroll-target="#adding-cluster-id">adding <code>cluster = id</code></a></li>
  </ul>
</li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/d-morrison/rme/edit/main/coxph-model-building.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified: 2023-07-07: 17:24:08 (PM)</p>
    </div>
  </div>
  
    
  </div>
  

</header><div class="hidden">

</div>
<section id="configuring-r" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="configuring-r">Configuring R</h2>
<p>Functions from these packages will be used throughout this document:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/packages_56e7e5ab9f5d9790e2356bfa79be5c97">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/">pander</a></span><span class="op">)</span> <span class="co"># format tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> <span class="co"># graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sinhrks/ggfortify">ggfortify</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonocarroll/ggeasy">ggeasy</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span> <span class="co"># survival analysis graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># manipulate data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span> <span class="co"># format R output for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span> <span class="co"># Tools to help to create tidy data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span> <span class="co"># interactive graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dobson</span><span class="op">)</span> <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span> <span class="co"># filesystem path manipulations</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">KMsurv</span><span class="op">)</span> <span class="co"># datasets from Klein and Moeschberger</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span> <span class="co"># check for conflicting function definitions</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are some R settings I use in this document:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/options_97a95b0bf1e35134b55927381c66dabd">
<details><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># delete any data that's already loaded into R</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="st">'digits'</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">legend_text_size</span> <span class="op">=</span> <span class="fl">9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="building-cox-proportional-hazards-models" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Building Cox Proportional Hazards models</h1>
<section id="hodg-lymphoma-data-set-from-kmsurv" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="hodg-lymphoma-data-set-from-kmsurv">
<span class="header-section-number">8.1</span> <code>hodg</code> Lymphoma Data Set from <code>KMsurv</code>
</h2>
<section id="participants" class="level3"><h3 class="anchored" data-anchor-id="participants">Participants</h3>
<p>43 bone marrow transplant patients at Ohio State University (Avalos 1993)</p>
</section><section id="variables" class="level3"><h3 class="anchored" data-anchor-id="variables">Variables</h3>
<ul>
<li>
<code>dtype</code>: Disease type (Hodgkin’s or non-Hodgkins lymphoma)</li>
<li>
<code>gtype</code>: Bone marrow graft type:</li>
<li>allogeneic: from HLA-matched sibling</li>
<li>autologous: from self (prior to chemo)</li>
<li>
<code>time</code>: time to study exit</li>
<li>
<code>delta</code>: study exit reason (death/relapse vs censored)</li>
<li>
<code>wtime</code>: waiting time to transplant (in months)</li>
<li>
<code>score</code>: Karnofsky score:</li>
<li>80–100: Able to carry on normal activity and to work; no special care needed.</li>
<li>50–70: Unable to work; able to live at home and care for most personal needs; varying amount of assistance needed.</li>
<li>10–60: Unable to care for self; requires equivalent of institutional or hospital care; disease may be progressing rapidly.</li>
</ul></section><section id="data" class="level3"><h3 class="anchored" data-anchor-id="data">Data</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-1_060ed784c52e1c2eceec620c14f90869">
<details><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">hodg</span>, package <span class="op">=</span> <span class="st">"KMsurv"</span><span class="op">)</span></span>
<span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># We add factor labels to the categorical variables:</span></span>
<span>    gtype <span class="op">=</span> <span class="va">gtype</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Allogenic"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Autologous"</span><span class="op">)</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">dtype</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Non-Hodgkins"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Hodgkins"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Non-Hodgkins"</span><span class="op">)</span>, </span>
<span>    delta <span class="op">=</span> <span class="va">delta</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"dead"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"alive"</span><span class="op">)</span>,</span>
<span>    surv <span class="op">=</span> <span class="fu">Surv</span><span class="op">(</span></span>
<span>      time <span class="op">=</span> <span class="va">time</span>, </span>
<span>      event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 43 × 7
   gtype     dtype         time delta score wtime   surv
   &lt;chr&gt;     &lt;fct&gt;        &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;Surv&gt;
 1 Allogenic Non-Hodgkins    28 dead     90    24    28 
 2 Allogenic Non-Hodgkins    32 dead     30     7    32 
 3 Allogenic Non-Hodgkins    49 dead     40     8    49 
 4 Allogenic Non-Hodgkins    84 dead     60    10    84 
 5 Allogenic Non-Hodgkins   357 dead     70    42   357 
 6 Allogenic Non-Hodgkins   933 alive    90     9   933+
 7 Allogenic Non-Hodgkins  1078 alive   100    16  1078+
 8 Allogenic Non-Hodgkins  1183 alive    90    16  1183+
 9 Allogenic Non-Hodgkins  1560 alive    80    20  1560+
10 Allogenic Non-Hodgkins  2114 alive    80    27  2114+
# ℹ 33 more rows</code></pre>
</div>
</div>
</section></section><section id="proportional-hazards-model" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="proportional-hazards-model">
<span class="header-section-number">8.2</span> Proportional hazards model</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-2_5c4885d86bc75e62039713b533485443">
<details><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox1</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">gtype</span> <span class="op">*</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">score</span> <span class="op">+</span> <span class="va">wtime</span>, </span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">hodg.cox1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ gtype * dtype + score + wtime, data = hodg2)

  n= 43, number of events= 26 

                                 coef exp(coef) se(coef)     z Pr(&gt;|z|)    
gtypeAutologous                0.6394    1.8953   0.5937  1.08   0.2815    
dtypeHodgkins                  2.7603   15.8050   0.9474  2.91   0.0036 ** 
score                         -0.0495    0.9517   0.0124 -3.98  6.8e-05 ***
wtime                         -0.0166    0.9836   0.0102 -1.62   0.1046    
gtypeAutologous:dtypeHodgkins -2.3709    0.0934   1.0355 -2.29   0.0220 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                              exp(coef) exp(-coef) lower .95 upper .95
gtypeAutologous                  1.8953     0.5276    0.5920     6.068
dtypeHodgkins                   15.8050     0.0633    2.4682   101.207
score                            0.9517     1.0507    0.9288     0.975
wtime                            0.9836     1.0167    0.9641     1.003
gtypeAutologous:dtypeHodgkins    0.0934    10.7074    0.0123     0.711

Concordance= 0.776  (se = 0.059 )
Likelihood ratio test= 32.1  on 5 df,   p=6e-06
Wald test            = 27.2  on 5 df,   p=5e-05
Score (logrank) test = 37.7  on 5 df,   p=4e-07</code></pre>
</div>
</div>
</section></section><section id="diagnostic-graphs-for-proportional-hazards-assumption" class="level1" data-number="9"><h1 data-number="9">
<span class="header-section-number">9</span> Diagnostic graphs for proportional hazards assumption</h1>
<section id="analysis-plan" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="analysis-plan">
<span class="header-section-number">9.1</span> Analysis plan</h2>
<ul>
<li>
<strong>survival function</strong> for the four combinations of disease type and graft type.</li>
<li>
<strong>observed (nonparametric) vs.&nbsp;expected (semiparametric) survival</strong> functions.</li>
<li>
<strong>complementary log-log survival</strong> for the four groups.</li>
</ul></section><section id="kaplan-meier-survival-functions" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="kaplan-meier-survival-functions">
<span class="header-section-number">9.2</span> Kaplan-Meier survival functions</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-4_52da330d8b77e4e2d6ddf223ab3850f9">
<details><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_model</span> <span class="op">=</span> <span class="fu">survfit</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">gtype</span>,</span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">'Survival probability, S(t)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time since transplant (days)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Kaplan-Meier Survival Curves for HOD/NHL and Allo/Auto Grafts</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="observed-and-expected-survival-curves" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="observed-and-expected-survival-curves">
<span class="header-section-number">9.3</span> Observed and expected survival curves</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-5_ff47869d33247a52deb328887882efff">
<details><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># we need to create a tibble of covariate patterns;</span></span>
<span><span class="co"># we will set score and wtime to mean values for disease and graft types:</span></span>
<span><span class="va">means</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span><span class="op">)</span>, </span>
<span>    score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span>, </span>
<span>    wtime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">wtime</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># survfit.coxph() will use the rownames of its `newdata`</span></span>
<span><span class="co"># argument to label its output:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">=</span> <span class="va">means</span><span class="op">$</span><span class="va">strata</span></span>
<span></span>
<span><span class="va">cox_model</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survfit</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">hodg2</span>, <span class="co"># ggsurvplot() will need this</span></span>
<span>    newdata <span class="op">=</span> <span class="va">means</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-6_559c8ea4e66232001fc3d789178a191d">
<details><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># I couldn't find a good function to reformat `cox_model` for ggplot, </span></span>
<span><span class="co"># so I made my own:</span></span>
<span><span class="va">stack_surv_ph</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">cox_model</span><span class="op">$</span><span class="va">surv</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">cox_model</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="op">-</span><span class="va">time</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"surv"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      cumhaz <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">surv</span><span class="op">)</span>,</span>
<span>      model <span class="op">=</span> <span class="st">"Cox PH"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">km_and_cph</span> <span class="op">=</span></span>
<span>  <span class="va">km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span>surv.connect <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"Kaplan-Meier"</span>,</span>
<span>    cumhaz <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">surv</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">stack_surv_ph</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-7_3c7ea9a2ebdefd646bdd9e0820858d33">
<details><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_and_cph</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">surv</span>, col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"S(t) = P(T&gt;=t)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Survival time (t, days)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Observed and expected survival curves for <code>bmt</code> data</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="cumulative-hazard-log-scale-curves" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="cumulative-hazard-log-scale-curves">
<span class="header-section-number">9.4</span> Cumulative hazard (log-scale) curves</h2>
<p>Also known as “complementary log-log (clog-log) survival curves”.</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-10_1cfbacacf7650cd58aebe65f6b287e90">
<details><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">na_model</span> <span class="op">=</span> <span class="fu">survfit</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">gtype</span>,</span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">na_model</span> <span class="op">|&gt;</span> <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>  legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>  legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">'cloglog'</span>, </span>
<span>  size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>  ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  conf.int <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  censor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>    col <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span></span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        label.theme <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>            size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Complementary log-log survival curves - Nelson-Aalen estimates</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s compare these empirical (i.e., non-parametric) curves with the fitted curves from our <code>coxph()</code> model:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-11_5fffd4a1618f0b630972a8666b423982">
<details><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cox_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>    facet_by <span class="op">=</span> <span class="st">""</span>,</span>
<span>    legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">'cloglog'</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>    ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    censor <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># doesn't make sense for cox model</span></span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>    col <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span></span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        label.theme <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>            size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Complementary log-log survival curves - PH estimates</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s overlay these cumulative hazard curves:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-12_c902f0328f9217946d2def02e6d33806">
<details><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">na_and_cph</span> <span class="op">=</span> </span>
<span>  <span class="va">na_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"cumhaz"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># `fortify.survfit()` doesn't name cumhaz correctly:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cumhaz <span class="op">=</span> <span class="va">surv</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">cumhaz</span><span class="op">)</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Nelson-Aalen"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">stack_surv_ph</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">na_and_cph</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">time</span>, </span>
<span>      y <span class="op">=</span> <span class="va">cumhaz</span>, </span>
<span>      col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Cumulative hazard H(t) (log-scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Survival time (t, days, log-scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Observed and expected cumulative hazard curves for <code>bmt</code> data (cloglog format)</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="predictions-and-residuals" class="level1" data-number="10"><h1 data-number="10">
<span class="header-section-number">10</span> Predictions and Residuals</h1>
<section id="review-predictions-in-linear-regression" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="review-predictions-in-linear-regression">
<span class="header-section-number">10.1</span> Review: Predictions in Linear Regression</h2>
<ul>
<li>In linear regression, we have a linear predictor for each data point <span class="math inline">\(i\)</span>
</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\eta_i &amp;= \beta_0+\beta_1x_{1i}+\cdots+\beta_px_{pi}\\
\hat y_i &amp;=\hat\eta_i = \hat\beta_0+\hat\beta_1x_{1i}+\cdots+\hat\beta_px_{pi}\\
y_i &amp;\sim N(\eta_i,\sigma^2)
\end{aligned}
\]</span></p>
<ul>
<li>
<span class="math inline">\(\hat y_i\)</span> estimates the conditional mean of <span class="math inline">\(y_i\)</span> given the covariate values <span class="math inline">\(\tilde x_i\)</span>. This together with the prediction error says that we are predicting the distribution of values of <span class="math inline">\(y\)</span>.</li>
</ul></section><section id="review-residuals-in-linear-regression" class="level2" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="review-residuals-in-linear-regression">
<span class="header-section-number">10.2</span> Review: Residuals in Linear Regression</h2>
<ul>
<li>The usual residual is <span class="math inline">\(r_i=y_i-\hat y_i\)</span>, the difference between the actual value of <span class="math inline">\(y\)</span> and a prediction of its mean.</li>
<li>The residuals are also the quantities the sum of whose squares is being minimized by the least squares/MLE estimation.</li>
</ul></section><section id="predictions-and-residuals-in-survival-models" class="level2" data-number="10.3"><h2 data-number="10.3" class="anchored" data-anchor-id="predictions-and-residuals-in-survival-models">
<span class="header-section-number">10.3</span> Predictions and Residuals in survival models</h2>
<ul>
<li>In survival analysis, the equivalent of <span class="math inline">\(y_i\)</span> is the event time <span class="math inline">\(t_i\)</span>, which is unknown for the censored observations.</li>
<li>The expected event time can be tricky to calculate:</li>
</ul>
<p><span class="math display">\[
\hat{\text{E}}[T|X=x] = \int_{t=0}^{\infty} \hat S(t)dt
\]</span></p>
</section><section id="wide-prediction-intervals" class="level2" data-number="10.4"><h2 data-number="10.4" class="anchored" data-anchor-id="wide-prediction-intervals">
<span class="header-section-number">10.4</span> Wide prediction intervals</h2>
<p>The nature of time-to-event data results in very wide prediction intervals:</p>
<ul>
<li>Suppose a cancer patient is predicted to have a mean lifetime of 5 years after diagnosis and suppose the distribution is exponential.</li>
<li>If we want a 95% interval for survival, the lower end is at the 0.025 percentage point of the exponential which is <code>qexp(.025, rate = 1/5)</code> = 0.1266 years, or 1/40 of the mean lifetime.</li>
<li>The upper end is at the 0.975 point which is <code>qexp(.975, rate = 1/5)</code> = 18.4444 years, or 3.7 times the mean lifetime.</li>
<li>Saying that the survival time is somewhere between 6 weeks and 18 years does not seem very useful, but it may be the best we can do.</li>
<li>For survival analysis, something is like a residual if it is small when the model is accurate or if the accumulation of them is in some way minimized by the estimation algorithm, but there is no exact equivalence to linear regression residuals.</li>
<li>And if there is, they are mostly quite large!</li>
</ul></section><section id="types-of-residuals-in-time-to-event-models" class="level2" data-number="10.5"><h2 data-number="10.5" class="anchored" data-anchor-id="types-of-residuals-in-time-to-event-models">
<span class="header-section-number">10.5</span> Types of Residuals in Time-to-Event Models</h2>
<ul>
<li>It is often hard to make a decision from graph appearances, though the process can reveal much.</li>
<li>Some diagnostic tests are based on residuals as with other regression methods:</li>
<li>
<strong>Schoenfeld residuals</strong> (via <code>cox.zph</code>) for proportionality.</li>
<li>
<strong>Cox-Snell residuals</strong> for goodness of fit.</li>
<li>
<strong>martingale residuals</strong> for non-linearity.</li>
<li>
<strong>dfbeta</strong> for influence.</li>
</ul></section><section id="schoenfeld-residuals" class="level2" data-number="10.6"><h2 data-number="10.6" class="anchored" data-anchor-id="schoenfeld-residuals">
<span class="header-section-number">10.6</span> Schoenfeld residuals</h2>
<ul>
<li><p>There is a Schoenfeld residual for each subject <span class="math inline">\(i\)</span> with an event (not censored) and for each predictor <span class="math inline">\(x_{k}\)</span>.</p></li>
<li><p>At the event time <span class="math inline">\(t\)</span> for that subject, there is a risk set <span class="math inline">\(R\)</span>, and each subject <span class="math inline">\(j\)</span> in the risk set has a risk coefficient <span class="math inline">\(\theta_j\)</span> and also a value <span class="math inline">\(x_{jk}\)</span> of the predictor.</p></li>
<li><p>The Schoenfeld residual is the difference between <span class="math inline">\(x_{ik}\)</span> and the risk-weighted average of all the <span class="math inline">\(x_{jk}\)</span> over the risk set.</p></li>
</ul>
<p><span class="math display">\[
r^S_{ik} =
x_{ik}-\frac{\sum_{k\in R}x_{jk}\theta_k}{\sum_{k\in R}\theta_k}
\]</span></p>
<p>This residual measures how typical the individual subject is with respect to the covariate at the time of the event. Since subjects should fail more or less uniformly according to risk, the Schoenfeld residuals should be approximately level over time, not increasing or decreasing.</p>
<p>We can test this with the correlation with time on some scale, which could be the time itself, the log time, or the rank in the set of failure times.</p>
<p>The default is to use the KM curve as a transform, which is similar to the rank but deals better with censoring.</p>
<p>The <code>cox.zph()</code> function implements a score test proposed by Grambsch and Therneau<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-13_e2b92947defc4d5182148aebb2ed90e4">
<details><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.zph</span> <span class="op">=</span> <span class="fu">cox.zph</span><span class="op">(</span><span class="va">hodg.cox1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">hodg.zph</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>              chisq df     p
gtype        0.5400  1 0.462
dtype        1.8012  1 0.180
score        3.8805  1 0.049
wtime        0.0173  1 0.895
gtype:dtype  4.0474  1 0.044
GLOBAL      13.7573  5 0.017</code></pre>
</div>
</div>
<section id="gtype" class="level3"><h3 class="anchored" data-anchor-id="gtype"><code>gtype</code></h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-14_b82ca8f10a18f7b68fcca00301ed4e54">
<details><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"gtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="dtype" class="level3"><h3 class="anchored" data-anchor-id="dtype"><code>dtype</code></h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-15_f4abaeb76c0464c7e6f9c154a2f454e7">
<details><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"dtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="score" class="level3"><h3 class="anchored" data-anchor-id="score"><code>score</code></h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-16_903252a83d0b8cb1a85b00fe3f2d9f1e">
<details><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"score"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="wtime" class="level3"><h3 class="anchored" data-anchor-id="wtime"><code>wtime</code></h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-17_1f4a57b56214617d5ce35252b31e871f">
<details><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"wtime"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="gtypedtype" class="level3"><h3 class="anchored" data-anchor-id="gtypedtype"><code>gtype:dtype</code></h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-18_d907365f0411b0a07f78060f27f8b33e">
<details><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"gtype:dtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="conclusions" class="level3"><h3 class="anchored" data-anchor-id="conclusions">Conclusions</h3>
<ul>
<li>From the correlation test, the Karnofsky score and the interaction with graft type disease type induce modest but statistically significant non-proportionality.</li>
<li>The sample size here is relatively small (26 events in 43 subjects). If the sample size is large, very small amounts of non-proportionality can induce a significant result.</li>
<li>As time goes on, autologous grafts are over-represented at their own event times, but those from HOD patients become less represented.</li>
<li>Both the statistical tests and the plots are useful.</li>
</ul></section></section></section><section id="goodness-of-fit-using-the-cox-snell-residuals" class="level1" data-number="11"><h1 data-number="11">
<span class="header-section-number">11</span> Goodness of Fit using the Cox-Snell Residuals</h1>
<p>(references: Klein &amp; Moeschberger textbook, §11.2, and Dobson &amp; Barnett textbook, §10.6)</p>
<p>Suppose that an individual has a survival time <span class="math inline">\(T\)</span> which has survival function <span class="math inline">\(S(t)\)</span>, meaning that <span class="math inline">\(\Pr(T&gt; t) = S(t)\)</span>. Then <span class="math inline">\(S(T)\)</span> has a uniform distribution on <span class="math inline">\((0,1)\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\Pr(S(T_i) \le u)
&amp;= \Pr(T_i &gt; S_i^{-1}(u))\\
&amp;= S_i(S_i^{-1}(u))\\
&amp;= u
\end{aligned}
\]</span></p>
<p>Also, if <span class="math inline">\(U\)</span> has a uniform distribution on <span class="math inline">\((0,1)\)</span>, then what is the distribution of <span class="math inline">\(-\ln(U)\)</span>?</p>
<p><span class="math display">\[
\begin{aligned}
\Pr(-\ln(U) &lt; x) &amp;= \Pr(U&gt;\exp(-x))\\
&amp;= 1-e^{-x}
\end{aligned}
\]</span></p>
<p>which is the CDF of an exponential distribution with parameter <span class="math inline">\(\lambda=1\)</span>.</p>
<p>So,</p>
<p><span class="math display">\[
\begin{aligned}
r^{CS}_i&amp;
\stackrel{\text{def}}{=}-\ln[\hat S(t_i|x_i)]
= \hat H(t_i|\tilde x_i)
\end{aligned}
\]</span></p>
<p>should have an exponential distribution with constant hazard <span class="math inline">\(\lambda=1\)</span> if the estimate <span class="math inline">\(\hat S_i\)</span> is accurate, which means that these values should look like a censored sample from this exponential distribution. These values are called <strong>generalized residuals</strong> or <strong>Cox-Snell residuals</strong>.</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-19_553983b7e16c89608adba5b8bdac9177">
<details><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">hodg.cox1</span>, type <span class="op">=</span> <span class="st">"expected"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">surv.csr</span> <span class="op">=</span> <span class="fu">survfit</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span>,</span>
<span>  formula <span class="op">=</span> <span class="fu">Surv</span><span class="op">(</span>time <span class="op">=</span> <span class="va">cs</span>, event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming-harrington"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">surv.csr</span>, fun <span class="op">=</span> <span class="st">"cumhaz"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Cumulative Hazard of Cox-Snell Residuals</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The line with slope 1 and intercept 0 fits the curve relatively well, so we don’t see lack of fit using this procedure.</p>
</section><section id="martingale-residuals" class="level1" data-number="12"><h1 data-number="12">
<span class="header-section-number">12</span> Martingale Residuals</h1>
<p>The <strong>martingale residuals</strong> are a slight modification of the Cox-Snell residuals. If the censoring indicator is <span class="math inline">\(\delta_i\)</span>, then <span class="math display">\[r^M_i=\delta_i-r^{CS}_i\]</span> These residuals can be interpreted as an estimate of the excess number of events seen in the data but not predicted by the model. We will use these to examine the functional forms of continuous covariates.</p>
<section id="using-martingale-residuals" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="using-martingale-residuals">
<span class="header-section-number">12.1</span> Using Martingale Residuals</h2>
<p>Martingale residuals can be used to examine the functional form of a numeric variable.</p>
<ul>
<li>We fit the model without that variable and compute the martingale residuals.</li>
<li>We then plot these martingale residuals against the values of the variable.</li>
<li>We can see curvature, or a possible suggestion that the variable can be discretized.</li>
</ul>
<p>Let’s use this to examine the <code>score</code> and <code>wtime</code> variables in the <code>wtime</code> data set.</p>
<section id="karnofsky-score" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="karnofsky-score">Karnofsky score</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-20_29aa3461bf06b4f84059c6a55766e20a">
<details><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    mres <span class="op">=</span> </span>
<span>      <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">score</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">score</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Karnofsky Score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Martingale Residuals vs.&nbsp;Karnofsky Score</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The line is almost straight. It could be some modest transformation of the Karnofsky score would help, but it might not make much difference.</p>
</section><section id="waiting-time" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="waiting-time">Waiting time</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-21_d967d0beee8a899eee8a1916e31c7c97">
<details><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span><span class="op">$</span><span class="va">mres</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">wtime</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wtime</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Waiting Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Martingale Residuals vs.&nbsp;Waiting Time</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The line could suggest a step function. To see where the drop is, we can look at the largest waiting times and the associated martingale residual.</p>
<p>The martingale residuals are all negative for <code>wtime</code> &gt;83 and positive for the next smallest value. A reasonable cut-point is 80 days.</p>
</section><section id="updating-the-model" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="updating-the-model">Updating the model</h3>
<p>Let’s reformulate the model with dichotomized <code>wtime</code>.</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-22_768032ea96cbb04d9d398ee585be7230">
<details><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    wt2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">wtime</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>      labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"short"</span>,<span class="st">"long"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg.cox2</span> <span class="op">=</span></span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="fu">Surv</span><span class="op">(</span><span class="va">time</span>, event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span> <span class="op">~</span> </span>
<span>      <span class="va">gtype</span><span class="op">*</span><span class="va">dtype</span> <span class="op">+</span> <span class="va">score</span> <span class="op">+</span> <span class="va">wt2</span>,</span>
<span>    data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-cap="Model summary table with waiting time on continuous scale" data-hash="coxph-model-building_cache/html/unnamed-chunk-23_d08c267069ace6bcfb768b3ef588500a">
<details><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
surv ~ gtype * dtype + score + wtime
            Df AIC   LRT Pr(&gt;Chi)    
&lt;none&gt;         152                   
score        1 168 17.24  3.3e-05 ***
wtime        1 154  3.28     0.07 .  
gtype:dtype  1 156  5.44     0.02 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell" data-tbl-cap="Model summary table with dichotomized waiting time" data-hash="coxph-model-building_cache/html/unnamed-chunk-24_2c9db99ec3ee8c1a191b36aabdd3c5e0">
<details><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
Surv(time, event = delta == "dead") ~ gtype * dtype + score + 
    wt2
            Df AIC   LRT Pr(&gt;Chi)    
&lt;none&gt;         149                   
score        1 169 21.60  3.4e-06 ***
wt2          1 154  6.61    0.010 *  
gtype:dtype  1 152  4.97    0.026 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The new model has better (lower) AIC.</p>
</section></section></section><section id="checking-for-outliers-and-influential-observations" class="level1" data-number="13"><h1 data-number="13">
<span class="header-section-number">13</span> Checking for Outliers and Influential Observations</h1>
<p>We will check for outliers using the deviance residuals. The martingale residuals show excess events or the opposite, but highly skewed, with the maximum possible value being 1, but the smallest value can be very large negative. Martingale residuals can detect unexpectedly long-lived patients, but patients who die unexpectedly early show up only in the deviance residual. Influence will be examined using dfbeta in a similar way to linear regression, logistic regression, or Poisson regression.</p>
<section id="deviance-residuals" class="level2" data-number="13.1"><h2 data-number="13.1" class="anchored" data-anchor-id="deviance-residuals">
<span class="header-section-number">13.1</span> Deviance Residuals</h2>
<p><span class="math display">\[
\begin{aligned}
r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left[ r_i^M+\delta_i\ln(\delta_i-r_i^M)  \right]}\\
r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left[ r_i^M+\delta_i\ln(r_i^{CS})  \right]}
\end{aligned}
\]</span></p>
<p>Roughly centered on 0 with approximate standard deviation 1.</p>
</section><section id="section" class="level2" data-number="13.2"><h2 data-number="13.2" class="anchored" data-anchor-id="section">
<span class="header-section-number">13.2</span> </h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-25_921af89a1972cee185782a29d77301f2">
<details><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.mart</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span><span class="va">hodg.dev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"deviance"</span><span class="op">)</span></span>
<span><span class="va">hodg.dfb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"dfbeta"</span><span class="op">)</span></span>
<span><span class="va">hodg.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">hodg.cox2</span><span class="op">)</span>                   <span class="co">#linear predictor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-26_0347152eb8cd47cde2f93a46a89e77dd">
<details><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.preds</span>,</span>
<span>     <span class="va">hodg.mart</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Linear Predictor"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Martingale Residual"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Martingale Residuals vs.&nbsp;Linear Predictor</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The smallest three martingale residuals in order are observations 1, 29, and 18.</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-27_fbc2d0303b0d7539373b289e8d5b26e3">
<details><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.preds</span>,<span class="va">hodg.dev</span>,xlab<span class="op">=</span><span class="st">"Linear Predictor"</span>,ylab<span class="op">=</span><span class="st">"Deviance Residual"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Deviance Residuals vs.&nbsp;Linear Predictor</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The two largest deviance residuals are observations 1 and 29. Worth examining.</p>
</section><section id="dfbeta" class="level2" data-number="13.3"><h2 data-number="13.3" class="anchored" data-anchor-id="dfbeta">
<span class="header-section-number">13.3</span> dfbeta</h2>
<ul>
<li><p>dfbeta is the approximate change in the coefficient vector if that observation were dropped</p></li>
<li><p>dfbetas is the approximate change in the coefficients, scaled by the standard error for the coefficients.</p></li>
</ul>
<section id="graft-type" class="level3"><h3 class="anchored" data-anchor-id="graft-type">Graft type</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-28_d171f628d4a92d01818fb7948da97eb0">
<details><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,xlab<span class="op">=</span><span class="st">"Observation Order"</span>,ylab<span class="op">=</span><span class="st">"dfbeta for Graft Type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">dfbeta Values by Observation Order for Graft Type</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The smallest dfbeta for graft type is observation 1.</p>
</section><section id="disease-type" class="level3"><h3 class="anchored" data-anchor-id="disease-type">Disease type</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-29_10ba9a3087768922bb87e7b83c04a3cb">
<details><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for Disease Type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">dfbeta Values by Observation Order for Disease Type</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The smallest two dfbeta values for disease type are observations 1 and 16.</p>
</section><section id="karnofsky-score-1" class="level3"><h3 class="anchored" data-anchor-id="karnofsky-score-1">Karnofsky score</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-30_7a6f60a5a9447ccabd9cb90dac743a72">
<details><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for Karnofsky Score"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">dfbeta Values by Observation Order for Karnofsky Score</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The two highest dfbeta values for score are observations 1 and 18. The next three are observations 17, 29, and 19. The smallest value is observation 2.</p>
</section><section id="waiting-time-dichotomized" class="level3"><h3 class="anchored" data-anchor-id="waiting-time-dichotomized">Waiting time (dichotomized)</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-31_e6d60f1b72ae011ed786f34b000f58d9">
<details><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>,</span>
<span>  xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>  ylab<span class="op">=</span><span class="st">"dfbeta for `Waiting Time &lt; 80`"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">dfbeta Values by Observation Order for Waiting Time (dichotomized)</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The two large values of dfbeta for dichotomized waiting time are observations 15 and 16. This may have to do with the discretization of waiting time.</p>
</section><section id="interaction-graft-type-and-disease-type" class="level3"><h3 class="anchored" data-anchor-id="interaction-graft-type-and-disease-type">Interaction: graft type and disease type</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-32_ea81e96263459ea4761e180ffccb2569">
<details><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for dtype:gtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">dfbeta Values by Observation Order for dtype:gtype</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The two largest values are observations 1 and 16. The smallest value is observation 35.</p>
</section></section><section id="section-1" class="level2" data-number="13.4"><h2 data-number="13.4" class="anchored" data-anchor-id="section-1">
<span class="header-section-number">13.4</span> </h2>
<table class="table">
<caption>Observations to Examine by Residuals and Influence</caption>
<thead><tr class="header">
<th>Diagnostic</th>
<th>Observations to Examine</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Martingale Residuals</td>
<td>1, 29, 18</td>
</tr>
<tr class="even">
<td>Deviance Residuals</td>
<td>1, 29</td>
</tr>
<tr class="odd">
<td>Graft Type Influence</td>
<td>1</td>
</tr>
<tr class="even">
<td>Disease Type Influence</td>
<td>1, 16</td>
</tr>
<tr class="odd">
<td>Karnofsky Score Influence</td>
<td>1, 18 (17, 29, 19)</td>
</tr>
<tr class="even">
<td>Waiting Time Influence</td>
<td>15, 16</td>
</tr>
<tr class="odd">
<td>Graft by Disease Influence</td>
<td>1, 16, 35</td>
</tr>
</tbody>
</table>
<p>The most important observations to examine seem to be 1, 15, 16, 18, and 29.</p>
</section><section id="section-2" class="level2" data-number="13.5"><h2 data-number="13.5" class="anchored" data-anchor-id="section-2">
<span class="header-section-number">13.5</span> </h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-33_c282fad72fc844c729e4822f76d6fd73">
<details><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">time</span><span class="op">[</span><span class="va">delta</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    2.0    41.2    62.5    97.6    83.2   524.0 </code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-34_8bb9577b1b43ca8ba658b6659f7ea8ff">
<details><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">wtime</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    5.0    16.0    24.0    37.7    55.5   171.0 </code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-35_84f43c6b7ef10398c22a609ead995014">
<details><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   20.0    60.0    80.0    76.3    90.0   100.0 </code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-36_ca43485a7fa6f3a6ce28a8affb2a86fa">
<details><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, event = delta == "dead") ~ gtype * 
    dtype + score + wt2, data = hodg2)

                               coef exp(coef) se(coef)  z     p
gtypeAutologous                0.67      1.94     0.59  1 0.263
dtypeHodgkins                  2.33     10.25     0.73  3 0.002
score                         -0.06      0.95     0.01 -4 8e-06
wt2long                       -2.06      0.13     1.05 -2 0.050
gtypeAutologous:dtypeHodgkins -2.07      0.13     0.93 -2 0.026

Likelihood ratio test=35  on 5 df, p=1e-06
n= 43, number of events= 26 </code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-37_422ae836356e8fc11ec1fc1e7db596bb">
<details><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">15</span>,<span class="fl">16</span>,<span class="fl">18</span>,<span class="fl">29</span><span class="op">)</span>,<span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gtype</span>, <span class="va">dtype</span>, <span class="va">time</span>, <span class="va">delta</span>, <span class="va">score</span>, <span class="va">wtime</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    comment <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"early death, good score, low risk"</span>,</span>
<span>        <span class="st">"high risk grp, long wait, poor score"</span>,</span>
<span>        <span class="st">"high risk grp, short wait, poor score"</span>,</span>
<span>        <span class="st">"early death, good score, med risk grp"</span>,</span>
<span>        <span class="st">"early death, good score, med risk grp"</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  gtype      dtype         time delta score wtime comment                       
  &lt;chr&gt;      &lt;fct&gt;        &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;                         
1 Allogenic  Non-Hodgkins    28 dead     90    24 early death, good score, low …
2 Allogenic  Hodgkins        77 dead     60   102 high risk grp, long wait, poo…
3 Allogenic  Hodgkins        79 dead     70    71 high risk grp, short wait, po…
4 Autologous Non-Hodgkins    53 dead     90    17 early death, good score, med …
5 Autologous Hodgkins        30 dead     90    73 early death, good score, med …</code></pre>
</div>
</div>
</section><section id="action-items" class="level2" data-number="13.6"><h2 data-number="13.6" class="anchored" data-anchor-id="action-items">
<span class="header-section-number">13.6</span> Action Items</h2>
<ul>
<li>Unusual points may need checking, particularly if the data are not completely cleaned. In this case, observations 15 and 16 may show some trouble with the dichotomization of waiting time, but it still may be useful.</li>
<li>The two largest residuals seem to be due to unexpectedly early deaths, but unfortunately this can occur.</li>
<li>If hazards don’t look proportional, then we may need to use strata, between which the base hazards are permitted to be different. For this problem, the natural strata are the two diseases, because they could need to be managed differently anyway.</li>
<li>A main point that we want to be sure of is the relative risk difference by disease type and graft type.</li>
</ul>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-38_6a156ad8648a3b827ec32149feb98f79">
<details><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span></span>
<span>    reference <span class="op">=</span> <span class="st">"zero"</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">means</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        wt2 <span class="op">=</span> <span class="st">"short"</span>, </span>
<span>        score <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"lp"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">'linear predictor'</span> <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/pander/man/pander.html">pander</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Linear Risk Predictors for Lymphoma </caption>
<colgroup>
<col style="width: 41%">
<col style="width: 26%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">linear.predictor</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Non-Hodgkins,Allogenic</strong></td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Non-Hodgkins,Autologous</strong></td>
<td style="text-align: center;">0.6651</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Hodgkins,Allogenic</strong></td>
<td style="text-align: center;">2.327</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Hodgkins,Autologous</strong></td>
<td style="text-align: center;">0.9256</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For Non-Hodgkin’s, the allogenic graft is better. For Hodgkin’s, the autologous graft is much better.</p>
</section></section><section id="stratified-survival-models" class="level1" data-number="14"><h1 data-number="14">
<span class="header-section-number">14</span> Stratified survival models</h1>
<section id="revisiting-the-leukemia-dataset-anderson" class="level2" data-number="14.1"><h2 data-number="14.1" class="anchored" data-anchor-id="revisiting-the-leukemia-dataset-anderson">
<span class="header-section-number">14.1</span> Revisiting the leukemia dataset (<code>anderson</code>)</h2>
<p>We will analyze remission survival times on 42 leukemia patients, half on new treatment, half on standard treatment.</p>
<p>This is the same data as the <code>drug6mp</code> data from <code>KMsurv</code>, but with two other variables and without the pairing. This version comes from the Kleinbaum and Klein survival textbook (e.g., p281):</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-39_d67f2e6c86603da470801b04d6830502">
<details><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets/"</span>,</span>
<span>    <span class="st">"surv2datasets/anderson.dta"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    status <span class="op">=</span> <span class="va">status</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"relapse"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"censored"</span></span>
<span>      <span class="op">)</span>,</span>
<span>    </span>
<span>    sex <span class="op">=</span> <span class="va">sex</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"male"</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"female"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    rx <span class="op">=</span> <span class="va">rx</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"new"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"standard"</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    surv <span class="op">=</span> <span class="fu">Surv</span><span class="op">(</span></span>
<span>      time <span class="op">=</span> <span class="va">survt</span>, </span>
<span>      event <span class="op">=</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"relapse"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">anderson</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 42 × 7
   survt status   sex    logwbc rx    lwbc3   surv
   &lt;dbl&gt; &lt;chr&gt;    &lt;fct&gt;   &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt; &lt;Surv&gt;
 1    35 censored male     1.45 new       1    35+
 2    34 censored male     1.47 new       1    34+
 3    32 censored male     2.2  new       1    32+
 4    32 censored male     2.53 new       2    32+
 5    25 censored male     1.78 new       1    25+
 6    23 relapse  male     2.57 new       2    23 
 7    22 relapse  male     2.32 new       2    22 
 8    20 censored male     2.01 new       1    20+
 9    19 censored female   2.05 new       1    19+
10    17 censored female   2.16 new       1    17+
# ℹ 32 more rows</code></pre>
</div>
</div>
</section><section id="cox-semi-parametric-proportional-hazards-model" class="level2" data-number="14.2"><h2 data-number="14.2" class="anchored" data-anchor-id="cox-semi-parametric-proportional-hazards-model">
<span class="header-section-number">14.2</span> Cox semi-parametric proportional hazards model</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-40_45c5ff290953f3dd97287f6715ed8ace">
<details><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.cox1</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.cox1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ rx + sex + logwbc, data = anderson)

  n= 42, number of events= 30 

          coef exp(coef) se(coef)     z Pr(&gt;|z|)    
rxnew   -1.504     0.222    0.462 -3.26   0.0011 ** 
sexmale  0.315     1.370    0.455  0.69   0.4887    
logwbc   1.682     5.376    0.337  5.00  5.8e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
rxnew       0.222      4.498     0.090     0.549
sexmale     1.370      0.730     0.562     3.338
logwbc      5.376      0.186     2.779    10.398

Concordance= 0.851  (se = 0.041 )
Likelihood ratio test= 47.2  on 3 df,   p=3e-10
Wald test            = 33.5  on 3 df,   p=2e-07
Score (logrank) test = 48  on 3 df,   p=2e-10</code></pre>
</div>
</div>
<section id="test-the-proportional-hazards-assumption" class="level3"><h3 class="anchored" data-anchor-id="test-the-proportional-hazards-assumption">Test the proportional hazards assumption</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-41_b47d0e3d5b0453c0f2d39904a23c6e95">
<details><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">cox.zph</span><span class="op">(</span><span class="va">anderson.cox1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>       chisq df    p
rx     0.036  1 0.85
sex    5.420  1 0.02
logwbc 0.142  1 0.71
GLOBAL 5.879  3 0.12</code></pre>
</div>
</div>
</section><section id="graph-the-k-m-survival-curves" class="level3"><h3 class="anchored" data-anchor-id="graph-the-k-m-survival-curves">Graph the K-M survival curves</h3>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-42_d0ed881b35f86f6cc12003aab7488fd7">
<details><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson_km_model</span> <span class="op">=</span> <span class="fu">survfit</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson_km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="coxph-model-building_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The survival curves cross, which indicates a problem in the proportionality assumption by sex.</p>
</section></section><section id="graph-the-nelson-aalen-cumulative-hazard" class="level2" data-number="14.3"><h2 data-number="14.3" class="anchored" data-anchor-id="graph-the-nelson-aalen-cumulative-hazard">
<span class="header-section-number">14.3</span> Graph the Nelson-Aalen cumulative hazard</h2>
<p>We can also look at the log-hazard (“cloglog survival”) plots:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-43_adb87139ced328969ad6547a1feb76e1">
<details><summary>Code</summary><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson_na_model</span> <span class="op">=</span> <span class="fu">survfit</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson_na_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="st">"cumhaz"</span>,</span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"log(Cumulative Hazard)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Cumulative hazard (H(t), log scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">5</span>,<span class="fl">10</span>,<span class="fl">20</span>,<span class="fl">50</span><span class="op">)</span>,</span>
<span>    trans <span class="op">=</span> <span class="st">"log"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Scale for y is already present.
Adding another scale for y, which will replace the existing scale.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Transformation introduced infinite values in continuous y-axis</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Transformation introduced infinite values in continuous x-axis</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Cumulative hazard (cloglog scale) for <code>anderson</code> data</figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This can be fixed by using strata or possibly by other model alterations.</p>
</section><section id="the-stratified-cox-model" class="level2" data-number="14.4"><h2 data-number="14.4" class="anchored" data-anchor-id="the-stratified-cox-model">
<span class="header-section-number">14.4</span> The Stratified Cox Model</h2>
<ul>
<li>In a stratified Cox model, each stratum, defined by one or more factors, has its own base survival function <span class="math inline">\(h_0(t)\)</span>.</li>
<li>But the coefficients for each variable not used in the strata definitions are assumed to be the same across strata.</li>
<li>To check if this assumption is reasonable one can include interactions with strata and see if they are significant (this may generate a warning and NA lines but these can be ignored).</li>
<li>Since the <code>sex</code> variable shows possible non-proportionality, we try stratifying on <code>sex</code>.</li>
</ul>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-44_79859ad64845a929b13a02586f11f947">
<details><summary>Code</summary><div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.strat</span> <span class="op">=</span> </span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span> <span class="op">+</span> <span class="fu">strata</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.strat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ rx + logwbc + strata(sex), data = anderson)

  n= 42, number of events= 30 

         coef exp(coef) se(coef)     z Pr(&gt;|z|)    
rxnew  -0.998     0.369    0.474 -2.11    0.035 *  
logwbc  1.454     4.279    0.344  4.22  2.4e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
rxnew      0.369      2.713     0.146     0.932
logwbc     4.279      0.234     2.180     8.398

Concordance= 0.812  (se = 0.059 )
Likelihood ratio test= 32.1  on 2 df,   p=1e-07
Wald test            = 22.8  on 2 df,   p=1e-05
Score (logrank) test = 30.8  on 2 df,   p=2e-07</code></pre>
</div>
</div>
<p>Let’s compare this to a model fit only on the subset of males:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-45_44184fb0f8d191f36978a12439758e59">
<details><summary>Code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.male</span> <span class="op">=</span> </span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.male</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ rx + logwbc, data = anderson, subset = sex == 
    "male")

  n= 20, number of events= 14 

         coef exp(coef) se(coef)     z Pr(&gt;|z|)   
rxnew  -1.978     0.138    0.739 -2.68   0.0075 **
logwbc  1.743     5.713    0.536  3.25   0.0011 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
rxnew      0.138      7.227    0.0325     0.589
logwbc     5.713      0.175    1.9991    16.328

Concordance= 0.905  (se = 0.043 )
Likelihood ratio test= 29.2  on 2 df,   p=5e-07
Wald test            = 15.3  on 2 df,   p=5e-04
Score (logrank) test = 26.4  on 2 df,   p=2e-06</code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-46_c1772ebfa7e5865f5064b8b6066ca52f">
<details><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.female</span> <span class="op">=</span> </span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"female"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.female</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ rx + logwbc, data = anderson, subset = sex == 
    "female")

  n= 22, number of events= 16 

         coef exp(coef) se(coef)     z Pr(&gt;|z|)  
rxnew  -0.311     0.733    0.564 -0.55    0.581  
logwbc  1.206     3.341    0.503  2.40    0.017 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
rxnew      0.733      1.365     0.243      2.21
logwbc     3.341      0.299     1.245      8.96

Concordance= 0.692  (se = 0.085 )
Likelihood ratio test= 6.65  on 2 df,   p=0.04
Wald test            = 6.36  on 2 df,   p=0.04
Score (logrank) test = 6.74  on 2 df,   p=0.03</code></pre>
</div>
</div>
<p>The coefficients of treatment look different. Are they statistically different?</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-47_4846a4346220253a8be5e70c2b7de654">
<details><summary>Code</summary><div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.strat.intxn</span> <span class="op">=</span> </span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="fu">strata</span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson.coxph.strat.intxn</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ strata(sex) * (rx + logwbc), data = anderson)

  n= 42, number of events= 30 

                         coef exp(coef) se(coef)     z Pr(&gt;|z|)  
rxnew                  -0.311     0.733    0.564 -0.55    0.581  
logwbc                  1.206     3.341    0.503  2.40    0.017 *
strata(sex)male:rxnew  -1.667     0.189    0.930 -1.79    0.073 .
strata(sex)male:logwbc  0.537     1.710    0.735  0.73    0.465  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                       exp(coef) exp(-coef) lower .95 upper .95
rxnew                      0.733      1.365    0.2427      2.21
logwbc                     3.341      0.299    1.2452      8.96
strata(sex)male:rxnew      0.189      5.294    0.0305      1.17
strata(sex)male:logwbc     1.710      0.585    0.4048      7.23

Concordance= 0.797  (se = 0.058 )
Likelihood ratio test= 35.8  on 4 df,   p=3e-07
Wald test            = 21.7  on 4 df,   p=2e-04
Score (logrank) test = 33.1  on 4 df,   p=1e-06</code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-48_6047abadc864d0e3a3f895150831bbab">
<details><summary>Code</summary><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span></span>
<span>  <span class="va">anderson.coxph.strat.intxn</span>,</span>
<span>  <span class="va">anderson.coxph.strat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table
 Cox model: response is  surv
 Model 1: ~ strata(sex) * (rx + logwbc)
 Model 2: ~ rx + logwbc + strata(sex)
  loglik Chisq Df Pr(&gt;|Chi|)
1  -53.9                    
2  -55.7  3.77  2       0.15</code></pre>
</div>
</div>
<p>We don’t have enough evidence to tell the difference between these two models.</p>
</section><section id="conclusions-1" class="level2" data-number="14.5"><h2 data-number="14.5" class="anchored" data-anchor-id="conclusions-1">
<span class="header-section-number">14.5</span> Conclusions</h2>
<ul>
<li>We chose to use a stratified model because of the apparent non-proportionality of the hazard for the sex variable.</li>
<li>When we fit interactions with the strata variable, we did not get an improved model (via the likelihood ratio test).</li>
<li>So we use the stratifed model with coefficients that are the same across strata.</li>
</ul></section><section id="another-modeling-approach" class="level2" data-number="14.6"><h2 data-number="14.6" class="anchored" data-anchor-id="another-modeling-approach">
<span class="header-section-number">14.6</span> Another Modeling Approach</h2>
<ul>
<li>We used an additive model without interactions and saw that we might need to stratify by sex.</li>
<li>Instead, we could try to improve the model’s functional form - maybe the interaction of treatment and sex is real, and after fitting that we might not need separate hazard functions.</li>
<li>Either approach may work.</li>
</ul>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-49_213037b277f3f3689f6eee6744a46c89">
<details><summary>Code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.intxn</span> <span class="op">=</span> </span>
<span>  <span class="fu">coxph</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="op">(</span><span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson.coxph.intxn</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ (rx + logwbc) * sex, data = anderson)

  n= 42, number of events= 30 

                  coef exp(coef) se(coef)     z Pr(&gt;|z|)  
rxnew          -0.3748    0.6874   0.5545 -0.68    0.499  
logwbc          1.0637    2.8971   0.4726  2.25    0.024 *
sexmale        -2.8052    0.0605   2.0323 -1.38    0.167  
rxnew:sexmale  -2.1782    0.1132   0.9109 -2.39    0.017 *
logwbc:sexmale  1.2303    3.4223   0.6301  1.95    0.051 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

               exp(coef) exp(-coef) lower .95 upper .95
rxnew             0.6874      1.455   0.23185     2.038
logwbc            2.8971      0.345   1.14730     7.315
sexmale           0.0605     16.531   0.00113     3.248
rxnew:sexmale     0.1132      8.830   0.01899     0.675
logwbc:sexmale    3.4223      0.292   0.99539    11.766

Concordance= 0.861  (se = 0.036 )
Likelihood ratio test= 57  on 5 df,   p=5e-11
Wald test            = 35.6  on 5 df,   p=1e-06
Score (logrank) test = 57.1  on 5 df,   p=5e-11</code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-50_a0b65d33df3ed1008a15417f31817889">
<details><summary>Code</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">cox.zph</span><span class="op">(</span><span class="va">anderson.coxph.intxn</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>           chisq df    p
rx         0.136  1 0.71
logwbc     1.652  1 0.20
sex        1.266  1 0.26
rx:sex     0.149  1 0.70
logwbc:sex 0.102  1 0.75
GLOBAL     3.747  5 0.59</code></pre>
</div>
</div>
</section></section><section id="time-varying-covariates" class="level1" data-number="15"><h1 data-number="15">
<span class="header-section-number">15</span> Time-varying covariates</h1>
<p>(adapted from Klein and Moeschberger 2003, §9.2: https://link.springer.com/book/10.1007/b97377)</p>
<section id="motivating-example-back-to-the-leukemia-dataset" class="level2" data-number="15.1"><h2 data-number="15.1" class="anchored" data-anchor-id="motivating-example-back-to-the-leukemia-dataset">
<span class="header-section-number">15.1</span> Motivating example: back to the leukemia dataset</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-51_ac69ab0850c68e4fb51835a41d284ff0">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># load the data:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">bmt</span>, package <span class="op">=</span> <span class="st">'KMsurv'</span><span class="op">)</span></span>
<span><span class="va">bmt</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 137 × 22
  group    t1    t2    d1    d2    d3    ta    da    tc    dc    tp    dp    z1
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1     1  2081  2081     0     0     0    67     1   121     1    13     1    26
2     1  1602  1602     0     0     0  1602     0   139     1    18     1    21
3     1  1496  1496     0     0     0  1496     0   307     1    12     1    26
4     1  1462  1462     0     0     0    70     1    95     1    13     1    17
5     1  1433  1433     0     0     0  1433     0   236     1    12     1    32
# ℹ 132 more rows
# ℹ 9 more variables: z2 &lt;int&gt;, z3 &lt;int&gt;, z4 &lt;int&gt;, z5 &lt;int&gt;, z6 &lt;int&gt;,
#   z7 &lt;int&gt;, z8 &lt;int&gt;, z9 &lt;int&gt;, z10 &lt;int&gt;</code></pre>
</div>
</div>
<p>This dataset comes from the Copelan et al.&nbsp;(1991) study of allogenic bone marrow transplant therapy for acute myeloid leukemia (AML) and acute lymphoblastic leukemia (ALL).</p>
<section id="outcomes-endpoints" class="level4"><h4 class="anchored" data-anchor-id="outcomes-endpoints">Outcomes (endpoints)</h4>
<ul>
<li>The main endpoint is disease-free survival (<code>t2</code> and <code>d3</code>) for the three risk groups, “ALL”, “AML Low Risk”, and “AML High Risk”.</li>
</ul></section><section id="possible-intermediate-events" class="level4"><h4 class="anchored" data-anchor-id="possible-intermediate-events">Possible intermediate events</h4>
<ul>
<li>graft vs.&nbsp;host disease (<strong>GVHD</strong>), an immunological rejection response to the transplant (bad)</li>
<li>acute (<strong>AGVHD</strong>)</li>
<li>chronic (<strong>CGVHD</strong>)</li>
<li>platelet recovery, a return of platelet count to normal levels (good)</li>
</ul>
<p>One or the other, both in either order, or neither may occur.</p>
</section><section id="covariates" class="level4"><h4 class="anchored" data-anchor-id="covariates">Covariates</h4>
<ul>
<li><p>We are interested in possibly using the covariates <code>z1</code>-<code>z10</code> to adjust for other factors.</p></li>
<li><p>In addition, the time-varying covariates for acute GVHD, chronic GVHD, and platelet recovery may be useful.</p></li>
</ul></section><section id="preprocessing" class="level3"><h3 class="anchored" data-anchor-id="preprocessing">Preprocessing</h3>
<p>We add reformat the data before analysis:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-52_c4c6bc0fccad56a9b68f3644b3e71804">
<details><summary>Code</summary><div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># reformat the data:</span></span>
<span><span class="va">bmt1</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># will be used to connect multiple records for the same individual</span></span>
<span>    </span>
<span>    group <span class="op">=</span>  <span class="va">group</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"ALL"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Low Risk AML"</span>,</span>
<span>        <span class="fl">3</span> <span class="op">~</span> <span class="st">"High Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>, <span class="st">"Low Risk AML"</span>, <span class="st">"High Risk AML"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `patient age` <span class="op">=</span> <span class="va">z1</span>,</span>
<span>    </span>
<span>    `donor age` <span class="op">=</span> <span class="va">z2</span>,</span>
<span>    </span>
<span>    `patient sex` <span class="op">=</span> <span class="va">z3</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `donor sex` <span class="op">=</span> <span class="va">z4</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Patient CMV Status` <span class="op">=</span> <span class="va">z5</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"CMV Negative"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"CMV Positive"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Donor CMV Status` <span class="op">=</span> <span class="va">z6</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"CMV Negative"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"CMV Positive"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Waiting Time to Transplant` <span class="op">=</span> <span class="va">z7</span>,</span>
<span>    </span>
<span>    FAB <span class="op">=</span> <span class="va">z8</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Grade 4 Or 5 (AML only)"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Other"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    hospital <span class="op">=</span> <span class="va">z9</span> <span class="op">|&gt;</span>  <span class="co"># `z9` is hospital</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Ohio State University"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Alferd"</span>,</span>
<span>        <span class="fl">3</span> <span class="op">~</span> <span class="st">"St. Vincent"</span>,</span>
<span>        <span class="fl">4</span> <span class="op">~</span> <span class="st">"Hahnemann"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Ohio State University"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    MTX <span class="op">=</span> <span class="op">(</span><span class="va">z10</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># a prophylatic treatment for GVHD</span></span>
<span>    </span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">z1</span><span class="op">:</span><span class="va">z10</span><span class="op">)</span><span class="op">)</span> <span class="co"># don't need these anymore</span></span>
<span></span>
<span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">id</span><span class="op">:</span><span class="va">MTX</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 137 × 12
   group    id `patient age` `donor age` `patient sex` `donor sex`
   &lt;fct&gt; &lt;int&gt;         &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;      
 1 ALL       1            26          33 Male          Female     
 2 ALL       2            21          37 Male          Male       
 3 ALL       3            26          35 Male          Male       
 4 ALL       4            17          21 Female        Male       
 5 ALL       5            32          36 Male          Male       
 6 ALL       6            22          31 Male          Male       
 7 ALL       7            20          17 Male          Female     
 8 ALL       8            22          24 Male          Female     
 9 ALL       9            18          21 Female        Male       
10 ALL      10            24          40 Male          Male       
# ℹ 127 more rows
# ℹ 6 more variables: `Patient CMV Status` &lt;chr&gt;, `Donor CMV Status` &lt;chr&gt;,
#   `Waiting Time to Transplant` &lt;int&gt;, FAB &lt;fct&gt;, hospital &lt;fct&gt;, MTX &lt;lgl&gt;</code></pre>
</div>
</div>
</section></section><section id="time-dependent-covariates" class="level2" data-number="15.2"><h2 data-number="15.2" class="anchored" data-anchor-id="time-dependent-covariates">
<span class="header-section-number">15.2</span> Time-Dependent Covariates</h2>
<ul>
<li>A <strong>time-dependent covariate</strong> (“<strong>TDC</strong>”) is a covariate whose value changes during the course of the study.</li>
<li>For variables like age that change in a linear manner with time, we can just use the value at the start.</li>
<li>But it may be plausible that when and if GVHD occurs, the risk of relapse or death increases, and when and if platelet recovery occurs, the risk decreases.</li>
</ul></section><section id="analysis-in-r" class="level2" data-number="15.3"><h2 data-number="15.3" class="anchored" data-anchor-id="analysis-in-r">
<span class="header-section-number">15.3</span> Analysis in R</h2>
<ul>
<li>We form a variable <code>precovery</code> which is = 0 before platelet recovery and is = 1 after platelet recovery, if it occurs.</li>
<li>For each subject where platelet recovery occurs, we set up multiple records (lines in the data frame); for example one from t = 0 to the time of platelet recovery, and one from that time to relapse, recovery, or death.</li>
<li>We do the same for acute GVHD and chronic GVHD.</li>
<li>For each record, the covariates are constant.</li>
</ul>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-53_a2bc08cb629438ee7e2e67ac67f1026b">
<details><summary>Code</summary><div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt2</span> <span class="op">=</span> <span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#set up new long-format data set:</span></span>
<span>  <span class="fu">tmerge</span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, tstop <span class="op">=</span> <span class="va">t2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># the following three steps can be in any order, </span></span>
<span>  <span class="co"># and will still produce the same result:</span></span>
<span>  <span class="co">#add aghvd as tdc:</span></span>
<span>  <span class="fu">tmerge</span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, agvhd <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">ta</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#add cghvd as tdc:</span></span>
<span>  <span class="fu">tmerge</span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, cgvhd <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">tc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#add platelet recovery as tdc:</span></span>
<span>  <span class="fu">tmerge</span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, precovery <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span>   </span>
<span></span>
<span><span class="va">bmt2</span> <span class="op">=</span> <span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="va">tstop</span> <span class="op">==</span> <span class="va">t2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">d3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># status only = 1 if at end of t2 and not censored</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see how we’ve rearranged the first row of the data:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-54_eba32f74bc0e1693a2f8a44e6cddf945">
<details><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">t1</span>, <span class="va">d1</span>, <span class="va">t2</span>, <span class="va">d2</span>, <span class="va">d3</span>, <span class="va">ta</span>, <span class="va">da</span>, <span class="va">tc</span>, <span class="va">dc</span>, <span class="va">tp</span>, <span class="va">dp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
     id    t1    d1    t2    d2    d3    ta    da    tc    dc    tp    dp
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1     1  2081     0  2081     0     0    67     1   121     1    13     1</code></pre>
</div>
</div>
<p>The event times for this individual are:</p>
<ul>
<li>
<code>t</code> = 0 time of transplant</li>
<li>
<code>tp</code> = 13 platelet recovery</li>
<li>
<code>ta</code> = 67 acute GVHD onset</li>
<li>
<code>tc</code> = 121 chronic GVHD onset</li>
<li>
<code>t2</code> = 2081 end of study, patient not relapsed or dead</li>
</ul>
<p>After converting the data to long-format, we have:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-55_d8b58e39cb6081519a7e6b3074c30c95">
<details><summary>Code</summary><div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">id</span>,</span>
<span>    <span class="va">tstart</span>,</span>
<span>    <span class="va">tstop</span>,</span>
<span>    <span class="va">agvhd</span>,</span>
<span>    <span class="va">cgvhd</span>,</span>
<span>    <span class="va">precovery</span>,</span>
<span>    <span class="va">status</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
     id tstart tstop agvhd cgvhd precovery status
  &lt;int&gt;  &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;  &lt;dbl&gt;
1     1      0    13     0     0         0      0
2     1     13    67     0     0         1      0
3     1     67   121     1     0         1      0
4     1    121  2081     1     1         1      0</code></pre>
</div>
</div>
<p>Note that <code>status</code> could have been <code>1</code> on the last row, indicating that relapse or death occurred; since it is false, the participant must have exited the study without experiencing relapse or death (i.e., they were censored).</p>
</section><section id="event-sequences" class="level2" data-number="15.4"><h2 data-number="15.4" class="anchored" data-anchor-id="event-sequences">
<span class="header-section-number">15.4</span> Event sequences</h2>
<p>Let:</p>
<ul>
<li>A = acute GVHD</li>
<li>C = chronic GVHD</li>
<li>P = platelet recovery</li>
</ul>
<p>Each of the eight possible combinations of A or not-A, with C or not-C, with P or not-P occurs in this data set.</p>
<ul>
<li>A always occurs before C, and P always occurs before C, if both occur.</li>
<li>Thus there are ten event sequences in the data set: None, A, C, P, AC, AP, PA, PC, APC, and PAC.</li>
<li>In general, there could be as many as <span class="math inline">\(1+3+(3)(2)+6=16\)</span> sequences, but our domain knowledge tells us that some are missing: CA, CP, CAP, CPA, PCA, PC, PAC</li>
<li>Different subjects could have 1, 2, 3, or 4 intervals, depending on which of acute GVHD, chronic GVHD, and/or platelet recovery occurred.</li>
<li>The final interval for any subject has <code>status</code> = 1 if the subject relapsed or died at that time; otherwise <code>status</code> = 0.</li>
<li>Any earlier intervals have <code>status</code> = 0.</li>
<li>Even though there might be multiple lines per ID in the dataset, there is never more than one event, so no alterations need be made in the estimation procedures or in the interpretation of the output.</li>
<li>The function <code>tmerge</code> in the <code>survival</code> package eases the process of constructing the new long-format dataset.</li>
</ul></section><section id="model-with-time-fixed-covariates" class="level2" data-number="15.5"><h2 data-number="15.5" class="anchored" data-anchor-id="model-with-time-fixed-covariates">
<span class="header-section-number">15.5</span> Model with Time-Fixed Covariates</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-56_7bfd982fd704a2f287d3ba2a9a7366eb">
<details><summary>Code</summary><div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>surv <span class="op">=</span> <span class="fu">Surv</span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_coxph_TF</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">group</span> <span class="op">+</span> <span class="va">`patient age`</span><span class="op">*</span><span class="va">`donor age`</span> <span class="op">+</span> <span class="va">FAB</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt_coxph_TF</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ group + `patient age` * `donor age` + 
    FAB, data = bmt1)

  n= 137, number of events= 83 

                                coef exp(coef)  se(coef)     z Pr(&gt;|z|)    
groupLow Risk AML          -1.090648  0.335999  0.354279 -3.08  0.00208 ** 
groupHigh Risk AML         -0.403905  0.667707  0.362777 -1.11  0.26555    
`patient age`              -0.081639  0.921605  0.036107 -2.26  0.02376 *  
`donor age`                -0.084587  0.918892  0.030097 -2.81  0.00495 ** 
FABGrade 4 Or 5 (AML only)  0.837416  2.310388  0.278464  3.01  0.00264 ** 
`patient age`:`donor age`   0.003159  1.003164  0.000951  3.32  0.00089 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                           exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML              0.336      2.976     0.168     0.673
groupHigh Risk AML             0.668      1.498     0.328     1.360
`patient age`                  0.922      1.085     0.859     0.989
`donor age`                    0.919      1.088     0.866     0.975
FABGrade 4 Or 5 (AML only)     2.310      0.433     1.339     3.988
`patient age`:`donor age`      1.003      0.997     1.001     1.005

Concordance= 0.665  (se = 0.033 )
Likelihood ratio test= 32.8  on 6 df,   p=1e-05
Wald test            = 33  on 6 df,   p=1e-05
Score (logrank) test = 35.8  on 6 df,   p=3e-06</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span><span class="va">bmt_coxph_TF</span>, test <span class="op">=</span> <span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
surv ~ group + `patient age` * `donor age` + FAB
                          Df AIC   LRT Pr(&gt;Chi)   
&lt;none&gt;                       726                  
group                      2 734 12.51   0.0019 **
FAB                        1 733  9.22   0.0024 **
`patient age`:`donor age`  1 733  9.51   0.0020 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-57_50b893c19fceda627d7e1fe465d26313">
<details><summary>Code</summary><div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span><span class="op">$</span><span class="va">mres</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_coxph_TF</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">`donor age`</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">`donor age`</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Donor age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Martingale residuals for <code>Donor age</code></figcaption><p><img src="coxph-model-building_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A more complex functional form for <code>donor age</code> seems warranted; left as an exercise for the reader.</p>
<p>Now we will add the time-varying covariates:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-58_553993f5178b35e85af02ded5d09c9ae">
<details><summary>Code</summary><div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># add counting process formulation of Surv():</span></span>
<span><span class="va">bmt2</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> </span>
<span>      <span class="fu">Surv</span><span class="op">(</span></span>
<span>        time <span class="op">=</span> <span class="va">tstart</span>,</span>
<span>        time2 <span class="op">=</span> <span class="va">tstop</span>,</span>
<span>        event <span class="op">=</span> <span class="va">status</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"counting"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="model-with-time-dependent-covariates" class="level2" data-number="15.6"><h2 data-number="15.6" class="anchored" data-anchor-id="model-with-time-dependent-covariates">
<span class="header-section-number">15.6</span> Model with Time-Dependent Covariates</h2>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-59_8148936b6be2aef4c1247c7370b28afc">
<details><summary>Code</summary><div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_coxph_TV</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> </span>
<span>    <span class="va">surv</span> <span class="op">~</span> </span>
<span>    <span class="va">group</span> <span class="op">+</span> <span class="va">`patient age`</span><span class="op">*</span><span class="va">`donor age`</span> <span class="op">+</span> <span class="va">FAB</span> <span class="op">+</span> <span class="va">agvhd</span> <span class="op">+</span> <span class="va">cgvhd</span> <span class="op">+</span> <span class="va">precovery</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ group + `patient age` * `donor age` + 
    FAB + agvhd + cgvhd + precovery, data = bmt2)

  n= 341, number of events= 83 

                                coef exp(coef)  se(coef)     z Pr(&gt;|z|)   
groupLow Risk AML          -1.038514  0.353980  0.358220 -2.90   0.0037 **
groupHigh Risk AML         -0.380481  0.683533  0.374867 -1.01   0.3101   
`patient age`              -0.073351  0.929275  0.035956 -2.04   0.0413 * 
`donor age`                -0.076406  0.926440  0.030196 -2.53   0.0114 * 
FABGrade 4 Or 5 (AML only)  0.805700  2.238263  0.284273  2.83   0.0046 **
agvhd                       0.150565  1.162491  0.306848  0.49   0.6237   
cgvhd                      -0.116136  0.890354  0.289046 -0.40   0.6878   
precovery                  -0.941123  0.390190  0.347861 -2.71   0.0068 **
`patient age`:`donor age`   0.002895  1.002899  0.000944  3.07   0.0022 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                           exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML              0.354      2.825     0.175     0.714
groupHigh Risk AML             0.684      1.463     0.328     1.425
`patient age`                  0.929      1.076     0.866     0.997
`donor age`                    0.926      1.079     0.873     0.983
FABGrade 4 Or 5 (AML only)     2.238      0.447     1.282     3.907
agvhd                          1.162      0.860     0.637     2.121
cgvhd                          0.890      1.123     0.505     1.569
precovery                      0.390      2.563     0.197     0.772
`patient age`:`donor age`      1.003      0.997     1.001     1.005

Concordance= 0.702  (se = 0.028 )
Likelihood ratio test= 40.3  on 9 df,   p=7e-06
Wald test            = 42.4  on 9 df,   p=3e-06
Score (logrank) test = 47.2  on 9 df,   p=4e-07</code></pre>
</div>
</div>
<p>Platelet recovery is highly significant.</p>
<p>Neither acute GVHD (<code>agvhd</code>) nor chronic GVHD (<code>cgvhd</code>) has a statistically significant effect here, nor are they significant in models with the other one removed.</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-60_8a1bdca00401ca201bc6e6392910f6d1">
<details><summary>Code</summary><div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span><span class="op">~</span><span class="va">.</span><span class="op">-</span><span class="va">agvhd</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ group + `patient age` + `donor age` + 
    FAB + cgvhd + precovery + `patient age`:`donor age`, data = bmt2)

  n= 341, number of events= 83 

                                coef exp(coef)  se(coef)     z Pr(&gt;|z|)   
groupLow Risk AML          -1.049870  0.349983  0.356727 -2.94   0.0032 **
groupHigh Risk AML         -0.417049  0.658988  0.365348 -1.14   0.2537   
`patient age`              -0.070749  0.931696  0.035477 -1.99   0.0461 * 
`donor age`                -0.075693  0.927101  0.030075 -2.52   0.0118 * 
FABGrade 4 Or 5 (AML only)  0.807035  2.241253  0.283437  2.85   0.0044 **
cgvhd                      -0.095393  0.909015  0.285979 -0.33   0.7387   
precovery                  -0.983653  0.373942  0.338170 -2.91   0.0036 **
`patient age`:`donor age`   0.002859  1.002863  0.000936  3.05   0.0023 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                           exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML              0.350      2.857     0.174     0.704
groupHigh Risk AML             0.659      1.517     0.322     1.349
`patient age`                  0.932      1.073     0.869     0.999
`donor age`                    0.927      1.079     0.874     0.983
FABGrade 4 Or 5 (AML only)     2.241      0.446     1.286     3.906
cgvhd                          0.909      1.100     0.519     1.592
precovery                      0.374      2.674     0.193     0.726
`patient age`:`donor age`      1.003      0.997     1.001     1.005

Concordance= 0.701  (se = 0.027 )
Likelihood ratio test= 40  on 8 df,   p=3e-06
Wald test            = 42.4  on 8 df,   p=1e-06
Score (logrank) test = 47.2  on 8 df,   p=1e-07</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span><span class="op">~</span><span class="va">.</span><span class="op">-</span><span class="va">cgvhd</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ group + `patient age` + `donor age` + 
    FAB + agvhd + precovery + `patient age`:`donor age`, data = bmt2)

  n= 341, number of events= 83 

                                coef exp(coef)  se(coef)     z Pr(&gt;|z|)   
groupLow Risk AML          -1.019638  0.360725  0.355311 -2.87   0.0041 **
groupHigh Risk AML         -0.381356  0.682935  0.374568 -1.02   0.3086   
`patient age`              -0.073189  0.929426  0.035890 -2.04   0.0414 * 
`donor age`                -0.076753  0.926118  0.030121 -2.55   0.0108 * 
FABGrade 4 Or 5 (AML only)  0.811716  2.251769  0.284012  2.86   0.0043 **
agvhd                       0.131621  1.140676  0.302623  0.43   0.6636   
precovery                  -0.946697  0.388021  0.347265 -2.73   0.0064 **
`patient age`:`donor age`   0.002904  1.002908  0.000943  3.08   0.0021 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                           exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML              0.361      2.772     0.180     0.724
groupHigh Risk AML             0.683      1.464     0.328     1.423
`patient age`                  0.929      1.076     0.866     0.997
`donor age`                    0.926      1.080     0.873     0.982
FABGrade 4 Or 5 (AML only)     2.252      0.444     1.291     3.929
agvhd                          1.141      0.877     0.630     2.064
precovery                      0.388      2.577     0.196     0.766
`patient age`:`donor age`      1.003      0.997     1.001     1.005

Concordance= 0.701  (se = 0.027 )
Likelihood ratio test= 40.1  on 8 df,   p=3e-06
Wald test            = 42.1  on 8 df,   p=1e-06
Score (logrank) test = 47.1  on 8 df,   p=1e-07</code></pre>
</div>
</div>
<p>Let’s drop them both:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-61_8bb1ca531839de97225543b29b225b29">
<details><summary>Code</summary><div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_coxph_TV2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">agvhd</span> <span class="op">-</span><span class="va">cgvhd</span><span class="op">)</span></span>
<span><span class="va">bmt_coxph_TV2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ group + `patient age` + `donor age` + 
    FAB + precovery + `patient age`:`donor age`, data = bmt2)

  n= 341, number of events= 83 

                                coef exp(coef)  se(coef)     z Pr(&gt;|z|)   
groupLow Risk AML          -1.032520  0.356108  0.353202 -2.92   0.0035 **
groupHigh Risk AML         -0.413888  0.661075  0.365209 -1.13   0.2571   
`patient age`              -0.070965  0.931495  0.035453 -2.00   0.0453 * 
`donor age`                -0.076052  0.926768  0.030007 -2.53   0.0113 * 
FABGrade 4 Or 5 (AML only)  0.811926  2.252242  0.283231  2.87   0.0041 **
precovery                  -0.983505  0.373998  0.337997 -2.91   0.0036 **
`patient age`:`donor age`   0.002872  1.002876  0.000936  3.07   0.0021 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                           exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML              0.356      2.808     0.178     0.712
groupHigh Risk AML             0.661      1.513     0.323     1.352
`patient age`                  0.931      1.074     0.869     0.999
`donor age`                    0.927      1.079     0.874     0.983
FABGrade 4 Or 5 (AML only)     2.252      0.444     1.293     3.924
precovery                      0.374      2.674     0.193     0.725
`patient age`:`donor age`      1.003      0.997     1.001     1.005

Concordance= 0.7  (se = 0.027 )
Likelihood ratio test= 39.9  on 7 df,   p=1e-06
Wald test            = 42.2  on 7 df,   p=5e-07
Score (logrank) test = 47.1  on 7 df,   p=5e-08</code></pre>
</div>
</div>
</section></section><section id="recurrent-events" class="level1" data-number="16"><h1 data-number="16">
<span class="header-section-number">16</span> Recurrent Events</h1>
<p>(Adapted from Kleinbaum and Klein, Ch 8)</p>
<ul>
<li>Sometimes an appropriate analysis requires consideration of recurrent events.</li>
<li>A patient with arthritis may have more than one flareup. The same is true of many recurring-remitting diseases.</li>
<li>In this case, we have more than one line in the data frame, but each line may have an event.</li>
<li>We have to use a “robust” variance estimator to account for correlation of time-to-events within a patient.</li>
</ul>
<section id="bladder-cancer-data-set" class="level2" data-number="16.1"><h2 data-number="16.1" class="anchored" data-anchor-id="bladder-cancer-data-set">
<span class="header-section-number">16.1</span> Bladder Cancer Data Set</h2>
<p>The bladder cancer dataset from Kleinbaum and Klein contains recurrent event outcome information for eighty-six cancer patients followed for the recurrence of bladder cancer tumor after transurethral surgical excision (Byar and Green 1980). The exposure of interest is the effect of the drug treatment of thiotepa. Control variables are the initial number and initial size of tumors. The data layout is suitable for a counting processes approach.</p>
<p>This drug is still a possible choice for some patients. Another therapeutic choice is Bacillus Calmette-Guerin (BCG), a live bacterium related to cow tuberculosis.</p>
<section id="data-dictionary" class="level3"><h3 class="anchored" data-anchor-id="data-dictionary">Data dictionary</h3>
<table class="table">
<caption>Variables in the <code>bladder</code> dataset</caption>
<thead><tr class="header">
<th>Variable</th>
<th>Definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>Patient unique ID</td>
</tr>
<tr class="even">
<td><code>status</code></td>
<td>for each time interval: 1 = recurred, 0 = censored</td>
</tr>
<tr class="odd">
<td><code>interval</code></td>
<td>1 = first recurrence, etc.</td>
</tr>
<tr class="even">
<td><code>intime</code></td>
<td>`<code>tstop - tstart</code> (all times in months)</td>
</tr>
<tr class="odd">
<td><code>tstart</code></td>
<td>start of interval</td>
</tr>
<tr class="even">
<td><code>tstop</code></td>
<td>end of interval</td>
</tr>
<tr class="odd">
<td><code>tx</code></td>
<td>treatment code, 1 = thiotepa</td>
</tr>
<tr class="even">
<td><code>num</code></td>
<td>number of initial tumors</td>
</tr>
<tr class="odd">
<td><code>size</code></td>
<td>size of initial tumors (cm)</td>
</tr>
</tbody>
</table>
<ul>
<li>There are 85 patients and 190 lines in the dataset, meaning that many patients have more than one line.</li>
<li>Patient 1 with 0 observation time was removed.</li>
<li>Of the 85 patients, 47 had at least one recurrence and 38 had none.</li>
<li>18 patients had exactly one recurrence.</li>
<li>There were up to 4 recurrences in a patient.</li>
<li>Of the 190 intervals, 112 terminated with a recurrence and 78 were censored.</li>
</ul></section><section id="different-intervals-for-the-same-patient-are-correlated." class="level3"><h3 class="anchored" data-anchor-id="different-intervals-for-the-same-patient-are-correlated.">Different intervals for the same patient are correlated.</h3>
<ul>
<li><p>Is the effective sample size 47 or 112? This might narrow confidence intervals by as much as a factor of <span class="math inline">\(\sqrt{112/47}=1.54\)</span></p></li>
<li><p>What happens if I have 5 treatment and 5 control values and want to do a t-test and I then duplicate the 10 values as if the sample size was 20? This falsely narrows confidence intervals by a factor of <span class="math inline">\(\sqrt{2}=1.41\)</span>.</p></li>
</ul>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-62_2d3f05811e95965316df34f48f01140a">
<details><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bladder</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets"</span>,</span>
<span>    <span class="st">"/surv2datasets/bladder.dta"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bladder</span> <span class="op">=</span> <span class="va">bladder</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span>  <span class="co">#remove subject with 0 observation time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">bladder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 190 × 8
      id event interval start  stop    tx   num  size
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     2     0        1     0     1     0     1     3
 2     3     0        1     0     4     0     2     1
 3     4     0        1     0     7     0     1     1
 4     5     0        1     0    10     0     5     1
 5     6     1        1     0     6     0     4     1
 6     6     0        2     6    10     0     4     1
 7     7     0        1     0    14     0     1     1
 8     8     0        1     0    18     0     1     1
 9     9     1        1     0     5     0     1     3
10     9     0        2     5    18     0     1     3
# ℹ 180 more rows</code></pre>
</div>
</div>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-63_1068bdda8444bc3656959de65caf4eab">
<details><summary>Code</summary><div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bladder</span> <span class="op">=</span> </span>
<span>  <span class="va">bladder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> </span>
<span>      <span class="fu">Surv</span><span class="op">(</span></span>
<span>        time<span class="op">=</span><span class="va">start</span>,</span>
<span>        time2<span class="op">=</span><span class="va">stop</span>,</span>
<span>        event<span class="op">=</span><span class="va">event</span>,</span>
<span>        type<span class="op">=</span><span class="st">"counting"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bladder.cox1</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span><span class="op">~</span><span class="va">tx</span><span class="op">+</span><span class="va">num</span><span class="op">+</span><span class="va">size</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#results with biased variance-covariance matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ tx + num + size, data = bladder)

  n= 190, number of events= 112 

        coef exp(coef) se(coef)     z Pr(&gt;|z|)    
tx   -0.4116    0.6626   0.1999 -2.06  0.03947 *  
num   0.1637    1.1778   0.0478  3.43  0.00061 ***
size -0.0411    0.9598   0.0703 -0.58  0.55897    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
tx       0.663      1.509     0.448      0.98
num      1.178      0.849     1.073      1.29
size     0.960      1.042     0.836      1.10

Concordance= 0.624  (se = 0.032 )
Likelihood ratio test= 14.7  on 3 df,   p=0.002
Wald test            = 15.9  on 3 df,   p=0.001
Score (logrank) test = 16.2  on 3 df,   p=0.001</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The likelihood ratio and score tests assume independence of observations within a cluster. The Wald and robust score tests do not.</p>
</div>
</div>
</section><section id="adding-cluster-id" class="level3"><h3 class="anchored" data-anchor-id="adding-cluster-id">adding <code>cluster = id</code>
</h3>
<p>If we add <code>cluster= id</code> to the call to <code>coxph</code>, the coefficient estimates don’t change, but we get an additional column in the <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> output: <code>robust se</code>:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-64_24fd3451930a0bf86432ae349dec4e27">
<details><summary>Code</summary><div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bladder.cox2</span> <span class="op">=</span> <span class="fu">coxph</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">tx</span> <span class="op">+</span> <span class="va">num</span> <span class="op">+</span> <span class="va">size</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">id</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#unbiased though this reduces power:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ tx + num + size, data = bladder, cluster = id)

  n= 190, number of events= 112 

        coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   
tx   -0.4116    0.6626   0.1999    0.2488 -1.65   0.0980 . 
num   0.1637    1.1778   0.0478    0.0584  2.80   0.0051 **
size -0.0411    0.9598   0.0703    0.0742 -0.55   0.5799   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
tx       0.663      1.509     0.407      1.08
num      1.178      0.849     1.050      1.32
size     0.960      1.042     0.830      1.11

Concordance= 0.624  (se = 0.031 )
Likelihood ratio test= 14.7  on 3 df,   p=0.002
Wald test            = 11.2  on 3 df,   p=0.01
Score (logrank) test = 16.2  on 3 df,   p=0.001,   Robust = 10.8  p=0.01

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
<p><code>robust se</code> is larger than <code>se</code>, and accounts for the repeated observations from the same individuals:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-65_663482adfac3873f74790b76d96e5c7a">
<details><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">$</span><span class="va">naive.var</span>, <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]   [,3]
[1,]  0.0400 -0.0014 0.0000
[2,] -0.0014  0.0023 0.0007
[3,]  0.0000  0.0007 0.0049</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">$</span><span class="va">var</span>, <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]
[1,]  0.0619 -0.0026 -0.0004
[2,] -0.0026  0.0034  0.0013
[3,] -0.0004  0.0013  0.0055</code></pre>
</div>
</div>
<p>These are the ratios of correct confidence intervals to naive ones:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-66_12335c8c197116e18bbf2b4aae6e9583">
<details><summary>Code</summary><div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bladder.cox2</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">naive.var</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 1.244 1.223 1.056</code></pre>
</div>
</div>
<p>We might try dropping the non-significant <code>size</code> variable:</p>
<div class="cell" data-hash="coxph-model-building_cache/html/unnamed-chunk-67_760503915b5ea4378e31e31c5bbb7c2c">
<details><summary>Code</summary><div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#remove non-significant size variable:</span></span>
<span><span class="va">bladder.cox3</span> <span class="op">=</span> <span class="va">bladder.cox2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">size</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = surv ~ tx + num, data = bladder, cluster = id)

  n= 190, number of events= 112 

       coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   
tx  -0.4117    0.6625   0.2003    0.2515 -1.64   0.1017   
num  0.1700    1.1853   0.0465    0.0564  3.02   0.0026 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
tx      0.663      1.509     0.405      1.08
num     1.185      0.844     1.061      1.32

Concordance= 0.623  (se = 0.031 )
Likelihood ratio test= 14.3  on 2 df,   p=8e-04
Wald test            = 10.2  on 2 df,   p=0.006
Score (logrank) test = 15.8  on 2 df,   p=4e-04,   Robust = 10.6  p=0.005

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
<div class="hidden">
<p>Ways to check PH assumption:</p>
<ul>
<li>cloglog</li>
<li>schoenfeld residuals</li>
<li>interaction with time</li>
</ul>
</div>


<!-- -->

</section></section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>P. Grambsch and T. Therneau (1994), Proportional hazards tests and diagnostics based on weighted residuals. Biometrika, 81, 515-26.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./proportional-hazards-models.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./parametric-survival-models.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb113" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Building Cox Proportional Hazards models"</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="an">date-format:</span><span class="co"> "[Last modified:] YYYY-MM-DD: H:mm:ss (A)"</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="an">subject:</span><span class="co"> "EPI 204 Spring 2023"</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co">  revealjs:</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: dark</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="co">    smaller: false</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 2</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a><span class="co">    slide-number: true</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a><span class="co">    scrollable: true</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="co">    echo: true</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "[R code]"</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a><span class="co">    auto-stretch: false</span></span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a><span class="co">    # chalkboard: true</span></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a><span class="co">    # fig-width: 30</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a><span class="co">    # fig-height: 10</span></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a><span class="co">    # out-width: "100%"</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 2</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show the code"</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a><span class="co">  pdf:</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 3</span></span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span></span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span></span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown:</span></span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a><span class="co">    wrap: 72</span></span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>::: hidden</span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>\def\cd{\cdot}</span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>\def\eqdef{\stackrel{\text{def}}{=}}</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>\def\se{\text{SE}}</span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>\def\hse{\hat{\se}}</span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>\def\hb{\hat\beta}</span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>\def\za{z_{1 - \frac{\alpha}{2}}}</span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>\def\cirad{\za \cd \hse(\hb)}</span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>\def\ci{\hb {\color{red}\pm} \cirad}</span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>\newcommand{\hE}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\hat{\text{E}}\left<span class="co">[</span><span class="ot">#1\right</span><span class="co">]</span>}</span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>\newcommand{\E}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\text{E}\left<span class="co">[</span><span class="ot">#1\right</span><span class="co">]</span>}</span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>\newcommand{\var}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\text{Var}\left(#1\right)}</span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>\newcommand{\Var}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\text{Var}\left(#1\right)}</span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>\newcommand{\varh}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\hat{\text{Var}}\left(#1\right)}</span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>\newcommand{\vc}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\boldsymbol{#1}}</span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>::: {.content-hidden when-format="revealjs"}</span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Configuring R {.unnumbered}</span></span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>Functions from these packages will be used throughout this document:</span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r packages, message = FALSE}</span></span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pander) <span class="co"># format tables for markdown</span></span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># graphics</span></span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify) <span class="co"># help with graphics</span></span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggeasy) <span class="co"># help with graphics</span></span>
<span id="cb113-78"><a href="#cb113-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer) <span class="co"># survival analysis graphics</span></span>
<span id="cb113-79"><a href="#cb113-79" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># manipulate data</span></span>
<span id="cb113-80"><a href="#cb113-80" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven) <span class="co"># import Stata files</span></span>
<span id="cb113-81"><a href="#cb113-81" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co"># format R output for markdown</span></span>
<span id="cb113-82"><a href="#cb113-82" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># Tools to help to create tidy data</span></span>
<span id="cb113-83"><a href="#cb113-83" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly) <span class="co"># interactive graphics</span></span>
<span id="cb113-84"><a href="#cb113-84" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dobson) <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span id="cb113-85"><a href="#cb113-85" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs) <span class="co"># filesystem path manipulations</span></span>
<span id="cb113-86"><a href="#cb113-86" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv) <span class="co"># datasets from Klein and Moeschberger</span></span>
<span id="cb113-87"><a href="#cb113-87" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parameters) <span class="co"># format model output tables for markdown</span></span>
<span id="cb113-88"><a href="#cb113-88" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(conflicted) <span class="co"># check for conflicting function definitions</span></span>
<span id="cb113-89"><a href="#cb113-89" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb113-90"><a href="#cb113-90" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(ggplot2<span class="sc">::</span>autoplot)</span>
<span id="cb113-91"><a href="#cb113-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-92"><a href="#cb113-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-93"><a href="#cb113-93" aria-hidden="true" tabindex="-1"></a>Here are some R settings I use in this document:</span>
<span id="cb113-94"><a href="#cb113-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-95"><a href="#cb113-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{r options, message=FALSE}</span></span>
<span id="cb113-96"><a href="#cb113-96" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>()) <span class="co"># delete any data that's already loaded into R</span></span>
<span id="cb113-97"><a href="#cb113-97" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">message =</span> <span class="cn">FALSE</span>)</span>
<span id="cb113-98"><a href="#cb113-98" aria-hidden="true" tabindex="-1"></a>pander<span class="sc">::</span><span class="fu">panderOptions</span>(<span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span>)</span>
<span id="cb113-99"><a href="#cb113-99" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">'digits'</span> <span class="ot">=</span> <span class="dv">4</span>)</span>
<span id="cb113-100"><a href="#cb113-100" aria-hidden="true" tabindex="-1"></a>legend_text_size <span class="ot">=</span> <span class="dv">9</span></span>
<span id="cb113-101"><a href="#cb113-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-102"><a href="#cb113-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-103"><a href="#cb113-103" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-104"><a href="#cb113-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-105"><a href="#cb113-105" aria-hidden="true" tabindex="-1"></a><span class="fu"># Building Cox Proportional Hazards models</span></span>
<span id="cb113-106"><a href="#cb113-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-107"><a href="#cb113-107" aria-hidden="true" tabindex="-1"></a><span class="fu">## `hodg` Lymphoma Data Set from `KMsurv`</span></span>
<span id="cb113-108"><a href="#cb113-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-109"><a href="#cb113-109" aria-hidden="true" tabindex="-1"></a><span class="fu">### Participants</span></span>
<span id="cb113-110"><a href="#cb113-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-111"><a href="#cb113-111" aria-hidden="true" tabindex="-1"></a>43 bone marrow transplant patients at Ohio State University (Avalos</span>
<span id="cb113-112"><a href="#cb113-112" aria-hidden="true" tabindex="-1"></a>1993)</span>
<span id="cb113-113"><a href="#cb113-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-114"><a href="#cb113-114" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variables</span></span>
<span id="cb113-115"><a href="#cb113-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-116"><a href="#cb113-116" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`dtype`</span>: Disease type (Hodgkin's or non-Hodgkins lymphoma)</span>
<span id="cb113-117"><a href="#cb113-117" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`gtype`</span>: Bone marrow graft type:</span>
<span id="cb113-118"><a href="#cb113-118" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>allogeneic: from HLA-matched sibling</span>
<span id="cb113-119"><a href="#cb113-119" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>autologous: from self (prior to chemo)</span>
<span id="cb113-120"><a href="#cb113-120" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`time`</span>: time to study exit</span>
<span id="cb113-121"><a href="#cb113-121" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`delta`</span>: study exit reason (death/relapse vs censored)</span>
<span id="cb113-122"><a href="#cb113-122" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`wtime`</span>: waiting time to transplant (in months)</span>
<span id="cb113-123"><a href="#cb113-123" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`score`</span>: Karnofsky score:</span>
<span id="cb113-124"><a href="#cb113-124" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>80--100: Able to carry on normal activity and to work; no special</span>
<span id="cb113-125"><a href="#cb113-125" aria-hidden="true" tabindex="-1"></a>    care needed.</span>
<span id="cb113-126"><a href="#cb113-126" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>50--70: Unable to work; able to live at home and care for most</span>
<span id="cb113-127"><a href="#cb113-127" aria-hidden="true" tabindex="-1"></a>    personal needs; varying amount of assistance needed.</span>
<span id="cb113-128"><a href="#cb113-128" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>10--60: Unable to care for self; requires equivalent of</span>
<span id="cb113-129"><a href="#cb113-129" aria-hidden="true" tabindex="-1"></a>    institutional or hospital care; disease may be progressing rapidly.</span>
<span id="cb113-130"><a href="#cb113-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-131"><a href="#cb113-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data</span></span>
<span id="cb113-132"><a href="#cb113-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-135"><a href="#cb113-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-136"><a href="#cb113-136" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(hodg, <span class="at">package =</span> <span class="st">"KMsurv"</span>)</span>
<span id="cb113-137"><a href="#cb113-137" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="ot">=</span> hodg <span class="sc">|&gt;</span> </span>
<span id="cb113-138"><a href="#cb113-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-139"><a href="#cb113-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-140"><a href="#cb113-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We add factor labels to the categorical variables:</span></span>
<span id="cb113-141"><a href="#cb113-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">gtype =</span> gtype <span class="sc">|&gt;</span> </span>
<span id="cb113-142"><a href="#cb113-142" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-143"><a href="#cb113-143" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Allogenic"</span>,</span>
<span id="cb113-144"><a href="#cb113-144" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Autologous"</span>),</span>
<span id="cb113-145"><a href="#cb113-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtype =</span> dtype <span class="sc">|&gt;</span> </span>
<span id="cb113-146"><a href="#cb113-146" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-147"><a href="#cb113-147" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Non-Hodgkins"</span>,</span>
<span id="cb113-148"><a href="#cb113-148" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Hodgkins"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-149"><a href="#cb113-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-150"><a href="#cb113-150" aria-hidden="true" tabindex="-1"></a>      <span class="fu">relevel</span>(<span class="at">ref =</span> <span class="st">"Non-Hodgkins"</span>), </span>
<span id="cb113-151"><a href="#cb113-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta =</span> delta <span class="sc">|&gt;</span> </span>
<span id="cb113-152"><a href="#cb113-152" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-153"><a href="#cb113-153" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"dead"</span>,</span>
<span id="cb113-154"><a href="#cb113-154" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"alive"</span>),</span>
<span id="cb113-155"><a href="#cb113-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv =</span> <span class="fu">Surv</span>(</span>
<span id="cb113-156"><a href="#cb113-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">time =</span> time, </span>
<span id="cb113-157"><a href="#cb113-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">event =</span> delta <span class="sc">==</span> <span class="st">"dead"</span>)</span>
<span id="cb113-158"><a href="#cb113-158" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-159"><a href="#cb113-159" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="sc">|&gt;</span> <span class="fu">print</span>()</span>
<span id="cb113-160"><a href="#cb113-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-161"><a href="#cb113-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-162"><a href="#cb113-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-163"><a href="#cb113-163" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proportional hazards model</span></span>
<span id="cb113-164"><a href="#cb113-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-167"><a href="#cb113-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-168"><a href="#cb113-168" aria-hidden="true" tabindex="-1"></a>hodg.cox1 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-169"><a href="#cb113-169" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> gtype <span class="sc">*</span> dtype <span class="sc">+</span> score <span class="sc">+</span> wtime, </span>
<span id="cb113-170"><a href="#cb113-170" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> hodg2)</span>
<span id="cb113-171"><a href="#cb113-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-172"><a href="#cb113-172" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hodg.cox1)</span>
<span id="cb113-173"><a href="#cb113-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-174"><a href="#cb113-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-175"><a href="#cb113-175" aria-hidden="true" tabindex="-1"></a>::: content-hidden</span>
<span id="cb113-178"><a href="#cb113-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-179"><a href="#cb113-179" aria-hidden="true" tabindex="-1"></a><span class="do">## fancier alternatives:</span></span>
<span id="cb113-180"><a href="#cb113-180" aria-hidden="true" tabindex="-1"></a><span class="co"># library(parameters)</span></span>
<span id="cb113-181"><a href="#cb113-181" aria-hidden="true" tabindex="-1"></a><span class="co"># hodg.cox1 |&gt;  </span></span>
<span id="cb113-182"><a href="#cb113-182" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters() |&gt; </span></span>
<span id="cb113-183"><a href="#cb113-183" aria-hidden="true" tabindex="-1"></a><span class="co">#   print_md()</span></span>
<span id="cb113-184"><a href="#cb113-184" aria-hidden="true" tabindex="-1"></a><span class="co"># library(gtsummary)</span></span>
<span id="cb113-185"><a href="#cb113-185" aria-hidden="true" tabindex="-1"></a><span class="co"># hodg.cox1 |&gt; </span></span>
<span id="cb113-186"><a href="#cb113-186" aria-hidden="true" tabindex="-1"></a><span class="co">#   tbl_regression() |&gt; </span></span>
<span id="cb113-187"><a href="#cb113-187" aria-hidden="true" tabindex="-1"></a><span class="co">#   as_hux_table()</span></span>
<span id="cb113-188"><a href="#cb113-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-189"><a href="#cb113-189" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-190"><a href="#cb113-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-191"><a href="#cb113-191" aria-hidden="true" tabindex="-1"></a><span class="fu"># Diagnostic graphs for proportional hazards assumption</span></span>
<span id="cb113-192"><a href="#cb113-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-193"><a href="#cb113-193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis plan</span></span>
<span id="cb113-194"><a href="#cb113-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-195"><a href="#cb113-195" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**survival function** for the four combinations of disease type and</span>
<span id="cb113-196"><a href="#cb113-196" aria-hidden="true" tabindex="-1"></a>    graft type.</span>
<span id="cb113-197"><a href="#cb113-197" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**observed (nonparametric) vs. expected (semiparametric) survival**</span>
<span id="cb113-198"><a href="#cb113-198" aria-hidden="true" tabindex="-1"></a>    functions.</span>
<span id="cb113-199"><a href="#cb113-199" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**complementary log-log survival** for the four groups.</span>
<span id="cb113-200"><a href="#cb113-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-201"><a href="#cb113-201" aria-hidden="true" tabindex="-1"></a><span class="fu">## Kaplan-Meier survival functions</span></span>
<span id="cb113-202"><a href="#cb113-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-205"><a href="#cb113-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-206"><a href="#cb113-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Kaplan-Meier Survival Curves for HOD/NHL and Allo/Auto Grafts"</span></span>
<span id="cb113-207"><a href="#cb113-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-208"><a href="#cb113-208" aria-hidden="true" tabindex="-1"></a>km_model <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb113-209"><a href="#cb113-209" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> dtype <span class="sc">+</span> gtype,</span>
<span id="cb113-210"><a href="#cb113-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> hodg2)</span>
<span id="cb113-211"><a href="#cb113-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-212"><a href="#cb113-212" aria-hidden="true" tabindex="-1"></a>km_model <span class="sc">|&gt;</span> </span>
<span id="cb113-213"><a href="#cb113-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb113-214"><a href="#cb113-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb113-215"><a href="#cb113-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb113-216"><a href="#cb113-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb113-217"><a href="#cb113-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb113-218"><a href="#cb113-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> legend_text_size)</span>
<span id="cb113-219"><a href="#cb113-219" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb113-220"><a href="#cb113-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span><span class="fu">guide_legend</span>(<span class="at">ncol=</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb113-221"><a href="#cb113-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Survival probability, S(t)'</span>) <span class="sc">+</span></span>
<span id="cb113-222"><a href="#cb113-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since transplant (days)"</span>)</span>
<span id="cb113-223"><a href="#cb113-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-224"><a href="#cb113-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-225"><a href="#cb113-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-226"><a href="#cb113-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-227"><a href="#cb113-227" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observed and expected survival curves</span></span>
<span id="cb113-228"><a href="#cb113-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-231"><a href="#cb113-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-232"><a href="#cb113-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Observed and Expected Survival Curves"</span></span>
<span id="cb113-233"><a href="#cb113-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-234"><a href="#cb113-234" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a tibble of covariate patterns;</span></span>
<span id="cb113-235"><a href="#cb113-235" aria-hidden="true" tabindex="-1"></a><span class="co"># we will set score and wtime to mean values for disease and graft types:</span></span>
<span id="cb113-236"><a href="#cb113-236" aria-hidden="true" tabindex="-1"></a>means <span class="ot">=</span> hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-237"><a href="#cb113-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb113-238"><a href="#cb113-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(dtype, gtype), </span>
<span id="cb113-239"><a href="#cb113-239" aria-hidden="true" tabindex="-1"></a>    <span class="at">score =</span> <span class="fu">mean</span>(score), </span>
<span id="cb113-240"><a href="#cb113-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">wtime =</span> <span class="fu">mean</span>(wtime)) <span class="sc">|&gt;</span> </span>
<span id="cb113-241"><a href="#cb113-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(dtype, gtype) <span class="sc">|&gt;</span> </span>
<span id="cb113-242"><a href="#cb113-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">strata =</span> <span class="fu">paste</span>(dtype, gtype, <span class="at">sep =</span> <span class="st">","</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb113-243"><a href="#cb113-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() </span>
<span id="cb113-244"><a href="#cb113-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-245"><a href="#cb113-245" aria-hidden="true" tabindex="-1"></a><span class="co"># survfit.coxph() will use the rownames of its `newdata`</span></span>
<span id="cb113-246"><a href="#cb113-246" aria-hidden="true" tabindex="-1"></a><span class="co"># argument to label its output:</span></span>
<span id="cb113-247"><a href="#cb113-247" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(means) <span class="ot">=</span> means<span class="sc">$</span>strata</span>
<span id="cb113-248"><a href="#cb113-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-249"><a href="#cb113-249" aria-hidden="true" tabindex="-1"></a>cox_model <span class="ot">=</span> </span>
<span id="cb113-250"><a href="#cb113-250" aria-hidden="true" tabindex="-1"></a>  hodg.cox1 <span class="sc">|&gt;</span> </span>
<span id="cb113-251"><a href="#cb113-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit</span>(</span>
<span id="cb113-252"><a href="#cb113-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> hodg2, <span class="co"># ggsurvplot() will need this</span></span>
<span id="cb113-253"><a href="#cb113-253" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> means)</span>
<span id="cb113-254"><a href="#cb113-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-255"><a href="#cb113-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-256"><a href="#cb113-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-259"><a href="#cb113-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-260"><a href="#cb113-260" aria-hidden="true" tabindex="-1"></a><span class="co"># I couldn't find a good function to reformat `cox_model` for ggplot, </span></span>
<span id="cb113-261"><a href="#cb113-261" aria-hidden="true" tabindex="-1"></a><span class="co"># so I made my own:</span></span>
<span id="cb113-262"><a href="#cb113-262" aria-hidden="true" tabindex="-1"></a>stack_surv_ph <span class="ot">=</span> <span class="cf">function</span>(cox_model)</span>
<span id="cb113-263"><a href="#cb113-263" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb113-264"><a href="#cb113-264" aria-hidden="true" tabindex="-1"></a>  cox_model<span class="sc">$</span>surv <span class="sc">|&gt;</span> </span>
<span id="cb113-265"><a href="#cb113-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-266"><a href="#cb113-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">time =</span> cox_model<span class="sc">$</span>time) <span class="sc">|&gt;</span> </span>
<span id="cb113-267"><a href="#cb113-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb113-268"><a href="#cb113-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> <span class="sc">-</span>time,</span>
<span id="cb113-269"><a href="#cb113-269" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"strata"</span>,</span>
<span id="cb113-270"><a href="#cb113-270" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">"surv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-271"><a href="#cb113-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb113-272"><a href="#cb113-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">cumhaz =</span> <span class="sc">-</span><span class="fu">log</span>(surv),</span>
<span id="cb113-273"><a href="#cb113-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="st">"Cox PH"</span>)</span>
<span id="cb113-274"><a href="#cb113-274" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb113-275"><a href="#cb113-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-276"><a href="#cb113-276" aria-hidden="true" tabindex="-1"></a>km_and_cph <span class="ot">=</span></span>
<span id="cb113-277"><a href="#cb113-277" aria-hidden="true" tabindex="-1"></a>  km_model <span class="sc">|&gt;</span> </span>
<span id="cb113-278"><a href="#cb113-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fortify</span>(<span class="at">surv.connect =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-279"><a href="#cb113-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-280"><a href="#cb113-280" aria-hidden="true" tabindex="-1"></a>    <span class="at">strata =</span> <span class="fu">trimws</span>(strata),</span>
<span id="cb113-281"><a href="#cb113-281" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"Kaplan-Meier"</span>,</span>
<span id="cb113-282"><a href="#cb113-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz =</span> <span class="sc">-</span><span class="fu">log</span>(surv)) <span class="sc">|&gt;</span></span>
<span id="cb113-283"><a href="#cb113-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">stack_surv_ph</span>(cox_model))</span>
<span id="cb113-284"><a href="#cb113-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-285"><a href="#cb113-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-286"><a href="#cb113-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-289"><a href="#cb113-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-290"><a href="#cb113-290" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Observed and expected survival curves for `bmt` data"</span></span>
<span id="cb113-291"><a href="#cb113-291" aria-hidden="true" tabindex="-1"></a>km_and_cph <span class="sc">|&gt;</span> </span>
<span id="cb113-292"><a href="#cb113-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">col =</span> model)) <span class="sc">+</span></span>
<span id="cb113-293"><a href="#cb113-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb113-294"><a href="#cb113-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>strata) <span class="sc">+</span></span>
<span id="cb113-295"><a href="#cb113-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb113-296"><a href="#cb113-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"S(t) = P(T&gt;=t)"</span>) <span class="sc">+</span></span>
<span id="cb113-297"><a href="#cb113-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Survival time (t, days)"</span>) <span class="sc">+</span></span>
<span id="cb113-298"><a href="#cb113-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb113-299"><a href="#cb113-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-300"><a href="#cb113-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-301"><a href="#cb113-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-302"><a href="#cb113-302" aria-hidden="true" tabindex="-1"></a>::: content-hidden</span>
<span id="cb113-305"><a href="#cb113-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-306"><a href="#cb113-306" aria-hidden="true" tabindex="-1"></a><span class="co"># these are some old-style R plots inherited from Prof. Rocke's notes; </span></span>
<span id="cb113-307"><a href="#cb113-307" aria-hidden="true" tabindex="-1"></a><span class="co"># they should be updated to ggplot2-style plots eventually:</span></span>
<span id="cb113-308"><a href="#cb113-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-309"><a href="#cb113-309" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mai =</span> <span class="fu">rep</span>(<span class="fl">0.5</span>, <span class="dv">4</span>)) <span class="co"># set up a multipanel panel</span></span>
<span id="cb113-310"><a href="#cb113-310" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_model[<span class="dv">1</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">600</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="at">lwd=</span><span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb113-311"><a href="#cb113-311" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"NHL Allogeneic"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb113-312"><a href="#cb113-312" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(cox_model[<span class="dv">1</span>],<span class="at">lwd=</span> <span class="dv">2</span>,<span class="at">lty=</span><span class="dv">2</span>, <span class="at">col =</span> <span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>)</span>
<span id="cb113-313"><a href="#cb113-313" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"K-M"</span>, <span class="st">"Cox PH"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="at">lwd=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb113-314"><a href="#cb113-314" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_model[<span class="dv">2</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">600</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="at">lwd=</span><span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb113-315"><a href="#cb113-315" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"NHL Autologous"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb113-316"><a href="#cb113-316" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(cox_model[<span class="dv">2</span>],<span class="at">lwd=</span> <span class="dv">2</span>,<span class="at">lty=</span><span class="dv">2</span>, <span class="at">col =</span> <span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>)</span>
<span id="cb113-317"><a href="#cb113-317" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km_model[<span class="dv">3</span>],<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">600</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="at">lwd=</span><span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb113-318"><a href="#cb113-318" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"HL Allogeneic"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb113-319"><a href="#cb113-319" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(cox_model[<span class="dv">3</span>],<span class="at">lwd=</span> <span class="dv">2</span>,<span class="at">lty=</span><span class="dv">2</span>, <span class="at">col =</span> <span class="dv">2</span>, <span class="at">conf.int =</span> <span class="cn">FALSE</span>)</span>
<span id="cb113-320"><a href="#cb113-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-321"><a href="#cb113-321" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb113-322"><a href="#cb113-322" aria-hidden="true" tabindex="-1"></a>  km_model[<span class="dv">4</span>],</span>
<span id="cb113-323"><a href="#cb113-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">600</span>),</span>
<span id="cb113-324"><a href="#cb113-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb113-325"><a href="#cb113-325" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">2</span>, </span>
<span id="cb113-326"><a href="#cb113-326" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb113-327"><a href="#cb113-327" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"HL Autologous"</span>, </span>
<span id="cb113-328"><a href="#cb113-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb113-329"><a href="#cb113-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-330"><a href="#cb113-330" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb113-331"><a href="#cb113-331" aria-hidden="true" tabindex="-1"></a>  cox_model[<span class="dv">4</span>],</span>
<span id="cb113-332"><a href="#cb113-332" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span> <span class="dv">2</span>,</span>
<span id="cb113-333"><a href="#cb113-333" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty=</span><span class="dv">2</span>, </span>
<span id="cb113-334"><a href="#cb113-334" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="dv">2</span>, </span>
<span id="cb113-335"><a href="#cb113-335" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>)</span>
<span id="cb113-336"><a href="#cb113-336" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)) <span class="co"># reset the paneling</span></span>
<span id="cb113-337"><a href="#cb113-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-338"><a href="#cb113-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-341"><a href="#cb113-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-342"><a href="#cb113-342" aria-hidden="true" tabindex="-1"></a>temp1 <span class="ot">=</span> </span>
<span id="cb113-343"><a href="#cb113-343" aria-hidden="true" tabindex="-1"></a>  km_model <span class="sc">|&gt;</span></span>
<span id="cb113-344"><a href="#cb113-344" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb113-345"><a href="#cb113-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb113-346"><a href="#cb113-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb113-347"><a href="#cb113-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine =</span> <span class="cn">TRUE</span>, </span>
<span id="cb113-348"><a href="#cb113-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'pct'</span>, </span>
<span id="cb113-349"><a href="#cb113-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb113-350"><a href="#cb113-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), </span>
<span id="cb113-351"><a href="#cb113-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb113-352"><a href="#cb113-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-353"><a href="#cb113-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>() <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span>
<span id="cb113-354"><a href="#cb113-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-355"><a href="#cb113-355" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">=</span> </span>
<span id="cb113-356"><a href="#cb113-356" aria-hidden="true" tabindex="-1"></a>  cox_model <span class="sc">|&gt;</span></span>
<span id="cb113-357"><a href="#cb113-357" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb113-358"><a href="#cb113-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb113-359"><a href="#cb113-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb113-360"><a href="#cb113-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine =</span> <span class="cn">TRUE</span>, </span>
<span id="cb113-361"><a href="#cb113-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'pct'</span>, </span>
<span id="cb113-362"><a href="#cb113-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb113-363"><a href="#cb113-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), </span>
<span id="cb113-364"><a href="#cb113-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb113-365"><a href="#cb113-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-366"><a href="#cb113-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>()</span>
<span id="cb113-367"><a href="#cb113-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-368"><a href="#cb113-368" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">=</span> </span>
<span id="cb113-369"><a href="#cb113-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">KM =</span> km_model,</span>
<span id="cb113-370"><a href="#cb113-370" aria-hidden="true" tabindex="-1"></a>       <span class="at">Cox =</span> cox_model) <span class="sc">|&gt;</span></span>
<span id="cb113-371"><a href="#cb113-371" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb113-372"><a href="#cb113-372" aria-hidden="true" tabindex="-1"></a>    <span class="co"># facet.by = gtype,</span></span>
<span id="cb113-373"><a href="#cb113-373" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb113-374"><a href="#cb113-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb113-375"><a href="#cb113-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine =</span> <span class="cn">TRUE</span>, </span>
<span id="cb113-376"><a href="#cb113-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'pct'</span>, </span>
<span id="cb113-377"><a href="#cb113-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb113-378"><a href="#cb113-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), </span>
<span id="cb113-379"><a href="#cb113-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb113-380"><a href="#cb113-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-381"><a href="#cb113-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>() <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span>
<span id="cb113-382"><a href="#cb113-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-383"><a href="#cb113-383" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-384"><a href="#cb113-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-385"><a href="#cb113-385" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cumulative hazard (log-scale) curves</span></span>
<span id="cb113-386"><a href="#cb113-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-387"><a href="#cb113-387" aria-hidden="true" tabindex="-1"></a>Also known as "complementary log-log (clog-log) survival curves".</span>
<span id="cb113-388"><a href="#cb113-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-391"><a href="#cb113-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-392"><a href="#cb113-392" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Complementary log-log survival curves - Nelson-Aalen estimates"</span></span>
<span id="cb113-393"><a href="#cb113-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-394"><a href="#cb113-394" aria-hidden="true" tabindex="-1"></a>na_model <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb113-395"><a href="#cb113-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> dtype <span class="sc">+</span> gtype,</span>
<span id="cb113-396"><a href="#cb113-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> hodg2,</span>
<span id="cb113-397"><a href="#cb113-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"fleming"</span>)</span>
<span id="cb113-398"><a href="#cb113-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-399"><a href="#cb113-399" aria-hidden="true" tabindex="-1"></a>na_model <span class="sc">|&gt;</span> survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb113-400"><a href="#cb113-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb113-401"><a href="#cb113-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb113-402"><a href="#cb113-402" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span id="cb113-403"><a href="#cb113-403" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span id="cb113-404"><a href="#cb113-404" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> <span class="st">'cloglog'</span>, </span>
<span id="cb113-405"><a href="#cb113-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb113-406"><a href="#cb113-406" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(),</span>
<span id="cb113-407"><a href="#cb113-407" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb113-408"><a href="#cb113-408" aria-hidden="true" tabindex="-1"></a>  <span class="at">censor =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb113-409"><a href="#cb113-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb113-410"><a href="#cb113-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> </span>
<span id="cb113-411"><a href="#cb113-411" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guide_legend</span>(</span>
<span id="cb113-412"><a href="#cb113-412" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb113-413"><a href="#cb113-413" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.theme =</span> </span>
<span id="cb113-414"><a href="#cb113-414" aria-hidden="true" tabindex="-1"></a>          <span class="fu">element_text</span>(</span>
<span id="cb113-415"><a href="#cb113-415" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> legend_text_size)))</span>
<span id="cb113-416"><a href="#cb113-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-417"><a href="#cb113-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-418"><a href="#cb113-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-419"><a href="#cb113-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-420"><a href="#cb113-420" aria-hidden="true" tabindex="-1"></a>Let's compare these empirical (i.e., non-parametric) curves with the</span>
<span id="cb113-421"><a href="#cb113-421" aria-hidden="true" tabindex="-1"></a>fitted curves from our <span class="in">`coxph()`</span> model:</span>
<span id="cb113-422"><a href="#cb113-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-425"><a href="#cb113-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-426"><a href="#cb113-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Complementary log-log survival curves - PH estimates"</span></span>
<span id="cb113-427"><a href="#cb113-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-428"><a href="#cb113-428" aria-hidden="true" tabindex="-1"></a>cox_model <span class="sc">|&gt;</span> </span>
<span id="cb113-429"><a href="#cb113-429" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb113-430"><a href="#cb113-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet_by =</span> <span class="st">""</span>,</span>
<span id="cb113-431"><a href="#cb113-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb113-432"><a href="#cb113-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb113-433"><a href="#cb113-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span id="cb113-434"><a href="#cb113-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span id="cb113-435"><a href="#cb113-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'cloglog'</span>, </span>
<span id="cb113-436"><a href="#cb113-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb113-437"><a href="#cb113-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(),</span>
<span id="cb113-438"><a href="#cb113-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>, <span class="co"># doesn't make sense for cox model</span></span>
<span id="cb113-439"><a href="#cb113-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb113-440"><a href="#cb113-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb113-441"><a href="#cb113-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> </span>
<span id="cb113-442"><a href="#cb113-442" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guide_legend</span>(</span>
<span id="cb113-443"><a href="#cb113-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb113-444"><a href="#cb113-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.theme =</span> </span>
<span id="cb113-445"><a href="#cb113-445" aria-hidden="true" tabindex="-1"></a>          <span class="fu">element_text</span>(</span>
<span id="cb113-446"><a href="#cb113-446" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> legend_text_size)))</span>
<span id="cb113-447"><a href="#cb113-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-448"><a href="#cb113-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-449"><a href="#cb113-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-450"><a href="#cb113-450" aria-hidden="true" tabindex="-1"></a>Now let's overlay these cumulative hazard curves:</span>
<span id="cb113-451"><a href="#cb113-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-454"><a href="#cb113-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-455"><a href="#cb113-455" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Observed and expected cumulative hazard curves for `bmt` data (cloglog format)"</span></span>
<span id="cb113-456"><a href="#cb113-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-457"><a href="#cb113-457" aria-hidden="true" tabindex="-1"></a>na_and_cph <span class="ot">=</span> </span>
<span id="cb113-458"><a href="#cb113-458" aria-hidden="true" tabindex="-1"></a>  na_model <span class="sc">|&gt;</span> </span>
<span id="cb113-459"><a href="#cb113-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fortify</span>(<span class="at">fun =</span> <span class="st">"cumhaz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-460"><a href="#cb113-460" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `fortify.survfit()` doesn't name cumhaz correctly:</span></span>
<span id="cb113-461"><a href="#cb113-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">cumhaz =</span> surv) <span class="sc">|&gt;</span>  </span>
<span id="cb113-462"><a href="#cb113-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-463"><a href="#cb113-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv =</span> <span class="fu">exp</span>(<span class="sc">-</span>cumhaz),</span>
<span id="cb113-464"><a href="#cb113-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">strata =</span> <span class="fu">trimws</span>(strata)) <span class="sc">|&gt;</span> </span>
<span id="cb113-465"><a href="#cb113-465" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Nelson-Aalen"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-466"><a href="#cb113-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">stack_surv_ph</span>(cox_model))</span>
<span id="cb113-467"><a href="#cb113-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-468"><a href="#cb113-468" aria-hidden="true" tabindex="-1"></a>na_and_cph <span class="sc">|&gt;</span> </span>
<span id="cb113-469"><a href="#cb113-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb113-470"><a href="#cb113-470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb113-471"><a href="#cb113-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> time, </span>
<span id="cb113-472"><a href="#cb113-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> cumhaz, </span>
<span id="cb113-473"><a href="#cb113-473" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> model)) <span class="sc">+</span></span>
<span id="cb113-474"><a href="#cb113-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb113-475"><a href="#cb113-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>strata) <span class="sc">+</span></span>
<span id="cb113-476"><a href="#cb113-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb113-477"><a href="#cb113-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb113-478"><a href="#cb113-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log10"</span>,</span>
<span id="cb113-479"><a href="#cb113-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Cumulative hazard H(t) (log-scale)"</span>) <span class="sc">+</span></span>
<span id="cb113-480"><a href="#cb113-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb113-481"><a href="#cb113-481" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log10"</span>,</span>
<span id="cb113-482"><a href="#cb113-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Survival time (t, days, log-scale)"</span>) <span class="sc">+</span></span>
<span id="cb113-483"><a href="#cb113-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb113-484"><a href="#cb113-484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-485"><a href="#cb113-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-486"><a href="#cb113-486" aria-hidden="true" tabindex="-1"></a><span class="fu"># Predictions and Residuals</span></span>
<span id="cb113-487"><a href="#cb113-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-488"><a href="#cb113-488" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review: Predictions in Linear Regression</span></span>
<span id="cb113-489"><a href="#cb113-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-490"><a href="#cb113-490" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In linear regression, we have a linear predictor for each data point</span>
<span id="cb113-491"><a href="#cb113-491" aria-hidden="true" tabindex="-1"></a>    $i$</span>
<span id="cb113-492"><a href="#cb113-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-493"><a href="#cb113-493" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-494"><a href="#cb113-494" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb113-495"><a href="#cb113-495" aria-hidden="true" tabindex="-1"></a>\eta_i &amp;= \beta_0+\beta_1x_{1i}+\cdots+\beta_px_{pi}<span class="sc">\\</span></span>
<span id="cb113-496"><a href="#cb113-496" aria-hidden="true" tabindex="-1"></a>\hat y_i &amp;=\hat\eta_i = \hat\beta_0+\hat\beta_1x_{1i}+\cdots+\hat\beta_px_{pi}<span class="sc">\\</span></span>
<span id="cb113-497"><a href="#cb113-497" aria-hidden="true" tabindex="-1"></a>y_i &amp;\sim N(\eta_i,\sigma^2)</span>
<span id="cb113-498"><a href="#cb113-498" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb113-499"><a href="#cb113-499" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-500"><a href="#cb113-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-501"><a href="#cb113-501" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\hat y_i$ estimates the conditional mean of $y_i$ given the</span>
<span id="cb113-502"><a href="#cb113-502" aria-hidden="true" tabindex="-1"></a>    covariate values $\tilde x_i$. This together with the prediction</span>
<span id="cb113-503"><a href="#cb113-503" aria-hidden="true" tabindex="-1"></a>    error says that we are predicting the distribution of values of $y$.</span>
<span id="cb113-504"><a href="#cb113-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-505"><a href="#cb113-505" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review: Residuals in Linear Regression</span></span>
<span id="cb113-506"><a href="#cb113-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-507"><a href="#cb113-507" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The usual residual is $r_i=y_i-\hat y_i$, the difference between the</span>
<span id="cb113-508"><a href="#cb113-508" aria-hidden="true" tabindex="-1"></a>    actual value of $y$ and a prediction of its mean.</span>
<span id="cb113-509"><a href="#cb113-509" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The residuals are also the quantities the sum of whose squares is</span>
<span id="cb113-510"><a href="#cb113-510" aria-hidden="true" tabindex="-1"></a>    being minimized by the least squares/MLE estimation.</span>
<span id="cb113-511"><a href="#cb113-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-512"><a href="#cb113-512" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predictions and Residuals in survival models</span></span>
<span id="cb113-513"><a href="#cb113-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-514"><a href="#cb113-514" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In survival analysis, the equivalent of $y_i$ is the event time</span>
<span id="cb113-515"><a href="#cb113-515" aria-hidden="true" tabindex="-1"></a>    $t_i$, which is unknown for the censored observations.</span>
<span id="cb113-516"><a href="#cb113-516" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The expected event time can be tricky to calculate:</span>
<span id="cb113-517"><a href="#cb113-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-518"><a href="#cb113-518" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-519"><a href="#cb113-519" aria-hidden="true" tabindex="-1"></a>\hat{\text{E}}<span class="co">[</span><span class="ot">T|X=x</span><span class="co">]</span> = \int_{t=0}^{\infty} \hat S(t)dt</span>
<span id="cb113-520"><a href="#cb113-520" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-521"><a href="#cb113-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-522"><a href="#cb113-522" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wide prediction intervals</span></span>
<span id="cb113-523"><a href="#cb113-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-524"><a href="#cb113-524" aria-hidden="true" tabindex="-1"></a>The nature of time-to-event data results in very wide prediction</span>
<span id="cb113-525"><a href="#cb113-525" aria-hidden="true" tabindex="-1"></a>intervals:</span>
<span id="cb113-526"><a href="#cb113-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-527"><a href="#cb113-527" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Suppose a cancer patient is predicted to have a mean lifetime of 5</span>
<span id="cb113-528"><a href="#cb113-528" aria-hidden="true" tabindex="-1"></a>    years after diagnosis and suppose the distribution is exponential.</span>
<span id="cb113-529"><a href="#cb113-529" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>If we want a 95% interval for survival, the lower end is at the</span>
<span id="cb113-530"><a href="#cb113-530" aria-hidden="true" tabindex="-1"></a>    0.025 percentage point of the exponential which is</span>
<span id="cb113-531"><a href="#cb113-531" aria-hidden="true" tabindex="-1"></a>    <span class="in">`qexp(.025, rate = 1/5)`</span> = <span class="in">`r qexp(.025, rate = 1/5)`</span> years, or 1/40</span>
<span id="cb113-532"><a href="#cb113-532" aria-hidden="true" tabindex="-1"></a>    of the mean lifetime.</span>
<span id="cb113-533"><a href="#cb113-533" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The upper end is at the 0.975 point which is</span>
<span id="cb113-534"><a href="#cb113-534" aria-hidden="true" tabindex="-1"></a>    <span class="in">`qexp(.975, rate = 1/5)`</span> = <span class="in">`r qexp(.975, rate = 1/5)`</span> years, or 3.7</span>
<span id="cb113-535"><a href="#cb113-535" aria-hidden="true" tabindex="-1"></a>    times the mean lifetime.</span>
<span id="cb113-536"><a href="#cb113-536" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Saying that the survival time is somewhere between 6 weeks and 18</span>
<span id="cb113-537"><a href="#cb113-537" aria-hidden="true" tabindex="-1"></a>    years does not seem very useful, but it may be the best we can do.</span>
<span id="cb113-538"><a href="#cb113-538" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For survival analysis, something is like a residual if it is small</span>
<span id="cb113-539"><a href="#cb113-539" aria-hidden="true" tabindex="-1"></a>    when the model is accurate or if the accumulation of them is in some</span>
<span id="cb113-540"><a href="#cb113-540" aria-hidden="true" tabindex="-1"></a>    way minimized by the estimation algorithm, but there is no exact</span>
<span id="cb113-541"><a href="#cb113-541" aria-hidden="true" tabindex="-1"></a>    equivalence to linear regression residuals.</span>
<span id="cb113-542"><a href="#cb113-542" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>And if there is, they are mostly quite large!</span>
<span id="cb113-543"><a href="#cb113-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-544"><a href="#cb113-544" aria-hidden="true" tabindex="-1"></a><span class="fu">## Types of Residuals in Time-to-Event Models</span></span>
<span id="cb113-545"><a href="#cb113-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-546"><a href="#cb113-546" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>It is often hard to make a decision from graph appearances, though</span>
<span id="cb113-547"><a href="#cb113-547" aria-hidden="true" tabindex="-1"></a>    the process can reveal much.</span>
<span id="cb113-548"><a href="#cb113-548" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Some diagnostic tests are based on residuals as with other</span>
<span id="cb113-549"><a href="#cb113-549" aria-hidden="true" tabindex="-1"></a>    regression methods:</span>
<span id="cb113-550"><a href="#cb113-550" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Schoenfeld residuals** (via <span class="in">`cox.zph`</span>) for proportionality.</span>
<span id="cb113-551"><a href="#cb113-551" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Cox-Snell residuals** for goodness of fit.</span>
<span id="cb113-552"><a href="#cb113-552" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**martingale residuals** for non-linearity.</span>
<span id="cb113-553"><a href="#cb113-553" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**dfbeta** for influence.</span>
<span id="cb113-554"><a href="#cb113-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-555"><a href="#cb113-555" aria-hidden="true" tabindex="-1"></a>::: content-hidden</span>
<span id="cb113-556"><a href="#cb113-556" aria-hidden="true" tabindex="-1"></a><span class="fu">## Martingale and deviance residuals</span></span>
<span id="cb113-557"><a href="#cb113-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-558"><a href="#cb113-558" aria-hidden="true" tabindex="-1"></a>For martingale and deviance residuals, the returned object is a vector</span>
<span id="cb113-559"><a href="#cb113-559" aria-hidden="true" tabindex="-1"></a>with one element for each subject (without collapse). Even censored</span>
<span id="cb113-560"><a href="#cb113-560" aria-hidden="true" tabindex="-1"></a>observations have a martingale residual and a deviance residual. Each</span>
<span id="cb113-561"><a href="#cb113-561" aria-hidden="true" tabindex="-1"></a>subject's value for the martingale residual and the deviance residual is</span>
<span id="cb113-562"><a href="#cb113-562" aria-hidden="true" tabindex="-1"></a>a single value.</span>
<span id="cb113-563"><a href="#cb113-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-564"><a href="#cb113-564" aria-hidden="true" tabindex="-1"></a><span class="fu">## Score residuals</span></span>
<span id="cb113-565"><a href="#cb113-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-566"><a href="#cb113-566" aria-hidden="true" tabindex="-1"></a>Each observation also has a score residual, though this is a vector, not</span>
<span id="cb113-567"><a href="#cb113-567" aria-hidden="true" tabindex="-1"></a>a scalar.</span>
<span id="cb113-568"><a href="#cb113-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-569"><a href="#cb113-569" aria-hidden="true" tabindex="-1"></a>For score residuals the returned object is a matrix with one row per</span>
<span id="cb113-570"><a href="#cb113-570" aria-hidden="true" tabindex="-1"></a>subject and one column per variable. The row order will match the input</span>
<span id="cb113-571"><a href="#cb113-571" aria-hidden="true" tabindex="-1"></a>data for the original fit.</span>
<span id="cb113-572"><a href="#cb113-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-573"><a href="#cb113-573" aria-hidden="true" tabindex="-1"></a>The score residuals are each individual's contribution to the score</span>
<span id="cb113-574"><a href="#cb113-574" aria-hidden="true" tabindex="-1"></a>vector: $\ell'(\beta;y_i)$</span>
<span id="cb113-575"><a href="#cb113-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-576"><a href="#cb113-576" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For Schoenfeld residuals, the returned object is a matrix with one</span>
<span id="cb113-577"><a href="#cb113-577" aria-hidden="true" tabindex="-1"></a>    row for each event and one column per variable.</span>
<span id="cb113-578"><a href="#cb113-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-579"><a href="#cb113-579" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The rows are ordered by time within strata, and an attribute</span>
<span id="cb113-580"><a href="#cb113-580" aria-hidden="true" tabindex="-1"></a>    **strata** is attached that contains the number of observations in</span>
<span id="cb113-581"><a href="#cb113-581" aria-hidden="true" tabindex="-1"></a>    each stratum.</span>
<span id="cb113-582"><a href="#cb113-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-583"><a href="#cb113-583" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The scaled Schoenfeld residuals are used in the <span class="in">`cox.zph()`</span></span>
<span id="cb113-584"><a href="#cb113-584" aria-hidden="true" tabindex="-1"></a>    function.</span>
<span id="cb113-585"><a href="#cb113-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-586"><a href="#cb113-586" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Only subjects with an observed event time have a Schoenfeld</span>
<span id="cb113-587"><a href="#cb113-587" aria-hidden="true" tabindex="-1"></a>    residual, which like the score residual is a vector.</span>
<span id="cb113-588"><a href="#cb113-588" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-589"><a href="#cb113-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-590"><a href="#cb113-590" aria-hidden="true" tabindex="-1"></a><span class="fu">## Schoenfeld residuals</span></span>
<span id="cb113-591"><a href="#cb113-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-592"><a href="#cb113-592" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>There is a Schoenfeld residual for each subject $i$ with an event</span>
<span id="cb113-593"><a href="#cb113-593" aria-hidden="true" tabindex="-1"></a>    (not censored) and for each predictor $x_{k}$.</span>
<span id="cb113-594"><a href="#cb113-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-595"><a href="#cb113-595" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>At the event time $t$ for that subject, there is a risk set $R$, and</span>
<span id="cb113-596"><a href="#cb113-596" aria-hidden="true" tabindex="-1"></a>    each subject $j$ in the risk set has a risk coefficient $\theta_j$</span>
<span id="cb113-597"><a href="#cb113-597" aria-hidden="true" tabindex="-1"></a>    and also a value $x_{jk}$ of the predictor.</span>
<span id="cb113-598"><a href="#cb113-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-599"><a href="#cb113-599" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The Schoenfeld residual is the difference between $x_{ik}$ and the</span>
<span id="cb113-600"><a href="#cb113-600" aria-hidden="true" tabindex="-1"></a>    risk-weighted average of all the $x_{jk}$ over the risk set.</span>
<span id="cb113-601"><a href="#cb113-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-602"><a href="#cb113-602" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-603"><a href="#cb113-603" aria-hidden="true" tabindex="-1"></a>r^S_{ik} = </span>
<span id="cb113-604"><a href="#cb113-604" aria-hidden="true" tabindex="-1"></a>x_{ik}-\frac{\sum_{k\in R}x_{jk}\theta_k}{\sum_{k\in R}\theta_k}</span>
<span id="cb113-605"><a href="#cb113-605" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-606"><a href="#cb113-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-607"><a href="#cb113-607" aria-hidden="true" tabindex="-1"></a>This residual measures how typical the individual subject is with</span>
<span id="cb113-608"><a href="#cb113-608" aria-hidden="true" tabindex="-1"></a>respect to the covariate at the time of the event. Since subjects should</span>
<span id="cb113-609"><a href="#cb113-609" aria-hidden="true" tabindex="-1"></a>fail more or less uniformly according to risk, the Schoenfeld residuals</span>
<span id="cb113-610"><a href="#cb113-610" aria-hidden="true" tabindex="-1"></a>should be approximately level over time, not increasing or decreasing.</span>
<span id="cb113-611"><a href="#cb113-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-612"><a href="#cb113-612" aria-hidden="true" tabindex="-1"></a>We can test this with the correlation with time on some scale, which</span>
<span id="cb113-613"><a href="#cb113-613" aria-hidden="true" tabindex="-1"></a>could be the time itself, the log time, or the rank in the set of</span>
<span id="cb113-614"><a href="#cb113-614" aria-hidden="true" tabindex="-1"></a>failure times.</span>
<span id="cb113-615"><a href="#cb113-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-616"><a href="#cb113-616" aria-hidden="true" tabindex="-1"></a>The default is to use the KM curve as a transform, which is similar to</span>
<span id="cb113-617"><a href="#cb113-617" aria-hidden="true" tabindex="-1"></a>the rank but deals better with censoring.</span>
<span id="cb113-618"><a href="#cb113-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-619"><a href="#cb113-619" aria-hidden="true" tabindex="-1"></a>The <span class="in">`cox.zph()`</span> function implements a score test proposed by Grambsch</span>
<span id="cb113-620"><a href="#cb113-620" aria-hidden="true" tabindex="-1"></a>and Therneau<span class="ot">[^coxph-model-building-1]</span>:</span>
<span id="cb113-621"><a href="#cb113-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-622"><a href="#cb113-622" aria-hidden="true" tabindex="-1"></a><span class="ot">[^coxph-model-building-1]: </span>P. Grambsch and T. Therneau (1994),</span>
<span id="cb113-623"><a href="#cb113-623" aria-hidden="true" tabindex="-1"></a>    Proportional hazards tests and diagnostics based on weighted</span>
<span id="cb113-624"><a href="#cb113-624" aria-hidden="true" tabindex="-1"></a>    residuals. Biometrika, 81, 515-26.</span>
<span id="cb113-625"><a href="#cb113-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-628"><a href="#cb113-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-629"><a href="#cb113-629" aria-hidden="true" tabindex="-1"></a>hodg.zph <span class="ot">=</span> <span class="fu">cox.zph</span>(hodg.cox1)</span>
<span id="cb113-630"><a href="#cb113-630" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hodg.zph)</span>
<span id="cb113-631"><a href="#cb113-631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-632"><a href="#cb113-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-633"><a href="#cb113-633" aria-hidden="true" tabindex="-1"></a><span class="fu">### `gtype`</span></span>
<span id="cb113-634"><a href="#cb113-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-637"><a href="#cb113-637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-638"><a href="#cb113-638" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(hodg.zph, <span class="at">var =</span> <span class="st">"gtype"</span>)</span>
<span id="cb113-639"><a href="#cb113-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-640"><a href="#cb113-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-641"><a href="#cb113-641" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dtype`</span></span>
<span id="cb113-642"><a href="#cb113-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-645"><a href="#cb113-645" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-646"><a href="#cb113-646" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(hodg.zph, <span class="at">var =</span> <span class="st">"dtype"</span>)</span>
<span id="cb113-647"><a href="#cb113-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-648"><a href="#cb113-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-649"><a href="#cb113-649" aria-hidden="true" tabindex="-1"></a><span class="fu">### `score`</span></span>
<span id="cb113-650"><a href="#cb113-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-653"><a href="#cb113-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-654"><a href="#cb113-654" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(hodg.zph, <span class="at">var =</span> <span class="st">"score"</span>)</span>
<span id="cb113-655"><a href="#cb113-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-656"><a href="#cb113-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-657"><a href="#cb113-657" aria-hidden="true" tabindex="-1"></a><span class="fu">### `wtime`</span></span>
<span id="cb113-658"><a href="#cb113-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-661"><a href="#cb113-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-662"><a href="#cb113-662" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(hodg.zph, <span class="at">var =</span> <span class="st">"wtime"</span>)</span>
<span id="cb113-663"><a href="#cb113-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-664"><a href="#cb113-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-665"><a href="#cb113-665" aria-hidden="true" tabindex="-1"></a><span class="fu">### `gtype:dtype`</span></span>
<span id="cb113-666"><a href="#cb113-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-669"><a href="#cb113-669" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-670"><a href="#cb113-670" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(hodg.zph, <span class="at">var =</span> <span class="st">"gtype:dtype"</span>)</span>
<span id="cb113-671"><a href="#cb113-671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-672"><a href="#cb113-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-673"><a href="#cb113-673" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conclusions</span></span>
<span id="cb113-674"><a href="#cb113-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-675"><a href="#cb113-675" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>From the correlation test, the Karnofsky score and the interaction</span>
<span id="cb113-676"><a href="#cb113-676" aria-hidden="true" tabindex="-1"></a>    with graft type disease type induce modest but statistically</span>
<span id="cb113-677"><a href="#cb113-677" aria-hidden="true" tabindex="-1"></a>    significant non-proportionality.</span>
<span id="cb113-678"><a href="#cb113-678" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The sample size here is relatively small (26 events in 43 subjects).</span>
<span id="cb113-679"><a href="#cb113-679" aria-hidden="true" tabindex="-1"></a>    If the sample size is large, very small amounts of</span>
<span id="cb113-680"><a href="#cb113-680" aria-hidden="true" tabindex="-1"></a>    non-proportionality can induce a significant result.</span>
<span id="cb113-681"><a href="#cb113-681" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>As time goes on, autologous grafts are over-represented at their own</span>
<span id="cb113-682"><a href="#cb113-682" aria-hidden="true" tabindex="-1"></a>    event times, but those from HOD patients become less represented.</span>
<span id="cb113-683"><a href="#cb113-683" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Both the statistical tests and the plots are useful.</span>
<span id="cb113-684"><a href="#cb113-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-685"><a href="#cb113-685" aria-hidden="true" tabindex="-1"></a><span class="fu"># Goodness of Fit using the Cox-Snell Residuals</span></span>
<span id="cb113-686"><a href="#cb113-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-687"><a href="#cb113-687" aria-hidden="true" tabindex="-1"></a>(references: Klein &amp; Moeschberger textbook, §11.2, and Dobson &amp; Barnett</span>
<span id="cb113-688"><a href="#cb113-688" aria-hidden="true" tabindex="-1"></a>textbook, §10.6)</span>
<span id="cb113-689"><a href="#cb113-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-690"><a href="#cb113-690" aria-hidden="true" tabindex="-1"></a>Suppose that an individual has a survival time $T$ which has survival</span>
<span id="cb113-691"><a href="#cb113-691" aria-hidden="true" tabindex="-1"></a>function $S(t)$, meaning that $\Pr(T&gt; t) = S(t)$. Then $S(T)$ has a</span>
<span id="cb113-692"><a href="#cb113-692" aria-hidden="true" tabindex="-1"></a>uniform distribution on $(0,1)$.</span>
<span id="cb113-693"><a href="#cb113-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-694"><a href="#cb113-694" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-695"><a href="#cb113-695" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb113-696"><a href="#cb113-696" aria-hidden="true" tabindex="-1"></a>\Pr(S(T_i) \le u)</span>
<span id="cb113-697"><a href="#cb113-697" aria-hidden="true" tabindex="-1"></a>&amp;= \Pr(T_i &gt; S_i^{-1}(u))<span class="sc">\\</span></span>
<span id="cb113-698"><a href="#cb113-698" aria-hidden="true" tabindex="-1"></a>&amp;= S_i(S_i^{-1}(u))<span class="sc">\\</span></span>
<span id="cb113-699"><a href="#cb113-699" aria-hidden="true" tabindex="-1"></a>&amp;= u</span>
<span id="cb113-700"><a href="#cb113-700" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb113-701"><a href="#cb113-701" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-702"><a href="#cb113-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-703"><a href="#cb113-703" aria-hidden="true" tabindex="-1"></a>Also, if $U$ has a uniform distribution on $(0,1)$, then what is the</span>
<span id="cb113-704"><a href="#cb113-704" aria-hidden="true" tabindex="-1"></a>distribution of $-\ln(U)$?</span>
<span id="cb113-705"><a href="#cb113-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-706"><a href="#cb113-706" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-707"><a href="#cb113-707" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb113-708"><a href="#cb113-708" aria-hidden="true" tabindex="-1"></a>\Pr(-\ln(U) &lt; x) &amp;= \Pr(U&gt;\exp(-x))<span class="sc">\\</span></span>
<span id="cb113-709"><a href="#cb113-709" aria-hidden="true" tabindex="-1"></a>&amp;= 1-e^{-x} </span>
<span id="cb113-710"><a href="#cb113-710" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb113-711"><a href="#cb113-711" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-712"><a href="#cb113-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-713"><a href="#cb113-713" aria-hidden="true" tabindex="-1"></a>which is the CDF of an exponential distribution with parameter</span>
<span id="cb113-714"><a href="#cb113-714" aria-hidden="true" tabindex="-1"></a>$\lambda=1$.</span>
<span id="cb113-715"><a href="#cb113-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-716"><a href="#cb113-716" aria-hidden="true" tabindex="-1"></a>So,</span>
<span id="cb113-717"><a href="#cb113-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-718"><a href="#cb113-718" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-719"><a href="#cb113-719" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb113-720"><a href="#cb113-720" aria-hidden="true" tabindex="-1"></a>r^{CS}_i&amp;</span>
<span id="cb113-721"><a href="#cb113-721" aria-hidden="true" tabindex="-1"></a>\stackrel{\text{def}}{=}-\ln<span class="co">[</span><span class="ot">\hat S(t_i|x_i)</span><span class="co">]</span> </span>
<span id="cb113-722"><a href="#cb113-722" aria-hidden="true" tabindex="-1"></a>= \hat H(t_i|\tilde x_i)</span>
<span id="cb113-723"><a href="#cb113-723" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb113-724"><a href="#cb113-724" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-725"><a href="#cb113-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-726"><a href="#cb113-726" aria-hidden="true" tabindex="-1"></a>should have an exponential distribution with constant hazard $\lambda=1$</span>
<span id="cb113-727"><a href="#cb113-727" aria-hidden="true" tabindex="-1"></a>if the estimate $\hat S_i$ is accurate, which means that these values</span>
<span id="cb113-728"><a href="#cb113-728" aria-hidden="true" tabindex="-1"></a>should look like a censored sample from this exponential distribution.</span>
<span id="cb113-729"><a href="#cb113-729" aria-hidden="true" tabindex="-1"></a>These values are called **generalized residuals** or **Cox-Snell</span>
<span id="cb113-730"><a href="#cb113-730" aria-hidden="true" tabindex="-1"></a>residuals**.</span>
<span id="cb113-731"><a href="#cb113-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-734"><a href="#cb113-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-735"><a href="#cb113-735" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative Hazard of Cox-Snell Residuals"</span></span>
<span id="cb113-736"><a href="#cb113-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-737"><a href="#cb113-737" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="ot">=</span> hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-738"><a href="#cb113-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cs =</span> <span class="fu">predict</span>(hodg.cox1, <span class="at">type =</span> <span class="st">"expected"</span>))</span>
<span id="cb113-739"><a href="#cb113-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-740"><a href="#cb113-740" aria-hidden="true" tabindex="-1"></a>surv.csr <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb113-741"><a href="#cb113-741" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> hodg2,</span>
<span id="cb113-742"><a href="#cb113-742" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> <span class="fu">Surv</span>(<span class="at">time =</span> cs, <span class="at">event =</span> delta <span class="sc">==</span> <span class="st">"dead"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb113-743"><a href="#cb113-743" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"fleming-harrington"</span>)</span>
<span id="cb113-744"><a href="#cb113-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-745"><a href="#cb113-745" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(surv.csr, <span class="at">fun =</span> <span class="st">"cumhaz"</span>) <span class="sc">+</span> </span>
<span id="cb113-746"><a href="#cb113-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>), <span class="at">col =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb113-747"><a href="#cb113-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb113-748"><a href="#cb113-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-749"><a href="#cb113-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-750"><a href="#cb113-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-751"><a href="#cb113-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-752"><a href="#cb113-752" aria-hidden="true" tabindex="-1"></a>The line with slope 1 and intercept 0 fits the curve relatively well, so</span>
<span id="cb113-753"><a href="#cb113-753" aria-hidden="true" tabindex="-1"></a>we don't see lack of fit using this procedure.</span>
<span id="cb113-754"><a href="#cb113-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-755"><a href="#cb113-755" aria-hidden="true" tabindex="-1"></a><span class="fu"># Martingale Residuals</span></span>
<span id="cb113-756"><a href="#cb113-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-757"><a href="#cb113-757" aria-hidden="true" tabindex="-1"></a>The **martingale residuals** are a slight modification of the Cox-Snell</span>
<span id="cb113-758"><a href="#cb113-758" aria-hidden="true" tabindex="-1"></a>residuals. If the censoring indicator is $\delta_i$, then</span>
<span id="cb113-759"><a href="#cb113-759" aria-hidden="true" tabindex="-1"></a>$$r^M_i=\delta_i-r^{CS}_i$$ These residuals can be interpreted as an</span>
<span id="cb113-760"><a href="#cb113-760" aria-hidden="true" tabindex="-1"></a>estimate of the excess number of events seen in the data but not</span>
<span id="cb113-761"><a href="#cb113-761" aria-hidden="true" tabindex="-1"></a>predicted by the model. We will use these to examine the functional</span>
<span id="cb113-762"><a href="#cb113-762" aria-hidden="true" tabindex="-1"></a>forms of continuous covariates.</span>
<span id="cb113-763"><a href="#cb113-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-764"><a href="#cb113-764" aria-hidden="true" tabindex="-1"></a>::: content-hidden</span>
<span id="cb113-765"><a href="#cb113-765" aria-hidden="true" tabindex="-1"></a><span class="fu">## Martingale</span></span>
<span id="cb113-766"><a href="#cb113-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-767"><a href="#cb113-767" aria-hidden="true" tabindex="-1"></a>Originally, a martingale referred to a betting strategy where you bet</span>
<span id="cb113-768"><a href="#cb113-768" aria-hidden="true" tabindex="-1"></a>\$1 on the first play, then you double the bet if you lose and continue</span>
<span id="cb113-769"><a href="#cb113-769" aria-hidden="true" tabindex="-1"></a>until you win. This seems like a sure thing, because at the end of each</span>
<span id="cb113-770"><a href="#cb113-770" aria-hidden="true" tabindex="-1"></a>series when you finally win, you are up \$1. For example,</span>
<span id="cb113-771"><a href="#cb113-771" aria-hidden="true" tabindex="-1"></a>$-1-2-4-8+16=1$. But this assumes that you have infinite resources.</span>
<span id="cb113-772"><a href="#cb113-772" aria-hidden="true" tabindex="-1"></a>Really, you have a large probability of winning \$1, and a small</span>
<span id="cb113-773"><a href="#cb113-773" aria-hidden="true" tabindex="-1"></a>probability of losing everything you have, kind of the opposite of a</span>
<span id="cb113-774"><a href="#cb113-774" aria-hidden="true" tabindex="-1"></a>lottery.</span>
<span id="cb113-775"><a href="#cb113-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-776"><a href="#cb113-776" aria-hidden="true" tabindex="-1"></a>martingale</span>
<span id="cb113-777"><a href="#cb113-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-778"><a href="#cb113-778" aria-hidden="true" tabindex="-1"></a>:   In probability, a **martingale** is a sequence of random variables</span>
<span id="cb113-779"><a href="#cb113-779" aria-hidden="true" tabindex="-1"></a>    such that the expected value of the next event at any time is the</span>
<span id="cb113-780"><a href="#cb113-780" aria-hidden="true" tabindex="-1"></a>    present observed value, and that no better predictor can be derived</span>
<span id="cb113-781"><a href="#cb113-781" aria-hidden="true" tabindex="-1"></a>    even with all past values of the series available. At least to a</span>
<span id="cb113-782"><a href="#cb113-782" aria-hidden="true" tabindex="-1"></a>    close approximation, the stock market is a martingale. Under the</span>
<span id="cb113-783"><a href="#cb113-783" aria-hidden="true" tabindex="-1"></a>    assumptions of the proportional hazards model, the martingale</span>
<span id="cb113-784"><a href="#cb113-784" aria-hidden="true" tabindex="-1"></a>    residuals ordered in time form a martingale.</span>
<span id="cb113-785"><a href="#cb113-785" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-786"><a href="#cb113-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-787"><a href="#cb113-787" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using Martingale Residuals</span></span>
<span id="cb113-788"><a href="#cb113-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-789"><a href="#cb113-789" aria-hidden="true" tabindex="-1"></a>Martingale residuals can be used to examine the functional form of a</span>
<span id="cb113-790"><a href="#cb113-790" aria-hidden="true" tabindex="-1"></a>numeric variable.</span>
<span id="cb113-791"><a href="#cb113-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-792"><a href="#cb113-792" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We fit the model without that variable and compute the martingale</span>
<span id="cb113-793"><a href="#cb113-793" aria-hidden="true" tabindex="-1"></a>    residuals.</span>
<span id="cb113-794"><a href="#cb113-794" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We then plot these martingale residuals against the values of the</span>
<span id="cb113-795"><a href="#cb113-795" aria-hidden="true" tabindex="-1"></a>    variable.</span>
<span id="cb113-796"><a href="#cb113-796" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We can see curvature, or a possible suggestion that the variable can</span>
<span id="cb113-797"><a href="#cb113-797" aria-hidden="true" tabindex="-1"></a>    be discretized.</span>
<span id="cb113-798"><a href="#cb113-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-799"><a href="#cb113-799" aria-hidden="true" tabindex="-1"></a>Let's use this to examine the <span class="in">`score`</span> and <span class="in">`wtime`</span> variables in the</span>
<span id="cb113-800"><a href="#cb113-800" aria-hidden="true" tabindex="-1"></a><span class="in">`wtime`</span> data set.</span>
<span id="cb113-801"><a href="#cb113-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-802"><a href="#cb113-802" aria-hidden="true" tabindex="-1"></a><span class="fu">### Karnofsky score {.unnumbered}</span></span>
<span id="cb113-803"><a href="#cb113-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-806"><a href="#cb113-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-807"><a href="#cb113-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Martingale Residuals vs. Karnofsky Score"</span></span>
<span id="cb113-808"><a href="#cb113-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-809"><a href="#cb113-809" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="ot">=</span> hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-810"><a href="#cb113-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-811"><a href="#cb113-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">mres =</span> </span>
<span id="cb113-812"><a href="#cb113-812" aria-hidden="true" tabindex="-1"></a>      hodg.cox1 <span class="sc">|&gt;</span> </span>
<span id="cb113-813"><a href="#cb113-813" aria-hidden="true" tabindex="-1"></a>      <span class="fu">update</span>(. <span class="sc">~</span> . <span class="sc">-</span> score) <span class="sc">|&gt;</span> </span>
<span id="cb113-814"><a href="#cb113-814" aria-hidden="true" tabindex="-1"></a>      <span class="fu">residuals</span>(<span class="at">type=</span><span class="st">"martingale"</span>))</span>
<span id="cb113-815"><a href="#cb113-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-816"><a href="#cb113-816" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-817"><a href="#cb113-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> score, <span class="at">y =</span> mres)) <span class="sc">+</span></span>
<span id="cb113-818"><a href="#cb113-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb113-819"><a href="#cb113-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"loess"</span>)) <span class="sc">+</span></span>
<span id="cb113-820"><a href="#cb113-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"lm"</span>)) <span class="sc">+</span></span>
<span id="cb113-821"><a href="#cb113-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb113-822"><a href="#cb113-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Karnofsky Score"</span>) <span class="sc">+</span></span>
<span id="cb113-823"><a href="#cb113-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Martingale Residuals"</span>) <span class="sc">+</span></span>
<span id="cb113-824"><a href="#cb113-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span><span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>))</span>
<span id="cb113-825"><a href="#cb113-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-826"><a href="#cb113-826" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-827"><a href="#cb113-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-828"><a href="#cb113-828" aria-hidden="true" tabindex="-1"></a>The line is almost straight. It could be some modest transformation of</span>
<span id="cb113-829"><a href="#cb113-829" aria-hidden="true" tabindex="-1"></a>the Karnofsky score would help, but it might not make much difference.</span>
<span id="cb113-830"><a href="#cb113-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-831"><a href="#cb113-831" aria-hidden="true" tabindex="-1"></a><span class="fu">### Waiting time {.unnumbered}</span></span>
<span id="cb113-832"><a href="#cb113-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-835"><a href="#cb113-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-836"><a href="#cb113-836" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Martingale Residuals vs. Waiting Time"</span></span>
<span id="cb113-837"><a href="#cb113-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-838"><a href="#cb113-838" aria-hidden="true" tabindex="-1"></a>hodg2<span class="sc">$</span>mres <span class="ot">=</span> </span>
<span id="cb113-839"><a href="#cb113-839" aria-hidden="true" tabindex="-1"></a>  hodg.cox1 <span class="sc">|&gt;</span> </span>
<span id="cb113-840"><a href="#cb113-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(. <span class="sc">~</span> . <span class="sc">-</span> wtime) <span class="sc">|&gt;</span> </span>
<span id="cb113-841"><a href="#cb113-841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">residuals</span>(<span class="at">type=</span><span class="st">"martingale"</span>)</span>
<span id="cb113-842"><a href="#cb113-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-843"><a href="#cb113-843" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-844"><a href="#cb113-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> wtime, <span class="at">y =</span> mres)) <span class="sc">+</span></span>
<span id="cb113-845"><a href="#cb113-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb113-846"><a href="#cb113-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"loess"</span>)) <span class="sc">+</span></span>
<span id="cb113-847"><a href="#cb113-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"lm"</span>)) <span class="sc">+</span></span>
<span id="cb113-848"><a href="#cb113-848" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb113-849"><a href="#cb113-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Waiting Time"</span>) <span class="sc">+</span></span>
<span id="cb113-850"><a href="#cb113-850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Martingale Residuals"</span>) <span class="sc">+</span></span>
<span id="cb113-851"><a href="#cb113-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span><span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>))</span>
<span id="cb113-852"><a href="#cb113-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-853"><a href="#cb113-853" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-854"><a href="#cb113-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-855"><a href="#cb113-855" aria-hidden="true" tabindex="-1"></a>The line could suggest a step function. To see where the drop is, we can</span>
<span id="cb113-856"><a href="#cb113-856" aria-hidden="true" tabindex="-1"></a>look at the largest waiting times and the associated martingale</span>
<span id="cb113-857"><a href="#cb113-857" aria-hidden="true" tabindex="-1"></a>residual.</span>
<span id="cb113-858"><a href="#cb113-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-859"><a href="#cb113-859" aria-hidden="true" tabindex="-1"></a>The martingale residuals are all negative for <span class="in">`wtime`</span> <span class="sc">\&gt;</span>83 and positive</span>
<span id="cb113-860"><a href="#cb113-860" aria-hidden="true" tabindex="-1"></a>for the next smallest value. A reasonable cut-point is 80 days.</span>
<span id="cb113-861"><a href="#cb113-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-862"><a href="#cb113-862" aria-hidden="true" tabindex="-1"></a><span class="fu">### Updating the model {.unnumbered}</span></span>
<span id="cb113-863"><a href="#cb113-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-864"><a href="#cb113-864" aria-hidden="true" tabindex="-1"></a>Let's reformulate the model with dichotomized <span class="in">`wtime`</span>.</span>
<span id="cb113-865"><a href="#cb113-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-868"><a href="#cb113-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-869"><a href="#cb113-869" aria-hidden="true" tabindex="-1"></a>hodg2 <span class="ot">=</span> </span>
<span id="cb113-870"><a href="#cb113-870" aria-hidden="true" tabindex="-1"></a>  hodg2 <span class="sc">|&gt;</span> </span>
<span id="cb113-871"><a href="#cb113-871" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-872"><a href="#cb113-872" aria-hidden="true" tabindex="-1"></a>    <span class="at">wt2 =</span> <span class="fu">cut</span>(</span>
<span id="cb113-873"><a href="#cb113-873" aria-hidden="true" tabindex="-1"></a>      wtime,<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="dv">200</span>),</span>
<span id="cb113-874"><a href="#cb113-874" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"short"</span>,<span class="st">"long"</span>)))</span>
<span id="cb113-875"><a href="#cb113-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-876"><a href="#cb113-876" aria-hidden="true" tabindex="-1"></a>hodg.cox2 <span class="ot">=</span></span>
<span id="cb113-877"><a href="#cb113-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-878"><a href="#cb113-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> </span>
<span id="cb113-879"><a href="#cb113-879" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Surv</span>(time, <span class="at">event =</span> delta <span class="sc">==</span> <span class="st">"dead"</span>) <span class="sc">~</span> </span>
<span id="cb113-880"><a href="#cb113-880" aria-hidden="true" tabindex="-1"></a>      gtype<span class="sc">*</span>dtype <span class="sc">+</span> score <span class="sc">+</span> wt2,</span>
<span id="cb113-881"><a href="#cb113-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> hodg2)</span>
<span id="cb113-882"><a href="#cb113-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-883"><a href="#cb113-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-886"><a href="#cb113-886" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-887"><a href="#cb113-887" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Model summary table with waiting time on continuous scale"</span></span>
<span id="cb113-888"><a href="#cb113-888" aria-hidden="true" tabindex="-1"></a>hodg.cox1 <span class="sc">|&gt;</span> <span class="fu">drop1</span>(<span class="at">test=</span><span class="st">"Chisq"</span>)</span>
<span id="cb113-889"><a href="#cb113-889" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-890"><a href="#cb113-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-893"><a href="#cb113-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-894"><a href="#cb113-894" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Model summary table with dichotomized waiting time"</span></span>
<span id="cb113-895"><a href="#cb113-895" aria-hidden="true" tabindex="-1"></a>hodg.cox2 <span class="sc">|&gt;</span> <span class="fu">drop1</span>(<span class="at">test=</span><span class="st">"Chisq"</span>)</span>
<span id="cb113-896"><a href="#cb113-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-897"><a href="#cb113-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-898"><a href="#cb113-898" aria-hidden="true" tabindex="-1"></a>The new model has better (lower) AIC.</span>
<span id="cb113-899"><a href="#cb113-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-900"><a href="#cb113-900" aria-hidden="true" tabindex="-1"></a><span class="fu"># Checking for Outliers and Influential Observations</span></span>
<span id="cb113-901"><a href="#cb113-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-902"><a href="#cb113-902" aria-hidden="true" tabindex="-1"></a>We will check for outliers using the deviance residuals. The martingale</span>
<span id="cb113-903"><a href="#cb113-903" aria-hidden="true" tabindex="-1"></a>residuals show excess events or the opposite, but highly skewed, with</span>
<span id="cb113-904"><a href="#cb113-904" aria-hidden="true" tabindex="-1"></a>the maximum possible value being 1, but the smallest value can be very</span>
<span id="cb113-905"><a href="#cb113-905" aria-hidden="true" tabindex="-1"></a>large negative. Martingale residuals can detect unexpectedly long-lived</span>
<span id="cb113-906"><a href="#cb113-906" aria-hidden="true" tabindex="-1"></a>patients, but patients who die unexpectedly early show up only in the</span>
<span id="cb113-907"><a href="#cb113-907" aria-hidden="true" tabindex="-1"></a>deviance residual. Influence will be examined using dfbeta in a similar</span>
<span id="cb113-908"><a href="#cb113-908" aria-hidden="true" tabindex="-1"></a>way to linear regression, logistic regression, or Poisson regression.</span>
<span id="cb113-909"><a href="#cb113-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-910"><a href="#cb113-910" aria-hidden="true" tabindex="-1"></a><span class="fu">## Deviance Residuals</span></span>
<span id="cb113-911"><a href="#cb113-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-912"><a href="#cb113-912" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-913"><a href="#cb113-913" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb113-914"><a href="#cb113-914" aria-hidden="true" tabindex="-1"></a>r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left<span class="co">[</span><span class="ot"> r_i^M+\delta_i\ln(\delta_i-r_i^M)  \right</span><span class="co">]</span>}<span class="sc">\\</span></span>
<span id="cb113-915"><a href="#cb113-915" aria-hidden="true" tabindex="-1"></a>r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left<span class="co">[</span><span class="ot"> r_i^M+\delta_i\ln(r_i^{CS})  \right</span><span class="co">]</span>}</span>
<span id="cb113-916"><a href="#cb113-916" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb113-917"><a href="#cb113-917" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb113-918"><a href="#cb113-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-919"><a href="#cb113-919" aria-hidden="true" tabindex="-1"></a>Roughly centered on 0 with approximate standard deviation 1.</span>
<span id="cb113-920"><a href="#cb113-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-921"><a href="#cb113-921" aria-hidden="true" tabindex="-1"></a><span class="fu">## </span></span>
<span id="cb113-922"><a href="#cb113-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-925"><a href="#cb113-925" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-926"><a href="#cb113-926" aria-hidden="true" tabindex="-1"></a>hodg.mart <span class="ot">=</span> <span class="fu">residuals</span>(hodg.cox2,<span class="at">type=</span><span class="st">"martingale"</span>)</span>
<span id="cb113-927"><a href="#cb113-927" aria-hidden="true" tabindex="-1"></a>hodg.dev <span class="ot">=</span> <span class="fu">residuals</span>(hodg.cox2,<span class="at">type=</span><span class="st">"deviance"</span>)</span>
<span id="cb113-928"><a href="#cb113-928" aria-hidden="true" tabindex="-1"></a>hodg.dfb <span class="ot">=</span> <span class="fu">residuals</span>(hodg.cox2,<span class="at">type=</span><span class="st">"dfbeta"</span>)</span>
<span id="cb113-929"><a href="#cb113-929" aria-hidden="true" tabindex="-1"></a>hodg.preds <span class="ot">=</span> <span class="fu">predict</span>(hodg.cox2)                   <span class="co">#linear predictor</span></span>
<span id="cb113-930"><a href="#cb113-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-931"><a href="#cb113-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-932"><a href="#cb113-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-935"><a href="#cb113-935" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-936"><a href="#cb113-936" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Martingale Residuals vs. Linear Predictor"</span></span>
<span id="cb113-937"><a href="#cb113-937" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.preds,</span>
<span id="cb113-938"><a href="#cb113-938" aria-hidden="true" tabindex="-1"></a>     hodg.mart,</span>
<span id="cb113-939"><a href="#cb113-939" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Linear Predictor"</span>,</span>
<span id="cb113-940"><a href="#cb113-940" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Martingale Residual"</span>)</span>
<span id="cb113-941"><a href="#cb113-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-942"><a href="#cb113-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-943"><a href="#cb113-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-944"><a href="#cb113-944" aria-hidden="true" tabindex="-1"></a>The smallest three martingale residuals in order are observations 1, 29,</span>
<span id="cb113-945"><a href="#cb113-945" aria-hidden="true" tabindex="-1"></a>and 18.</span>
<span id="cb113-946"><a href="#cb113-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-949"><a href="#cb113-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-950"><a href="#cb113-950" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Deviance Residuals vs. Linear Predictor"</span></span>
<span id="cb113-951"><a href="#cb113-951" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.preds,hodg.dev,<span class="at">xlab=</span><span class="st">"Linear Predictor"</span>,<span class="at">ylab=</span><span class="st">"Deviance Residual"</span>)</span>
<span id="cb113-952"><a href="#cb113-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-953"><a href="#cb113-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-954"><a href="#cb113-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-955"><a href="#cb113-955" aria-hidden="true" tabindex="-1"></a>The two largest deviance residuals are observations 1 and 29. Worth</span>
<span id="cb113-956"><a href="#cb113-956" aria-hidden="true" tabindex="-1"></a>examining.</span>
<span id="cb113-957"><a href="#cb113-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-958"><a href="#cb113-958" aria-hidden="true" tabindex="-1"></a><span class="fu">## dfbeta</span></span>
<span id="cb113-959"><a href="#cb113-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-960"><a href="#cb113-960" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>dfbeta is the approximate change in the coefficient vector if that</span>
<span id="cb113-961"><a href="#cb113-961" aria-hidden="true" tabindex="-1"></a>    observation were dropped</span>
<span id="cb113-962"><a href="#cb113-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-963"><a href="#cb113-963" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>dfbetas is the approximate change in the coefficients, scaled by the</span>
<span id="cb113-964"><a href="#cb113-964" aria-hidden="true" tabindex="-1"></a>    standard error for the coefficients.</span>
<span id="cb113-965"><a href="#cb113-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-966"><a href="#cb113-966" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graft type</span></span>
<span id="cb113-967"><a href="#cb113-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-970"><a href="#cb113-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-971"><a href="#cb113-971" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "dfbeta Values by Observation Order for Graft Type"</span></span>
<span id="cb113-972"><a href="#cb113-972" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.dfb[,<span class="dv">1</span>],<span class="at">xlab=</span><span class="st">"Observation Order"</span>,<span class="at">ylab=</span><span class="st">"dfbeta for Graft Type"</span>)</span>
<span id="cb113-973"><a href="#cb113-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-974"><a href="#cb113-974" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-975"><a href="#cb113-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-976"><a href="#cb113-976" aria-hidden="true" tabindex="-1"></a>The smallest dfbeta for graft type is observation 1.</span>
<span id="cb113-977"><a href="#cb113-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-978"><a href="#cb113-978" aria-hidden="true" tabindex="-1"></a><span class="fu">### Disease type</span></span>
<span id="cb113-979"><a href="#cb113-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-982"><a href="#cb113-982" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-983"><a href="#cb113-983" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "dfbeta Values by Observation Order for Disease Type"</span></span>
<span id="cb113-984"><a href="#cb113-984" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.dfb[,<span class="dv">2</span>],</span>
<span id="cb113-985"><a href="#cb113-985" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Observation Order"</span>,</span>
<span id="cb113-986"><a href="#cb113-986" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"dfbeta for Disease Type"</span>)</span>
<span id="cb113-987"><a href="#cb113-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-988"><a href="#cb113-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-989"><a href="#cb113-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-990"><a href="#cb113-990" aria-hidden="true" tabindex="-1"></a>The smallest two dfbeta values for disease type are observations 1 and</span>
<span id="cb113-991"><a href="#cb113-991" aria-hidden="true" tabindex="-1"></a>16.</span>
<span id="cb113-992"><a href="#cb113-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-993"><a href="#cb113-993" aria-hidden="true" tabindex="-1"></a><span class="fu">### Karnofsky score</span></span>
<span id="cb113-994"><a href="#cb113-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-997"><a href="#cb113-997" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-998"><a href="#cb113-998" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "dfbeta Values by Observation Order for Karnofsky Score"</span></span>
<span id="cb113-999"><a href="#cb113-999" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.dfb[,<span class="dv">3</span>],</span>
<span id="cb113-1000"><a href="#cb113-1000" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Observation Order"</span>,</span>
<span id="cb113-1001"><a href="#cb113-1001" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"dfbeta for Karnofsky Score"</span>)</span>
<span id="cb113-1002"><a href="#cb113-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1003"><a href="#cb113-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1004"><a href="#cb113-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1005"><a href="#cb113-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1006"><a href="#cb113-1006" aria-hidden="true" tabindex="-1"></a>The two highest dfbeta values for score are observations 1 and 18. The</span>
<span id="cb113-1007"><a href="#cb113-1007" aria-hidden="true" tabindex="-1"></a>next three are observations 17, 29, and 19. The smallest value is</span>
<span id="cb113-1008"><a href="#cb113-1008" aria-hidden="true" tabindex="-1"></a>observation 2.</span>
<span id="cb113-1009"><a href="#cb113-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1010"><a href="#cb113-1010" aria-hidden="true" tabindex="-1"></a><span class="fu">### Waiting time (dichotomized)</span></span>
<span id="cb113-1011"><a href="#cb113-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1014"><a href="#cb113-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1015"><a href="#cb113-1015" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "dfbeta Values by Observation Order for Waiting Time (dichotomized)"</span></span>
<span id="cb113-1016"><a href="#cb113-1016" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb113-1017"><a href="#cb113-1017" aria-hidden="true" tabindex="-1"></a>  hodg.dfb[,<span class="dv">4</span>],</span>
<span id="cb113-1018"><a href="#cb113-1018" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab=</span><span class="st">"Observation Order"</span>,</span>
<span id="cb113-1019"><a href="#cb113-1019" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab=</span><span class="st">"dfbeta for `Waiting Time &lt; 80`"</span>)</span>
<span id="cb113-1020"><a href="#cb113-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1021"><a href="#cb113-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1022"><a href="#cb113-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1023"><a href="#cb113-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1024"><a href="#cb113-1024" aria-hidden="true" tabindex="-1"></a>The two large values of dfbeta for dichotomized waiting time are</span>
<span id="cb113-1025"><a href="#cb113-1025" aria-hidden="true" tabindex="-1"></a>observations 15 and 16. This may have to do with the discretization of</span>
<span id="cb113-1026"><a href="#cb113-1026" aria-hidden="true" tabindex="-1"></a>waiting time.</span>
<span id="cb113-1027"><a href="#cb113-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1028"><a href="#cb113-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interaction: graft type and disease type</span></span>
<span id="cb113-1029"><a href="#cb113-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1032"><a href="#cb113-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1033"><a href="#cb113-1033" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "dfbeta Values by Observation Order for dtype:gtype"</span></span>
<span id="cb113-1034"><a href="#cb113-1034" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hodg.dfb[,<span class="dv">5</span>],</span>
<span id="cb113-1035"><a href="#cb113-1035" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Observation Order"</span>,</span>
<span id="cb113-1036"><a href="#cb113-1036" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"dfbeta for dtype:gtype"</span>)</span>
<span id="cb113-1037"><a href="#cb113-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1038"><a href="#cb113-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1039"><a href="#cb113-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1040"><a href="#cb113-1040" aria-hidden="true" tabindex="-1"></a>The two largest values are observations 1 and 16. The smallest value is</span>
<span id="cb113-1041"><a href="#cb113-1041" aria-hidden="true" tabindex="-1"></a>observation 35.</span>
<span id="cb113-1042"><a href="#cb113-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1043"><a href="#cb113-1043" aria-hidden="true" tabindex="-1"></a><span class="fu">## </span></span>
<span id="cb113-1044"><a href="#cb113-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1045"><a href="#cb113-1045" aria-hidden="true" tabindex="-1"></a>| Diagnostic                 | Observations to Examine |</span>
<span id="cb113-1046"><a href="#cb113-1046" aria-hidden="true" tabindex="-1"></a>|----------------------------|-------------------------|</span>
<span id="cb113-1047"><a href="#cb113-1047" aria-hidden="true" tabindex="-1"></a>| Martingale Residuals       | 1, 29, 18               |</span>
<span id="cb113-1048"><a href="#cb113-1048" aria-hidden="true" tabindex="-1"></a>| Deviance Residuals         | 1, 29                   |</span>
<span id="cb113-1049"><a href="#cb113-1049" aria-hidden="true" tabindex="-1"></a>| Graft Type Influence       | 1                       |</span>
<span id="cb113-1050"><a href="#cb113-1050" aria-hidden="true" tabindex="-1"></a>| Disease Type Influence     | 1, 16                   |</span>
<span id="cb113-1051"><a href="#cb113-1051" aria-hidden="true" tabindex="-1"></a>| Karnofsky Score Influence  | 1, 18 (17, 29, 19)      |</span>
<span id="cb113-1052"><a href="#cb113-1052" aria-hidden="true" tabindex="-1"></a>| Waiting Time Influence     | 15, 16                  |</span>
<span id="cb113-1053"><a href="#cb113-1053" aria-hidden="true" tabindex="-1"></a>| Graft by Disease Influence | 1, 16, 35               |</span>
<span id="cb113-1054"><a href="#cb113-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1055"><a href="#cb113-1055" aria-hidden="true" tabindex="-1"></a>: Observations to Examine by Residuals and Influence</span>
<span id="cb113-1056"><a href="#cb113-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1057"><a href="#cb113-1057" aria-hidden="true" tabindex="-1"></a>The most important observations to examine seem to be 1, 15, 16, 18, and</span>
<span id="cb113-1058"><a href="#cb113-1058" aria-hidden="true" tabindex="-1"></a>29.</span>
<span id="cb113-1059"><a href="#cb113-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1060"><a href="#cb113-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">## </span></span>
<span id="cb113-1061"><a href="#cb113-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1064"><a href="#cb113-1064" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1065"><a href="#cb113-1065" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(hodg,<span class="fu">summary</span>(time[delta<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb113-1066"><a href="#cb113-1066" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1067"><a href="#cb113-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1070"><a href="#cb113-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1071"><a href="#cb113-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(hodg,<span class="fu">summary</span>(wtime))</span>
<span id="cb113-1072"><a href="#cb113-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1073"><a href="#cb113-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1076"><a href="#cb113-1076" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1077"><a href="#cb113-1077" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(hodg,<span class="fu">summary</span>(score))</span>
<span id="cb113-1078"><a href="#cb113-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1079"><a href="#cb113-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1082"><a href="#cb113-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1083"><a href="#cb113-1083" aria-hidden="true" tabindex="-1"></a>hodg.cox2</span>
<span id="cb113-1084"><a href="#cb113-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1085"><a href="#cb113-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1088"><a href="#cb113-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1089"><a href="#cb113-1089" aria-hidden="true" tabindex="-1"></a>hodg2[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">18</span>,<span class="dv">29</span>),] <span class="sc">|&gt;</span> </span>
<span id="cb113-1090"><a href="#cb113-1090" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gtype, dtype, time, delta, score, wtime) <span class="sc">|&gt;</span> </span>
<span id="cb113-1091"><a href="#cb113-1091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-1092"><a href="#cb113-1092" aria-hidden="true" tabindex="-1"></a>    <span class="at">comment =</span> </span>
<span id="cb113-1093"><a href="#cb113-1093" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb113-1094"><a href="#cb113-1094" aria-hidden="true" tabindex="-1"></a>        <span class="st">"early death, good score, low risk"</span>,</span>
<span id="cb113-1095"><a href="#cb113-1095" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high risk grp, long wait, poor score"</span>,</span>
<span id="cb113-1096"><a href="#cb113-1096" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high risk grp, short wait, poor score"</span>,</span>
<span id="cb113-1097"><a href="#cb113-1097" aria-hidden="true" tabindex="-1"></a>        <span class="st">"early death, good score, med risk grp"</span>,</span>
<span id="cb113-1098"><a href="#cb113-1098" aria-hidden="true" tabindex="-1"></a>        <span class="st">"early death, good score, med risk grp"</span></span>
<span id="cb113-1099"><a href="#cb113-1099" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb113-1100"><a href="#cb113-1100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1101"><a href="#cb113-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1102"><a href="#cb113-1102" aria-hidden="true" tabindex="-1"></a><span class="fu">## Action Items</span></span>
<span id="cb113-1103"><a href="#cb113-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1104"><a href="#cb113-1104" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Unusual points may need checking, particularly if the data are not</span>
<span id="cb113-1105"><a href="#cb113-1105" aria-hidden="true" tabindex="-1"></a>    completely cleaned. In this case, observations 15 and 16 may show</span>
<span id="cb113-1106"><a href="#cb113-1106" aria-hidden="true" tabindex="-1"></a>    some trouble with the dichotomization of waiting time, but it still</span>
<span id="cb113-1107"><a href="#cb113-1107" aria-hidden="true" tabindex="-1"></a>    may be useful.</span>
<span id="cb113-1108"><a href="#cb113-1108" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The two largest residuals seem to be due to unexpectedly early</span>
<span id="cb113-1109"><a href="#cb113-1109" aria-hidden="true" tabindex="-1"></a>    deaths, but unfortunately this can occur.</span>
<span id="cb113-1110"><a href="#cb113-1110" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>If hazards don't look proportional, then we may need to use strata,</span>
<span id="cb113-1111"><a href="#cb113-1111" aria-hidden="true" tabindex="-1"></a>    between which the base hazards are permitted to be different. For</span>
<span id="cb113-1112"><a href="#cb113-1112" aria-hidden="true" tabindex="-1"></a>    this problem, the natural strata are the two diseases, because they</span>
<span id="cb113-1113"><a href="#cb113-1113" aria-hidden="true" tabindex="-1"></a>    could need to be managed differently anyway.</span>
<span id="cb113-1114"><a href="#cb113-1114" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A main point that we want to be sure of is the relative risk</span>
<span id="cb113-1115"><a href="#cb113-1115" aria-hidden="true" tabindex="-1"></a>    difference by disease type and graft type.</span>
<span id="cb113-1116"><a href="#cb113-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1119"><a href="#cb113-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1120"><a href="#cb113-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Linear Risk Predictors for Lymphoma"</span></span>
<span id="cb113-1121"><a href="#cb113-1121" aria-hidden="true" tabindex="-1"></a>hodg.cox2 <span class="sc">|&gt;</span> </span>
<span id="cb113-1122"><a href="#cb113-1122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(</span>
<span id="cb113-1123"><a href="#cb113-1123" aria-hidden="true" tabindex="-1"></a>    <span class="at">reference =</span> <span class="st">"zero"</span>,</span>
<span id="cb113-1124"><a href="#cb113-1124" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> means <span class="sc">|&gt;</span> </span>
<span id="cb113-1125"><a href="#cb113-1125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb113-1126"><a href="#cb113-1126" aria-hidden="true" tabindex="-1"></a>        <span class="at">wt2 =</span> <span class="st">"short"</span>, </span>
<span id="cb113-1127"><a href="#cb113-1127" aria-hidden="true" tabindex="-1"></a>        <span class="at">score =</span> <span class="dv">0</span>), </span>
<span id="cb113-1128"><a href="#cb113-1128" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"lp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1129"><a href="#cb113-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="st">'linear predictor'</span> <span class="ot">=</span> _) <span class="sc">|&gt;</span> </span>
<span id="cb113-1130"><a href="#cb113-1130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pander</span>()</span>
<span id="cb113-1131"><a href="#cb113-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1132"><a href="#cb113-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1133"><a href="#cb113-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1134"><a href="#cb113-1134" aria-hidden="true" tabindex="-1"></a>For Non-Hodgkin's, the allogenic graft is better. For Hodgkin's, the</span>
<span id="cb113-1135"><a href="#cb113-1135" aria-hidden="true" tabindex="-1"></a>autologous graft is much better.</span>
<span id="cb113-1136"><a href="#cb113-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1137"><a href="#cb113-1137" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stratified survival models</span></span>
<span id="cb113-1138"><a href="#cb113-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1139"><a href="#cb113-1139" aria-hidden="true" tabindex="-1"></a><span class="fu">## Revisiting the leukemia dataset (`anderson`)</span></span>
<span id="cb113-1140"><a href="#cb113-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1141"><a href="#cb113-1141" aria-hidden="true" tabindex="-1"></a>We will analyze remission survival times on 42 leukemia patients, half</span>
<span id="cb113-1142"><a href="#cb113-1142" aria-hidden="true" tabindex="-1"></a>on new treatment, half on standard treatment.</span>
<span id="cb113-1143"><a href="#cb113-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1144"><a href="#cb113-1144" aria-hidden="true" tabindex="-1"></a>This is the same data as the <span class="in">`drug6mp`</span> data from <span class="in">`KMsurv`</span>, but with two</span>
<span id="cb113-1145"><a href="#cb113-1145" aria-hidden="true" tabindex="-1"></a>other variables and without the pairing. This version comes from the</span>
<span id="cb113-1146"><a href="#cb113-1146" aria-hidden="true" tabindex="-1"></a>Kleinbaum and Klein survival textbook (e.g., p281):</span>
<span id="cb113-1147"><a href="#cb113-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1150"><a href="#cb113-1150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1151"><a href="#cb113-1151" aria-hidden="true" tabindex="-1"></a>anderson <span class="ot">=</span> </span>
<span id="cb113-1152"><a href="#cb113-1152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(</span>
<span id="cb113-1153"><a href="#cb113-1153" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets/"</span>,</span>
<span id="cb113-1154"><a href="#cb113-1154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"surv2datasets/anderson.dta"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1155"><a href="#cb113-1155" aria-hidden="true" tabindex="-1"></a>  haven<span class="sc">::</span><span class="fu">read_dta</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1156"><a href="#cb113-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-1157"><a href="#cb113-1157" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> status <span class="sc">|&gt;</span> </span>
<span id="cb113-1158"><a href="#cb113-1158" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1159"><a href="#cb113-1159" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"relapse"</span>,</span>
<span id="cb113-1160"><a href="#cb113-1160" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"censored"</span></span>
<span id="cb113-1161"><a href="#cb113-1161" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb113-1162"><a href="#cb113-1162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1163"><a href="#cb113-1163" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> sex <span class="sc">|&gt;</span> </span>
<span id="cb113-1164"><a href="#cb113-1164" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1165"><a href="#cb113-1165" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"female"</span>,</span>
<span id="cb113-1166"><a href="#cb113-1166" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"male"</span></span>
<span id="cb113-1167"><a href="#cb113-1167" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb113-1168"><a href="#cb113-1168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1169"><a href="#cb113-1169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">relevel</span>(<span class="at">ref =</span> <span class="st">"female"</span>),</span>
<span id="cb113-1170"><a href="#cb113-1170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1171"><a href="#cb113-1171" aria-hidden="true" tabindex="-1"></a>    <span class="at">rx =</span> rx <span class="sc">|&gt;</span> </span>
<span id="cb113-1172"><a href="#cb113-1172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1173"><a href="#cb113-1173" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"new"</span>,</span>
<span id="cb113-1174"><a href="#cb113-1174" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"standard"</span></span>
<span id="cb113-1175"><a href="#cb113-1175" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb113-1176"><a href="#cb113-1176" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">|&gt;</span> <span class="fu">relevel</span>(<span class="at">ref =</span> <span class="st">"standard"</span>),</span>
<span id="cb113-1177"><a href="#cb113-1177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1178"><a href="#cb113-1178" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv =</span> <span class="fu">Surv</span>(</span>
<span id="cb113-1179"><a href="#cb113-1179" aria-hidden="true" tabindex="-1"></a>      <span class="at">time =</span> survt, </span>
<span id="cb113-1180"><a href="#cb113-1180" aria-hidden="true" tabindex="-1"></a>      <span class="at">event =</span> (status <span class="sc">==</span> <span class="st">"relapse"</span>))</span>
<span id="cb113-1181"><a href="#cb113-1181" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-1182"><a href="#cb113-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1183"><a href="#cb113-1183" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(anderson)</span>
<span id="cb113-1184"><a href="#cb113-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1185"><a href="#cb113-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1186"><a href="#cb113-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cox semi-parametric proportional hazards model</span></span>
<span id="cb113-1187"><a href="#cb113-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1190"><a href="#cb113-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1191"><a href="#cb113-1191" aria-hidden="true" tabindex="-1"></a>anderson.cox1 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-1192"><a href="#cb113-1192" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> rx <span class="sc">+</span> sex <span class="sc">+</span> logwbc,</span>
<span id="cb113-1193"><a href="#cb113-1193" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> anderson)</span>
<span id="cb113-1194"><a href="#cb113-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1195"><a href="#cb113-1195" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(anderson.cox1)</span>
<span id="cb113-1196"><a href="#cb113-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1197"><a href="#cb113-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1198"><a href="#cb113-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1199"><a href="#cb113-1199" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test the proportional hazards assumption</span></span>
<span id="cb113-1200"><a href="#cb113-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1203"><a href="#cb113-1203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1204"><a href="#cb113-1204" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zph</span>(anderson.cox1)</span>
<span id="cb113-1205"><a href="#cb113-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1206"><a href="#cb113-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1207"><a href="#cb113-1207" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graph the K-M survival curves</span></span>
<span id="cb113-1208"><a href="#cb113-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1211"><a href="#cb113-1211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1212"><a href="#cb113-1212" aria-hidden="true" tabindex="-1"></a>anderson_km_model <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb113-1213"><a href="#cb113-1213" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> sex,</span>
<span id="cb113-1214"><a href="#cb113-1214" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> anderson)</span>
<span id="cb113-1215"><a href="#cb113-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1216"><a href="#cb113-1216" aria-hidden="true" tabindex="-1"></a>anderson_km_model <span class="sc">|&gt;</span> </span>
<span id="cb113-1217"><a href="#cb113-1217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb113-1218"><a href="#cb113-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb113-1219"><a href="#cb113-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb113-1220"><a href="#cb113-1220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1221"><a href="#cb113-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1222"><a href="#cb113-1222" aria-hidden="true" tabindex="-1"></a>The survival curves cross, which indicates a problem in the</span>
<span id="cb113-1223"><a href="#cb113-1223" aria-hidden="true" tabindex="-1"></a>proportionality assumption by sex.</span>
<span id="cb113-1224"><a href="#cb113-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1225"><a href="#cb113-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">## Graph the Nelson-Aalen cumulative hazard</span></span>
<span id="cb113-1226"><a href="#cb113-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1227"><a href="#cb113-1227" aria-hidden="true" tabindex="-1"></a>We can also look at the log-hazard ("cloglog survival") plots:</span>
<span id="cb113-1228"><a href="#cb113-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1231"><a href="#cb113-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1232"><a href="#cb113-1232" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative hazard (cloglog scale) for `anderson` data"</span></span>
<span id="cb113-1233"><a href="#cb113-1233" aria-hidden="true" tabindex="-1"></a>anderson_na_model <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb113-1234"><a href="#cb113-1234" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> sex,</span>
<span id="cb113-1235"><a href="#cb113-1235" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> anderson,</span>
<span id="cb113-1236"><a href="#cb113-1236" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"fleming"</span>)</span>
<span id="cb113-1237"><a href="#cb113-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1238"><a href="#cb113-1238" aria-hidden="true" tabindex="-1"></a>anderson_na_model <span class="sc">|&gt;</span> </span>
<span id="cb113-1239"><a href="#cb113-1239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(</span>
<span id="cb113-1240"><a href="#cb113-1240" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">"cumhaz"</span>,</span>
<span id="cb113-1241"><a href="#cb113-1241" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb113-1242"><a href="#cb113-1242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb113-1243"><a href="#cb113-1243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb113-1244"><a href="#cb113-1244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"log(Cumulative Hazard)"</span>) <span class="sc">+</span></span>
<span id="cb113-1245"><a href="#cb113-1245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb113-1246"><a href="#cb113-1246" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log10"</span>,</span>
<span id="cb113-1247"><a href="#cb113-1247" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Cumulative hazard (H(t), log scale)"</span>) <span class="sc">+</span></span>
<span id="cb113-1248"><a href="#cb113-1248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb113-1249"><a href="#cb113-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">50</span>),</span>
<span id="cb113-1250"><a href="#cb113-1250" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log"</span></span>
<span id="cb113-1251"><a href="#cb113-1251" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-1252"><a href="#cb113-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1253"><a href="#cb113-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1254"><a href="#cb113-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1255"><a href="#cb113-1255" aria-hidden="true" tabindex="-1"></a>This can be fixed by using strata or possibly by other model</span>
<span id="cb113-1256"><a href="#cb113-1256" aria-hidden="true" tabindex="-1"></a>alterations.</span>
<span id="cb113-1257"><a href="#cb113-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1258"><a href="#cb113-1258" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Stratified Cox Model</span></span>
<span id="cb113-1259"><a href="#cb113-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1260"><a href="#cb113-1260" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In a stratified Cox model, each stratum, defined by one or more</span>
<span id="cb113-1261"><a href="#cb113-1261" aria-hidden="true" tabindex="-1"></a>    factors, has its own base survival function $h_0(t)$.</span>
<span id="cb113-1262"><a href="#cb113-1262" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>But the coefficients for each variable not used in the strata</span>
<span id="cb113-1263"><a href="#cb113-1263" aria-hidden="true" tabindex="-1"></a>    definitions are assumed to be the same across strata.</span>
<span id="cb113-1264"><a href="#cb113-1264" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>To check if this assumption is reasonable one can include</span>
<span id="cb113-1265"><a href="#cb113-1265" aria-hidden="true" tabindex="-1"></a>    interactions with strata and see if they are significant (this may</span>
<span id="cb113-1266"><a href="#cb113-1266" aria-hidden="true" tabindex="-1"></a>    generate a warning and NA lines but these can be ignored).</span>
<span id="cb113-1267"><a href="#cb113-1267" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Since the <span class="in">`sex`</span> variable shows possible non-proportionality, we try</span>
<span id="cb113-1268"><a href="#cb113-1268" aria-hidden="true" tabindex="-1"></a>    stratifying on <span class="in">`sex`</span>.</span>
<span id="cb113-1269"><a href="#cb113-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1272"><a href="#cb113-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1273"><a href="#cb113-1273" aria-hidden="true" tabindex="-1"></a>anderson.coxph.strat <span class="ot">=</span> </span>
<span id="cb113-1274"><a href="#cb113-1274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-1275"><a href="#cb113-1275" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> </span>
<span id="cb113-1276"><a href="#cb113-1276" aria-hidden="true" tabindex="-1"></a>      surv <span class="sc">~</span> rx <span class="sc">+</span> logwbc <span class="sc">+</span> <span class="fu">strata</span>(sex),</span>
<span id="cb113-1277"><a href="#cb113-1277" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> anderson)</span>
<span id="cb113-1278"><a href="#cb113-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1279"><a href="#cb113-1279" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(anderson.coxph.strat)</span>
<span id="cb113-1280"><a href="#cb113-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1281"><a href="#cb113-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1282"><a href="#cb113-1282" aria-hidden="true" tabindex="-1"></a>Let's compare this to a model fit only on the subset of males:</span>
<span id="cb113-1283"><a href="#cb113-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1286"><a href="#cb113-1286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1287"><a href="#cb113-1287" aria-hidden="true" tabindex="-1"></a>anderson.coxph.male <span class="ot">=</span> </span>
<span id="cb113-1288"><a href="#cb113-1288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-1289"><a href="#cb113-1289" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> surv <span class="sc">~</span> rx <span class="sc">+</span> logwbc,</span>
<span id="cb113-1290"><a href="#cb113-1290" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> sex <span class="sc">==</span> <span class="st">"male"</span>,</span>
<span id="cb113-1291"><a href="#cb113-1291" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> anderson)</span>
<span id="cb113-1292"><a href="#cb113-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1293"><a href="#cb113-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(anderson.coxph.male)</span>
<span id="cb113-1294"><a href="#cb113-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1295"><a href="#cb113-1295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1296"><a href="#cb113-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1299"><a href="#cb113-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1300"><a href="#cb113-1300" aria-hidden="true" tabindex="-1"></a>anderson.coxph.female <span class="ot">=</span> </span>
<span id="cb113-1301"><a href="#cb113-1301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-1302"><a href="#cb113-1302" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> </span>
<span id="cb113-1303"><a href="#cb113-1303" aria-hidden="true" tabindex="-1"></a>      surv <span class="sc">~</span> rx <span class="sc">+</span> logwbc,</span>
<span id="cb113-1304"><a href="#cb113-1304" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> sex <span class="sc">==</span> <span class="st">"female"</span>,</span>
<span id="cb113-1305"><a href="#cb113-1305" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> anderson)</span>
<span id="cb113-1306"><a href="#cb113-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1307"><a href="#cb113-1307" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(anderson.coxph.female)</span>
<span id="cb113-1308"><a href="#cb113-1308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1309"><a href="#cb113-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1310"><a href="#cb113-1310" aria-hidden="true" tabindex="-1"></a>The coefficients of treatment look different. Are they statistically</span>
<span id="cb113-1311"><a href="#cb113-1311" aria-hidden="true" tabindex="-1"></a>different?</span>
<span id="cb113-1312"><a href="#cb113-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1315"><a href="#cb113-1315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1316"><a href="#cb113-1316" aria-hidden="true" tabindex="-1"></a>anderson.coxph.strat.intxn <span class="ot">=</span> </span>
<span id="cb113-1317"><a href="#cb113-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-1318"><a href="#cb113-1318" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> surv <span class="sc">~</span> <span class="fu">strata</span>(sex) <span class="sc">*</span> (rx <span class="sc">+</span> logwbc),</span>
<span id="cb113-1319"><a href="#cb113-1319" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> anderson)</span>
<span id="cb113-1320"><a href="#cb113-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1321"><a href="#cb113-1321" aria-hidden="true" tabindex="-1"></a>anderson.coxph.strat.intxn <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb113-1322"><a href="#cb113-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1323"><a href="#cb113-1323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1324"><a href="#cb113-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1327"><a href="#cb113-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1328"><a href="#cb113-1328" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(</span>
<span id="cb113-1329"><a href="#cb113-1329" aria-hidden="true" tabindex="-1"></a>  anderson.coxph.strat.intxn,</span>
<span id="cb113-1330"><a href="#cb113-1330" aria-hidden="true" tabindex="-1"></a>  anderson.coxph.strat)</span>
<span id="cb113-1331"><a href="#cb113-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1332"><a href="#cb113-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1333"><a href="#cb113-1333" aria-hidden="true" tabindex="-1"></a>We don't have enough evidence to tell the difference between these two</span>
<span id="cb113-1334"><a href="#cb113-1334" aria-hidden="true" tabindex="-1"></a>models.</span>
<span id="cb113-1335"><a href="#cb113-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1336"><a href="#cb113-1336" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusions</span></span>
<span id="cb113-1337"><a href="#cb113-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1338"><a href="#cb113-1338" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We chose to use a stratified model because of the apparent</span>
<span id="cb113-1339"><a href="#cb113-1339" aria-hidden="true" tabindex="-1"></a>    non-proportionality of the hazard for the sex variable.</span>
<span id="cb113-1340"><a href="#cb113-1340" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>When we fit interactions with the strata variable, we did not get an</span>
<span id="cb113-1341"><a href="#cb113-1341" aria-hidden="true" tabindex="-1"></a>    improved model (via the likelihood ratio test).</span>
<span id="cb113-1342"><a href="#cb113-1342" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>So we use the stratifed model with coefficients that are the same</span>
<span id="cb113-1343"><a href="#cb113-1343" aria-hidden="true" tabindex="-1"></a>    across strata.</span>
<span id="cb113-1344"><a href="#cb113-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1345"><a href="#cb113-1345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Another Modeling Approach</span></span>
<span id="cb113-1346"><a href="#cb113-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1347"><a href="#cb113-1347" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We used an additive model without interactions and saw that we might</span>
<span id="cb113-1348"><a href="#cb113-1348" aria-hidden="true" tabindex="-1"></a>    need to stratify by sex.</span>
<span id="cb113-1349"><a href="#cb113-1349" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Instead, we could try to improve the model's functional form - maybe</span>
<span id="cb113-1350"><a href="#cb113-1350" aria-hidden="true" tabindex="-1"></a>    the interaction of treatment and sex is real, and after fitting that</span>
<span id="cb113-1351"><a href="#cb113-1351" aria-hidden="true" tabindex="-1"></a>    we might not need separate hazard functions.</span>
<span id="cb113-1352"><a href="#cb113-1352" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Either approach may work.</span>
<span id="cb113-1353"><a href="#cb113-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1356"><a href="#cb113-1356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1357"><a href="#cb113-1357" aria-hidden="true" tabindex="-1"></a>anderson.coxph.intxn <span class="ot">=</span> </span>
<span id="cb113-1358"><a href="#cb113-1358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxph</span>(</span>
<span id="cb113-1359"><a href="#cb113-1359" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> surv <span class="sc">~</span> (rx <span class="sc">+</span> logwbc) <span class="sc">*</span> sex,</span>
<span id="cb113-1360"><a href="#cb113-1360" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> anderson)</span>
<span id="cb113-1361"><a href="#cb113-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1362"><a href="#cb113-1362" aria-hidden="true" tabindex="-1"></a>anderson.coxph.intxn <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb113-1363"><a href="#cb113-1363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1364"><a href="#cb113-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1367"><a href="#cb113-1367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1368"><a href="#cb113-1368" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zph</span>(anderson.coxph.intxn)</span>
<span id="cb113-1369"><a href="#cb113-1369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1370"><a href="#cb113-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1371"><a href="#cb113-1371" aria-hidden="true" tabindex="-1"></a><span class="fu"># Time-varying covariates</span></span>
<span id="cb113-1372"><a href="#cb113-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1373"><a href="#cb113-1373" aria-hidden="true" tabindex="-1"></a>(adapted from Klein and Moeschberger 2003, §9.2:</span>
<span id="cb113-1374"><a href="#cb113-1374" aria-hidden="true" tabindex="-1"></a>https://link.springer.com/book/10.1007/b97377)</span>
<span id="cb113-1375"><a href="#cb113-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1376"><a href="#cb113-1376" aria-hidden="true" tabindex="-1"></a><span class="fu">## Motivating example: back to the leukemia dataset</span></span>
<span id="cb113-1377"><a href="#cb113-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1380"><a href="#cb113-1380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1381"><a href="#cb113-1381" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb113-1382"><a href="#cb113-1382" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data:</span></span>
<span id="cb113-1383"><a href="#cb113-1383" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(bmt, <span class="at">package =</span> <span class="st">'KMsurv'</span>)</span>
<span id="cb113-1384"><a href="#cb113-1384" aria-hidden="true" tabindex="-1"></a>bmt <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb113-1385"><a href="#cb113-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1386"><a href="#cb113-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1387"><a href="#cb113-1387" aria-hidden="true" tabindex="-1"></a>This dataset comes from the Copelan et al. (1991) study of allogenic</span>
<span id="cb113-1388"><a href="#cb113-1388" aria-hidden="true" tabindex="-1"></a>bone marrow transplant therapy for acute myeloid leukemia (AML) and</span>
<span id="cb113-1389"><a href="#cb113-1389" aria-hidden="true" tabindex="-1"></a>acute lymphoblastic leukemia (ALL).</span>
<span id="cb113-1390"><a href="#cb113-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1391"><a href="#cb113-1391" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Outcomes (endpoints)</span></span>
<span id="cb113-1392"><a href="#cb113-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1393"><a href="#cb113-1393" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The main endpoint is disease-free survival (<span class="in">`t2`</span> and <span class="in">`d3`</span>) for the</span>
<span id="cb113-1394"><a href="#cb113-1394" aria-hidden="true" tabindex="-1"></a>    three risk groups, "ALL", "AML Low Risk", and "AML High Risk".</span>
<span id="cb113-1395"><a href="#cb113-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1396"><a href="#cb113-1396" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Possible intermediate events</span></span>
<span id="cb113-1397"><a href="#cb113-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1398"><a href="#cb113-1398" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>graft vs. host disease (**GVHD**), an immunological rejection</span>
<span id="cb113-1399"><a href="#cb113-1399" aria-hidden="true" tabindex="-1"></a>    response to the transplant (bad)</span>
<span id="cb113-1400"><a href="#cb113-1400" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>acute (**AGVHD**)</span>
<span id="cb113-1401"><a href="#cb113-1401" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>chronic (**CGVHD**)</span>
<span id="cb113-1402"><a href="#cb113-1402" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>platelet recovery, a return of platelet count to normal levels</span>
<span id="cb113-1403"><a href="#cb113-1403" aria-hidden="true" tabindex="-1"></a>    (good)</span>
<span id="cb113-1404"><a href="#cb113-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1405"><a href="#cb113-1405" aria-hidden="true" tabindex="-1"></a>One or the other, both in either order, or neither may occur.</span>
<span id="cb113-1406"><a href="#cb113-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1407"><a href="#cb113-1407" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Covariates</span></span>
<span id="cb113-1408"><a href="#cb113-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1409"><a href="#cb113-1409" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We are interested in possibly using the covariates <span class="in">`z1`</span>-<span class="in">`z10`</span> to</span>
<span id="cb113-1410"><a href="#cb113-1410" aria-hidden="true" tabindex="-1"></a>    adjust for other factors.</span>
<span id="cb113-1411"><a href="#cb113-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1412"><a href="#cb113-1412" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In addition, the time-varying covariates for acute GVHD, chronic</span>
<span id="cb113-1413"><a href="#cb113-1413" aria-hidden="true" tabindex="-1"></a>    GVHD, and platelet recovery may be useful.</span>
<span id="cb113-1414"><a href="#cb113-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1415"><a href="#cb113-1415" aria-hidden="true" tabindex="-1"></a><span class="fu">### Preprocessing</span></span>
<span id="cb113-1416"><a href="#cb113-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1417"><a href="#cb113-1417" aria-hidden="true" tabindex="-1"></a>We add reformat the data before analysis:</span>
<span id="cb113-1418"><a href="#cb113-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1421"><a href="#cb113-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1422"><a href="#cb113-1422" aria-hidden="true" tabindex="-1"></a><span class="co"># reformat the data:</span></span>
<span id="cb113-1423"><a href="#cb113-1423" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="ot">=</span> </span>
<span id="cb113-1424"><a href="#cb113-1424" aria-hidden="true" tabindex="-1"></a>  bmt <span class="sc">|&gt;</span> </span>
<span id="cb113-1425"><a href="#cb113-1425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1426"><a href="#cb113-1426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-1427"><a href="#cb113-1427" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="co"># will be used to connect multiple records for the same individual</span></span>
<span id="cb113-1428"><a href="#cb113-1428" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1429"><a href="#cb113-1429" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span>  group <span class="sc">|&gt;</span> </span>
<span id="cb113-1430"><a href="#cb113-1430" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1431"><a href="#cb113-1431" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"ALL"</span>,</span>
<span id="cb113-1432"><a href="#cb113-1432" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Low Risk AML"</span>,</span>
<span id="cb113-1433"><a href="#cb113-1433" aria-hidden="true" tabindex="-1"></a>        <span class="dv">3</span> <span class="sc">~</span> <span class="st">"High Risk AML"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1434"><a href="#cb113-1434" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"ALL"</span>, <span class="st">"Low Risk AML"</span>, <span class="st">"High Risk AML"</span>)),</span>
<span id="cb113-1435"><a href="#cb113-1435" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1436"><a href="#cb113-1436" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">patient age</span><span class="st">`</span> <span class="ot">=</span> z1,</span>
<span id="cb113-1437"><a href="#cb113-1437" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1438"><a href="#cb113-1438" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">donor age</span><span class="st">`</span> <span class="ot">=</span> z2,</span>
<span id="cb113-1439"><a href="#cb113-1439" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1440"><a href="#cb113-1440" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">patient sex</span><span class="st">`</span> <span class="ot">=</span> z3 <span class="sc">|&gt;</span> </span>
<span id="cb113-1441"><a href="#cb113-1441" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1442"><a href="#cb113-1442" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb113-1443"><a href="#cb113-1443" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>),</span>
<span id="cb113-1444"><a href="#cb113-1444" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1445"><a href="#cb113-1445" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">donor sex</span><span class="st">`</span> <span class="ot">=</span> z4 <span class="sc">|&gt;</span> </span>
<span id="cb113-1446"><a href="#cb113-1446" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1447"><a href="#cb113-1447" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb113-1448"><a href="#cb113-1448" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Male"</span>),</span>
<span id="cb113-1449"><a href="#cb113-1449" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1450"><a href="#cb113-1450" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Patient CMV Status</span><span class="st">`</span> <span class="ot">=</span> z5 <span class="sc">|&gt;</span> </span>
<span id="cb113-1451"><a href="#cb113-1451" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1452"><a href="#cb113-1452" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"CMV Negative"</span>,</span>
<span id="cb113-1453"><a href="#cb113-1453" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"CMV Positive"</span>),</span>
<span id="cb113-1454"><a href="#cb113-1454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1455"><a href="#cb113-1455" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Donor CMV Status</span><span class="st">`</span> <span class="ot">=</span> z6 <span class="sc">|&gt;</span> </span>
<span id="cb113-1456"><a href="#cb113-1456" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1457"><a href="#cb113-1457" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"CMV Negative"</span>,</span>
<span id="cb113-1458"><a href="#cb113-1458" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"CMV Positive"</span>),</span>
<span id="cb113-1459"><a href="#cb113-1459" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1460"><a href="#cb113-1460" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Waiting Time to Transplant</span><span class="st">`</span> <span class="ot">=</span> z7,</span>
<span id="cb113-1461"><a href="#cb113-1461" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1462"><a href="#cb113-1462" aria-hidden="true" tabindex="-1"></a>    <span class="at">FAB =</span> z8 <span class="sc">|&gt;</span> </span>
<span id="cb113-1463"><a href="#cb113-1463" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1464"><a href="#cb113-1464" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Grade 4 Or 5 (AML only)"</span>,</span>
<span id="cb113-1465"><a href="#cb113-1465" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Other"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1466"><a href="#cb113-1466" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1467"><a href="#cb113-1467" aria-hidden="true" tabindex="-1"></a>      <span class="fu">relevel</span>(<span class="at">ref =</span> <span class="st">"Other"</span>),</span>
<span id="cb113-1468"><a href="#cb113-1468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1469"><a href="#cb113-1469" aria-hidden="true" tabindex="-1"></a>    <span class="at">hospital =</span> z9 <span class="sc">|&gt;</span>  <span class="co"># `z9` is hospital</span></span>
<span id="cb113-1470"><a href="#cb113-1470" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_match</span>(</span>
<span id="cb113-1471"><a href="#cb113-1471" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Ohio State University"</span>,</span>
<span id="cb113-1472"><a href="#cb113-1472" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Alferd"</span>,</span>
<span id="cb113-1473"><a href="#cb113-1473" aria-hidden="true" tabindex="-1"></a>        <span class="dv">3</span> <span class="sc">~</span> <span class="st">"St. Vincent"</span>,</span>
<span id="cb113-1474"><a href="#cb113-1474" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Hahnemann"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1475"><a href="#cb113-1475" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1476"><a href="#cb113-1476" aria-hidden="true" tabindex="-1"></a>      <span class="fu">relevel</span>(<span class="at">ref =</span> <span class="st">"Ohio State University"</span>),</span>
<span id="cb113-1477"><a href="#cb113-1477" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1478"><a href="#cb113-1478" aria-hidden="true" tabindex="-1"></a>    <span class="at">MTX =</span> (z10 <span class="sc">==</span> <span class="dv">1</span>) <span class="co"># a prophylatic treatment for GVHD</span></span>
<span id="cb113-1479"><a href="#cb113-1479" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-1480"><a href="#cb113-1480" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb113-1481"><a href="#cb113-1481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>(z1<span class="sc">:</span>z10)) <span class="co"># don't need these anymore</span></span>
<span id="cb113-1482"><a href="#cb113-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1483"><a href="#cb113-1483" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="sc">|&gt;</span> </span>
<span id="cb113-1484"><a href="#cb113-1484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(group, id<span class="sc">:</span>MTX) <span class="sc">|&gt;</span> </span>
<span id="cb113-1485"><a href="#cb113-1485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb113-1486"><a href="#cb113-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1487"><a href="#cb113-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1488"><a href="#cb113-1488" aria-hidden="true" tabindex="-1"></a>::: content-hidden</span>
<span id="cb113-1489"><a href="#cb113-1489" aria-hidden="true" tabindex="-1"></a>We can do this with stepwise regression or hand examination of the</span>
<span id="cb113-1490"><a href="#cb113-1490" aria-hidden="true" tabindex="-1"></a>results of adding or removing variables.</span>
<span id="cb113-1491"><a href="#cb113-1491" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-1492"><a href="#cb113-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1493"><a href="#cb113-1493" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time-Dependent Covariates</span></span>
<span id="cb113-1494"><a href="#cb113-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1495"><a href="#cb113-1495" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A **time-dependent covariate** ("**TDC**") is a covariate whose</span>
<span id="cb113-1496"><a href="#cb113-1496" aria-hidden="true" tabindex="-1"></a>    value changes during the course of the study.</span>
<span id="cb113-1497"><a href="#cb113-1497" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For variables like age that change in a linear manner with time, we</span>
<span id="cb113-1498"><a href="#cb113-1498" aria-hidden="true" tabindex="-1"></a>    can just use the value at the start.</span>
<span id="cb113-1499"><a href="#cb113-1499" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>But it may be plausible that when and if GVHD occurs, the risk of</span>
<span id="cb113-1500"><a href="#cb113-1500" aria-hidden="true" tabindex="-1"></a>    relapse or death increases, and when and if platelet recovery</span>
<span id="cb113-1501"><a href="#cb113-1501" aria-hidden="true" tabindex="-1"></a>    occurs, the risk decreases.</span>
<span id="cb113-1502"><a href="#cb113-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1503"><a href="#cb113-1503" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis in R</span></span>
<span id="cb113-1504"><a href="#cb113-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1505"><a href="#cb113-1505" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We form a variable <span class="in">`precovery`</span> which is = 0 before platelet recovery</span>
<span id="cb113-1506"><a href="#cb113-1506" aria-hidden="true" tabindex="-1"></a>    and is = 1 after platelet recovery, if it occurs.</span>
<span id="cb113-1507"><a href="#cb113-1507" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For each subject where platelet recovery occurs, we set up multiple</span>
<span id="cb113-1508"><a href="#cb113-1508" aria-hidden="true" tabindex="-1"></a>    records (lines in the data frame); for example one from t = 0 to the</span>
<span id="cb113-1509"><a href="#cb113-1509" aria-hidden="true" tabindex="-1"></a>    time of platelet recovery, and one from that time to relapse,</span>
<span id="cb113-1510"><a href="#cb113-1510" aria-hidden="true" tabindex="-1"></a>    recovery, or death.</span>
<span id="cb113-1511"><a href="#cb113-1511" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We do the same for acute GVHD and chronic GVHD.</span>
<span id="cb113-1512"><a href="#cb113-1512" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For each record, the covariates are constant.</span>
<span id="cb113-1513"><a href="#cb113-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1516"><a href="#cb113-1516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1517"><a href="#cb113-1517" aria-hidden="true" tabindex="-1"></a>bmt2 <span class="ot">=</span> bmt1 <span class="sc">|&gt;</span> </span>
<span id="cb113-1518"><a href="#cb113-1518" aria-hidden="true" tabindex="-1"></a>  <span class="co">#set up new long-format data set:</span></span>
<span id="cb113-1519"><a href="#cb113-1519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmerge</span>(bmt1, <span class="at">id =</span> id, <span class="at">tstop =</span> t2) <span class="sc">|&gt;</span> </span>
<span id="cb113-1520"><a href="#cb113-1520" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-1521"><a href="#cb113-1521" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the following three steps can be in any order, </span></span>
<span id="cb113-1522"><a href="#cb113-1522" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and will still produce the same result:</span></span>
<span id="cb113-1523"><a href="#cb113-1523" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add aghvd as tdc:</span></span>
<span id="cb113-1524"><a href="#cb113-1524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmerge</span>(bmt1, <span class="at">id =</span> id, <span class="at">agvhd =</span> <span class="fu">tdc</span>(ta)) <span class="sc">|&gt;</span> </span>
<span id="cb113-1525"><a href="#cb113-1525" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add cghvd as tdc:</span></span>
<span id="cb113-1526"><a href="#cb113-1526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmerge</span>(bmt1, <span class="at">id =</span> id, <span class="at">cgvhd =</span> <span class="fu">tdc</span>(tc)) <span class="sc">|&gt;</span> </span>
<span id="cb113-1527"><a href="#cb113-1527" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add platelet recovery as tdc:</span></span>
<span id="cb113-1528"><a href="#cb113-1528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmerge</span>(bmt1, <span class="at">id =</span> id, <span class="at">precovery =</span> <span class="fu">tdc</span>(tp))   </span>
<span id="cb113-1529"><a href="#cb113-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1530"><a href="#cb113-1530" aria-hidden="true" tabindex="-1"></a>bmt2 <span class="ot">=</span> bmt2 <span class="sc">|&gt;</span> </span>
<span id="cb113-1531"><a href="#cb113-1531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1532"><a href="#cb113-1532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">as.numeric</span>((tstop <span class="sc">==</span> t2) <span class="sc">&amp;</span> d3))</span>
<span id="cb113-1533"><a href="#cb113-1533" aria-hidden="true" tabindex="-1"></a><span class="co"># status only = 1 if at end of t2 and not censored</span></span>
<span id="cb113-1534"><a href="#cb113-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1535"><a href="#cb113-1535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1536"><a href="#cb113-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1537"><a href="#cb113-1537" aria-hidden="true" tabindex="-1"></a>Let's see how we've rearranged the first row of the data:</span>
<span id="cb113-1538"><a href="#cb113-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1541"><a href="#cb113-1541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1542"><a href="#cb113-1542" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="sc">|&gt;</span> </span>
<span id="cb113-1543"><a href="#cb113-1543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1544"><a href="#cb113-1544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, t1, d1, t2, d2, d3, ta, da, tc, dc, tp, dp)</span>
<span id="cb113-1545"><a href="#cb113-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1546"><a href="#cb113-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1547"><a href="#cb113-1547" aria-hidden="true" tabindex="-1"></a>The event times for this individual are:</span>
<span id="cb113-1548"><a href="#cb113-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1549"><a href="#cb113-1549" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`t`</span> = 0 time of transplant</span>
<span id="cb113-1550"><a href="#cb113-1550" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`tp`</span> = 13 platelet recovery</span>
<span id="cb113-1551"><a href="#cb113-1551" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ta`</span> = 67 acute GVHD onset</span>
<span id="cb113-1552"><a href="#cb113-1552" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`tc`</span> = 121 chronic GVHD onset</span>
<span id="cb113-1553"><a href="#cb113-1553" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`t2`</span> = 2081 end of study, patient not relapsed or dead</span>
<span id="cb113-1554"><a href="#cb113-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1555"><a href="#cb113-1555" aria-hidden="true" tabindex="-1"></a>After converting the data to long-format, we have:</span>
<span id="cb113-1556"><a href="#cb113-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1559"><a href="#cb113-1559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1560"><a href="#cb113-1560" aria-hidden="true" tabindex="-1"></a>bmt2 <span class="sc">|&gt;</span> </span>
<span id="cb113-1561"><a href="#cb113-1561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb113-1562"><a href="#cb113-1562" aria-hidden="true" tabindex="-1"></a>    id,</span>
<span id="cb113-1563"><a href="#cb113-1563" aria-hidden="true" tabindex="-1"></a>    tstart,</span>
<span id="cb113-1564"><a href="#cb113-1564" aria-hidden="true" tabindex="-1"></a>    tstop,</span>
<span id="cb113-1565"><a href="#cb113-1565" aria-hidden="true" tabindex="-1"></a>    agvhd,</span>
<span id="cb113-1566"><a href="#cb113-1566" aria-hidden="true" tabindex="-1"></a>    cgvhd,</span>
<span id="cb113-1567"><a href="#cb113-1567" aria-hidden="true" tabindex="-1"></a>    precovery,</span>
<span id="cb113-1568"><a href="#cb113-1568" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb113-1569"><a href="#cb113-1569" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb113-1570"><a href="#cb113-1570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb113-1571"><a href="#cb113-1571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1572"><a href="#cb113-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1573"><a href="#cb113-1573" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`status`</span> could have been <span class="in">`1`</span> on the last row, indicating that</span>
<span id="cb113-1574"><a href="#cb113-1574" aria-hidden="true" tabindex="-1"></a>relapse or death occurred; since it is false, the participant must have</span>
<span id="cb113-1575"><a href="#cb113-1575" aria-hidden="true" tabindex="-1"></a>exited the study without experiencing relapse or death (i.e., they were</span>
<span id="cb113-1576"><a href="#cb113-1576" aria-hidden="true" tabindex="-1"></a>censored).</span>
<span id="cb113-1577"><a href="#cb113-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1578"><a href="#cb113-1578" aria-hidden="true" tabindex="-1"></a><span class="fu">## Event sequences</span></span>
<span id="cb113-1579"><a href="#cb113-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1580"><a href="#cb113-1580" aria-hidden="true" tabindex="-1"></a>Let:</span>
<span id="cb113-1581"><a href="#cb113-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1582"><a href="#cb113-1582" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A = acute GVHD</span>
<span id="cb113-1583"><a href="#cb113-1583" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>C = chronic GVHD</span>
<span id="cb113-1584"><a href="#cb113-1584" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>P = platelet recovery</span>
<span id="cb113-1585"><a href="#cb113-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1586"><a href="#cb113-1586" aria-hidden="true" tabindex="-1"></a>Each of the eight possible combinations of A or not-A, with C or not-C,</span>
<span id="cb113-1587"><a href="#cb113-1587" aria-hidden="true" tabindex="-1"></a>with P or not-P occurs in this data set.</span>
<span id="cb113-1588"><a href="#cb113-1588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1589"><a href="#cb113-1589" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A always occurs before C, and P always occurs before C, if both</span>
<span id="cb113-1590"><a href="#cb113-1590" aria-hidden="true" tabindex="-1"></a>    occur.</span>
<span id="cb113-1591"><a href="#cb113-1591" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Thus there are ten event sequences in the data set: None, A, C, P,</span>
<span id="cb113-1592"><a href="#cb113-1592" aria-hidden="true" tabindex="-1"></a>    AC, AP, PA, PC, APC, and PAC.</span>
<span id="cb113-1593"><a href="#cb113-1593" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In general, there could be as many as $1+3+(3)(2)+6=16$ sequences,</span>
<span id="cb113-1594"><a href="#cb113-1594" aria-hidden="true" tabindex="-1"></a>    but our domain knowledge tells us that some are missing: CA, CP,</span>
<span id="cb113-1595"><a href="#cb113-1595" aria-hidden="true" tabindex="-1"></a>    CAP, CPA, PCA, PC, PAC</span>
<span id="cb113-1596"><a href="#cb113-1596" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Different subjects could have 1, 2, 3, or 4 intervals, depending on</span>
<span id="cb113-1597"><a href="#cb113-1597" aria-hidden="true" tabindex="-1"></a>    which of acute GVHD, chronic GVHD, and/or platelet recovery</span>
<span id="cb113-1598"><a href="#cb113-1598" aria-hidden="true" tabindex="-1"></a>    occurred.</span>
<span id="cb113-1599"><a href="#cb113-1599" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The final interval for any subject has <span class="in">`status`</span> = 1 if the subject</span>
<span id="cb113-1600"><a href="#cb113-1600" aria-hidden="true" tabindex="-1"></a>    relapsed or died at that time; otherwise <span class="in">`status`</span> = 0.</span>
<span id="cb113-1601"><a href="#cb113-1601" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Any earlier intervals have <span class="in">`status`</span> = 0.</span>
<span id="cb113-1602"><a href="#cb113-1602" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Even though there might be multiple lines per ID in the dataset,</span>
<span id="cb113-1603"><a href="#cb113-1603" aria-hidden="true" tabindex="-1"></a>    there is never more than one event, so no alterations need be made</span>
<span id="cb113-1604"><a href="#cb113-1604" aria-hidden="true" tabindex="-1"></a>    in the estimation procedures or in the interpretation of the output.</span>
<span id="cb113-1605"><a href="#cb113-1605" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The function <span class="in">`tmerge`</span> in the <span class="in">`survival`</span> package eases the process of</span>
<span id="cb113-1606"><a href="#cb113-1606" aria-hidden="true" tabindex="-1"></a>    constructing the new long-format dataset.</span>
<span id="cb113-1607"><a href="#cb113-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1608"><a href="#cb113-1608" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model with Time-Fixed Covariates</span></span>
<span id="cb113-1609"><a href="#cb113-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1612"><a href="#cb113-1612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1613"><a href="#cb113-1613" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="ot">=</span> </span>
<span id="cb113-1614"><a href="#cb113-1614" aria-hidden="true" tabindex="-1"></a>  bmt1 <span class="sc">|&gt;</span> </span>
<span id="cb113-1615"><a href="#cb113-1615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">surv =</span> <span class="fu">Surv</span>(t2,d3))</span>
<span id="cb113-1616"><a href="#cb113-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1617"><a href="#cb113-1617" aria-hidden="true" tabindex="-1"></a>bmt_coxph_TF <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-1618"><a href="#cb113-1618" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> group <span class="sc">+</span> <span class="st">`</span><span class="at">patient age</span><span class="st">`</span><span class="sc">*</span><span class="st">`</span><span class="at">donor age</span><span class="st">`</span> <span class="sc">+</span> FAB,</span>
<span id="cb113-1619"><a href="#cb113-1619" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bmt1)</span>
<span id="cb113-1620"><a href="#cb113-1620" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt_coxph_TF)</span>
<span id="cb113-1621"><a href="#cb113-1621" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(bmt_coxph_TF, <span class="at">test =</span> <span class="st">"Chisq"</span>)</span>
<span id="cb113-1622"><a href="#cb113-1622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1623"><a href="#cb113-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1626"><a href="#cb113-1626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1627"><a href="#cb113-1627" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Martingale residuals for `Donor age`"</span></span>
<span id="cb113-1628"><a href="#cb113-1628" aria-hidden="true" tabindex="-1"></a>bmt1<span class="sc">$</span>mres <span class="ot">=</span> </span>
<span id="cb113-1629"><a href="#cb113-1629" aria-hidden="true" tabindex="-1"></a>  bmt_coxph_TF <span class="sc">|&gt;</span> </span>
<span id="cb113-1630"><a href="#cb113-1630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(. <span class="sc">~</span> . <span class="sc">-</span> <span class="st">`</span><span class="at">donor age</span><span class="st">`</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1631"><a href="#cb113-1631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">residuals</span>(<span class="at">type=</span><span class="st">"martingale"</span>)</span>
<span id="cb113-1632"><a href="#cb113-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1633"><a href="#cb113-1633" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="sc">|&gt;</span> </span>
<span id="cb113-1634"><a href="#cb113-1634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="st">`</span><span class="at">donor age</span><span class="st">`</span>, <span class="at">y =</span> mres)) <span class="sc">+</span></span>
<span id="cb113-1635"><a href="#cb113-1635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb113-1636"><a href="#cb113-1636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"loess"</span>)) <span class="sc">+</span></span>
<span id="cb113-1637"><a href="#cb113-1637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"lm"</span>)) <span class="sc">+</span></span>
<span id="cb113-1638"><a href="#cb113-1638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb113-1639"><a href="#cb113-1639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Donor age"</span>) <span class="sc">+</span></span>
<span id="cb113-1640"><a href="#cb113-1640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Martingale Residuals"</span>) <span class="sc">+</span></span>
<span id="cb113-1641"><a href="#cb113-1641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span><span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">""</span>))</span>
<span id="cb113-1642"><a href="#cb113-1642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1643"><a href="#cb113-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1644"><a href="#cb113-1644" aria-hidden="true" tabindex="-1"></a>A more complex functional form for <span class="in">`donor age`</span> seems warranted; left as</span>
<span id="cb113-1645"><a href="#cb113-1645" aria-hidden="true" tabindex="-1"></a>an exercise for the reader.</span>
<span id="cb113-1646"><a href="#cb113-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1647"><a href="#cb113-1647" aria-hidden="true" tabindex="-1"></a>Now we will add the time-varying covariates:</span>
<span id="cb113-1648"><a href="#cb113-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1651"><a href="#cb113-1651" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1652"><a href="#cb113-1652" aria-hidden="true" tabindex="-1"></a><span class="co"># add counting process formulation of Surv():</span></span>
<span id="cb113-1653"><a href="#cb113-1653" aria-hidden="true" tabindex="-1"></a>bmt2 <span class="ot">=</span> </span>
<span id="cb113-1654"><a href="#cb113-1654" aria-hidden="true" tabindex="-1"></a>  bmt2 <span class="sc">|&gt;</span> </span>
<span id="cb113-1655"><a href="#cb113-1655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-1656"><a href="#cb113-1656" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv =</span> </span>
<span id="cb113-1657"><a href="#cb113-1657" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Surv</span>(</span>
<span id="cb113-1658"><a href="#cb113-1658" aria-hidden="true" tabindex="-1"></a>        <span class="at">time =</span> tstart,</span>
<span id="cb113-1659"><a href="#cb113-1659" aria-hidden="true" tabindex="-1"></a>        <span class="at">time2 =</span> tstop,</span>
<span id="cb113-1660"><a href="#cb113-1660" aria-hidden="true" tabindex="-1"></a>        <span class="at">event =</span> status,</span>
<span id="cb113-1661"><a href="#cb113-1661" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"counting"</span>))</span>
<span id="cb113-1662"><a href="#cb113-1662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1663"><a href="#cb113-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1664"><a href="#cb113-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1665"><a href="#cb113-1665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1666"><a href="#cb113-1666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1667"><a href="#cb113-1667" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model with Time-Dependent Covariates</span></span>
<span id="cb113-1668"><a href="#cb113-1668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1671"><a href="#cb113-1671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1672"><a href="#cb113-1672" aria-hidden="true" tabindex="-1"></a>bmt_coxph_TV <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-1673"><a href="#cb113-1673" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> </span>
<span id="cb113-1674"><a href="#cb113-1674" aria-hidden="true" tabindex="-1"></a>    surv <span class="sc">~</span> </span>
<span id="cb113-1675"><a href="#cb113-1675" aria-hidden="true" tabindex="-1"></a>    group <span class="sc">+</span> <span class="st">`</span><span class="at">patient age</span><span class="st">`</span><span class="sc">*</span><span class="st">`</span><span class="at">donor age</span><span class="st">`</span> <span class="sc">+</span> FAB <span class="sc">+</span> agvhd <span class="sc">+</span> cgvhd <span class="sc">+</span> precovery,</span>
<span id="cb113-1676"><a href="#cb113-1676" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bmt2)</span>
<span id="cb113-1677"><a href="#cb113-1677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1678"><a href="#cb113-1678" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt_coxph_TV)</span>
<span id="cb113-1679"><a href="#cb113-1679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1680"><a href="#cb113-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1681"><a href="#cb113-1681" aria-hidden="true" tabindex="-1"></a>Platelet recovery is highly significant.</span>
<span id="cb113-1682"><a href="#cb113-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1683"><a href="#cb113-1683" aria-hidden="true" tabindex="-1"></a>Neither acute GVHD (<span class="in">`agvhd`</span>) nor chronic GVHD (<span class="in">`cgvhd`</span>) has a</span>
<span id="cb113-1684"><a href="#cb113-1684" aria-hidden="true" tabindex="-1"></a>statistically significant effect here, nor are they significant in</span>
<span id="cb113-1685"><a href="#cb113-1685" aria-hidden="true" tabindex="-1"></a>models with the other one removed.</span>
<span id="cb113-1686"><a href="#cb113-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1689"><a href="#cb113-1689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1690"><a href="#cb113-1690" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(bmt_coxph_TV, .<span class="sc">~</span>.<span class="sc">-</span>agvhd) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb113-1691"><a href="#cb113-1691" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(bmt_coxph_TV, .<span class="sc">~</span>.<span class="sc">-</span>cgvhd) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb113-1692"><a href="#cb113-1692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1693"><a href="#cb113-1693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1694"><a href="#cb113-1694" aria-hidden="true" tabindex="-1"></a>Let's drop them both:</span>
<span id="cb113-1695"><a href="#cb113-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1698"><a href="#cb113-1698" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1699"><a href="#cb113-1699" aria-hidden="true" tabindex="-1"></a>bmt_coxph_TV2 <span class="ot">=</span> <span class="fu">update</span>(bmt_coxph_TV, . <span class="sc">~</span> . <span class="sc">-</span> agvhd <span class="sc">-</span>cgvhd)</span>
<span id="cb113-1700"><a href="#cb113-1700" aria-hidden="true" tabindex="-1"></a>bmt_coxph_TV2 <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb113-1701"><a href="#cb113-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1702"><a href="#cb113-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1703"><a href="#cb113-1703" aria-hidden="true" tabindex="-1"></a><span class="fu"># Recurrent Events</span></span>
<span id="cb113-1704"><a href="#cb113-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1705"><a href="#cb113-1705" aria-hidden="true" tabindex="-1"></a>(Adapted from Kleinbaum and Klein, Ch 8)</span>
<span id="cb113-1706"><a href="#cb113-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1707"><a href="#cb113-1707" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Sometimes an appropriate analysis requires consideration of</span>
<span id="cb113-1708"><a href="#cb113-1708" aria-hidden="true" tabindex="-1"></a>    recurrent events.</span>
<span id="cb113-1709"><a href="#cb113-1709" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A patient with arthritis may have more than one flareup. The same is</span>
<span id="cb113-1710"><a href="#cb113-1710" aria-hidden="true" tabindex="-1"></a>    true of many recurring-remitting diseases.</span>
<span id="cb113-1711"><a href="#cb113-1711" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In this case, we have more than one line in the data frame, but each</span>
<span id="cb113-1712"><a href="#cb113-1712" aria-hidden="true" tabindex="-1"></a>    line may have an event.</span>
<span id="cb113-1713"><a href="#cb113-1713" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We have to use a "robust" variance estimator to account for</span>
<span id="cb113-1714"><a href="#cb113-1714" aria-hidden="true" tabindex="-1"></a>    correlation of time-to-events within a patient.</span>
<span id="cb113-1715"><a href="#cb113-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1716"><a href="#cb113-1716" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bladder Cancer Data Set</span></span>
<span id="cb113-1717"><a href="#cb113-1717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1718"><a href="#cb113-1718" aria-hidden="true" tabindex="-1"></a>The bladder cancer dataset from Kleinbaum and Klein contains recurrent</span>
<span id="cb113-1719"><a href="#cb113-1719" aria-hidden="true" tabindex="-1"></a>event outcome information for eighty-six cancer patients followed for</span>
<span id="cb113-1720"><a href="#cb113-1720" aria-hidden="true" tabindex="-1"></a>the recurrence of bladder cancer tumor after transurethral surgical</span>
<span id="cb113-1721"><a href="#cb113-1721" aria-hidden="true" tabindex="-1"></a>excision (Byar and Green 1980). The exposure of interest is the effect</span>
<span id="cb113-1722"><a href="#cb113-1722" aria-hidden="true" tabindex="-1"></a>of the drug treatment of thiotepa. Control variables are the initial</span>
<span id="cb113-1723"><a href="#cb113-1723" aria-hidden="true" tabindex="-1"></a>number and initial size of tumors. The data layout is suitable for a</span>
<span id="cb113-1724"><a href="#cb113-1724" aria-hidden="true" tabindex="-1"></a>counting processes approach.</span>
<span id="cb113-1725"><a href="#cb113-1725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1726"><a href="#cb113-1726" aria-hidden="true" tabindex="-1"></a>This drug is still a possible choice for some patients. Another</span>
<span id="cb113-1727"><a href="#cb113-1727" aria-hidden="true" tabindex="-1"></a>therapeutic choice is Bacillus Calmette-Guerin (BCG), a live bacterium</span>
<span id="cb113-1728"><a href="#cb113-1728" aria-hidden="true" tabindex="-1"></a>related to cow tuberculosis.</span>
<span id="cb113-1729"><a href="#cb113-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1730"><a href="#cb113-1730" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data dictionary</span></span>
<span id="cb113-1731"><a href="#cb113-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1732"><a href="#cb113-1732" aria-hidden="true" tabindex="-1"></a>| Variable   | Definition                                         |</span>
<span id="cb113-1733"><a href="#cb113-1733" aria-hidden="true" tabindex="-1"></a>|------------|----------------------------------------------------|</span>
<span id="cb113-1734"><a href="#cb113-1734" aria-hidden="true" tabindex="-1"></a>| <span class="in">`id`</span>       | Patient unique ID                                  |</span>
<span id="cb113-1735"><a href="#cb113-1735" aria-hidden="true" tabindex="-1"></a>| <span class="in">`status`</span>   | for each time interval: 1 = recurred, 0 = censored |</span>
<span id="cb113-1736"><a href="#cb113-1736" aria-hidden="true" tabindex="-1"></a>| <span class="in">`interval`</span> | 1 = first recurrence, etc.                         |</span>
<span id="cb113-1737"><a href="#cb113-1737" aria-hidden="true" tabindex="-1"></a>| <span class="in">`intime`</span>   | <span class="sc">\`</span><span class="in">`tstop - tstart`</span> (all times in months)           |</span>
<span id="cb113-1738"><a href="#cb113-1738" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tstart`</span>   | start of interval                                  |</span>
<span id="cb113-1739"><a href="#cb113-1739" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tstop`</span>    | end of interval                                    |</span>
<span id="cb113-1740"><a href="#cb113-1740" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tx`</span>       | treatment code, 1 = thiotepa                       |</span>
<span id="cb113-1741"><a href="#cb113-1741" aria-hidden="true" tabindex="-1"></a>| <span class="in">`num`</span>      | number of initial tumors                           |</span>
<span id="cb113-1742"><a href="#cb113-1742" aria-hidden="true" tabindex="-1"></a>| <span class="in">`size`</span>     | size of initial tumors (cm)                        |</span>
<span id="cb113-1743"><a href="#cb113-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1744"><a href="#cb113-1744" aria-hidden="true" tabindex="-1"></a>: Variables in the <span class="in">`bladder`</span> dataset</span>
<span id="cb113-1745"><a href="#cb113-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1746"><a href="#cb113-1746" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>There are 85 patients and 190 lines in the dataset, meaning that</span>
<span id="cb113-1747"><a href="#cb113-1747" aria-hidden="true" tabindex="-1"></a>    many patients have more than one line.</span>
<span id="cb113-1748"><a href="#cb113-1748" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Patient 1 with 0 observation time was removed.</span>
<span id="cb113-1749"><a href="#cb113-1749" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Of the 85 patients, 47 had at least one recurrence and 38 had none.</span>
<span id="cb113-1750"><a href="#cb113-1750" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>18 patients had exactly one recurrence.</span>
<span id="cb113-1751"><a href="#cb113-1751" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>There were up to 4 recurrences in a patient.</span>
<span id="cb113-1752"><a href="#cb113-1752" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Of the 190 intervals, 112 terminated with a recurrence and 78 were</span>
<span id="cb113-1753"><a href="#cb113-1753" aria-hidden="true" tabindex="-1"></a>    censored.</span>
<span id="cb113-1754"><a href="#cb113-1754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1755"><a href="#cb113-1755" aria-hidden="true" tabindex="-1"></a><span class="fu">### Different intervals for the same patient are correlated.</span></span>
<span id="cb113-1756"><a href="#cb113-1756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1757"><a href="#cb113-1757" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Is the effective sample size 47 or 112? This might narrow confidence</span>
<span id="cb113-1758"><a href="#cb113-1758" aria-hidden="true" tabindex="-1"></a>    intervals by as much as a factor of $\sqrt{112/47}=1.54$</span>
<span id="cb113-1759"><a href="#cb113-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1760"><a href="#cb113-1760" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>What happens if I have 5 treatment and 5 control values and want to</span>
<span id="cb113-1761"><a href="#cb113-1761" aria-hidden="true" tabindex="-1"></a>    do a t-test and I then duplicate the 10 values as if the sample size</span>
<span id="cb113-1762"><a href="#cb113-1762" aria-hidden="true" tabindex="-1"></a>    was 20? This falsely narrows confidence intervals by a factor of</span>
<span id="cb113-1763"><a href="#cb113-1763" aria-hidden="true" tabindex="-1"></a>    $\sqrt{2}=1.41$.</span>
<span id="cb113-1764"><a href="#cb113-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1767"><a href="#cb113-1767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1768"><a href="#cb113-1768" aria-hidden="true" tabindex="-1"></a>bladder <span class="ot">=</span> </span>
<span id="cb113-1769"><a href="#cb113-1769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(</span>
<span id="cb113-1770"><a href="#cb113-1770" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets"</span>,</span>
<span id="cb113-1771"><a href="#cb113-1771" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/surv2datasets/bladder.dta"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb113-1772"><a href="#cb113-1772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_dta</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-1773"><a href="#cb113-1773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb113-1774"><a href="#cb113-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1775"><a href="#cb113-1775" aria-hidden="true" tabindex="-1"></a>bladder <span class="ot">=</span> bladder[<span class="sc">-</span><span class="dv">1</span>,]  <span class="co">#remove subject with 0 observation time</span></span>
<span id="cb113-1776"><a href="#cb113-1776" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bladder)</span>
<span id="cb113-1777"><a href="#cb113-1777" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1778"><a href="#cb113-1778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1781"><a href="#cb113-1781" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1782"><a href="#cb113-1782" aria-hidden="true" tabindex="-1"></a>bladder <span class="ot">=</span> </span>
<span id="cb113-1783"><a href="#cb113-1783" aria-hidden="true" tabindex="-1"></a>  bladder <span class="sc">|&gt;</span> </span>
<span id="cb113-1784"><a href="#cb113-1784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-1785"><a href="#cb113-1785" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv =</span> </span>
<span id="cb113-1786"><a href="#cb113-1786" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Surv</span>(</span>
<span id="cb113-1787"><a href="#cb113-1787" aria-hidden="true" tabindex="-1"></a>        <span class="at">time=</span>start,</span>
<span id="cb113-1788"><a href="#cb113-1788" aria-hidden="true" tabindex="-1"></a>        <span class="at">time2=</span>stop,</span>
<span id="cb113-1789"><a href="#cb113-1789" aria-hidden="true" tabindex="-1"></a>        <span class="at">event=</span>event,</span>
<span id="cb113-1790"><a href="#cb113-1790" aria-hidden="true" tabindex="-1"></a>        <span class="at">type=</span><span class="st">"counting"</span>))</span>
<span id="cb113-1791"><a href="#cb113-1791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1792"><a href="#cb113-1792" aria-hidden="true" tabindex="-1"></a>bladder.cox1 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-1793"><a href="#cb113-1793" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv<span class="sc">~</span>tx<span class="sc">+</span>num<span class="sc">+</span>size,</span>
<span id="cb113-1794"><a href="#cb113-1794" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bladder)</span>
<span id="cb113-1795"><a href="#cb113-1795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1796"><a href="#cb113-1796" aria-hidden="true" tabindex="-1"></a><span class="co">#results with biased variance-covariance matrix:</span></span>
<span id="cb113-1797"><a href="#cb113-1797" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bladder.cox1)</span>
<span id="cb113-1798"><a href="#cb113-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1799"><a href="#cb113-1799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1800"><a href="#cb113-1800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1801"><a href="#cb113-1801" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb113-1802"><a href="#cb113-1802" aria-hidden="true" tabindex="-1"></a>The likelihood ratio and score tests assume independence of observations</span>
<span id="cb113-1803"><a href="#cb113-1803" aria-hidden="true" tabindex="-1"></a>within a cluster. The Wald and robust score tests do not.</span>
<span id="cb113-1804"><a href="#cb113-1804" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb113-1805"><a href="#cb113-1805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1806"><a href="#cb113-1806" aria-hidden="true" tabindex="-1"></a><span class="fu">### adding `cluster = id`</span></span>
<span id="cb113-1807"><a href="#cb113-1807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1808"><a href="#cb113-1808" aria-hidden="true" tabindex="-1"></a>If we add <span class="in">`cluster= id`</span> to the call to <span class="in">`coxph`</span>, the coefficient</span>
<span id="cb113-1809"><a href="#cb113-1809" aria-hidden="true" tabindex="-1"></a>estimates don't change, but we get an additional column in the</span>
<span id="cb113-1810"><a href="#cb113-1810" aria-hidden="true" tabindex="-1"></a><span class="in">`summary()`</span> output: <span class="in">`robust se`</span>:</span>
<span id="cb113-1811"><a href="#cb113-1811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1814"><a href="#cb113-1814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1815"><a href="#cb113-1815" aria-hidden="true" tabindex="-1"></a>bladder.cox2 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb113-1816"><a href="#cb113-1816" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> surv <span class="sc">~</span> tx <span class="sc">+</span> num <span class="sc">+</span> size,</span>
<span id="cb113-1817"><a href="#cb113-1817" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> id,</span>
<span id="cb113-1818"><a href="#cb113-1818" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bladder)</span>
<span id="cb113-1819"><a href="#cb113-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1820"><a href="#cb113-1820" aria-hidden="true" tabindex="-1"></a><span class="co">#unbiased though this reduces power:</span></span>
<span id="cb113-1821"><a href="#cb113-1821" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bladder.cox2)</span>
<span id="cb113-1822"><a href="#cb113-1822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1823"><a href="#cb113-1823" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1824"><a href="#cb113-1824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1825"><a href="#cb113-1825" aria-hidden="true" tabindex="-1"></a><span class="in">`robust se`</span> is larger than <span class="in">`se`</span>, and accounts for the repeated</span>
<span id="cb113-1826"><a href="#cb113-1826" aria-hidden="true" tabindex="-1"></a>observations from the same individuals:</span>
<span id="cb113-1827"><a href="#cb113-1827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1830"><a href="#cb113-1830" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1831"><a href="#cb113-1831" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(bladder.cox2<span class="sc">$</span>naive.var, <span class="dv">4</span>)</span>
<span id="cb113-1832"><a href="#cb113-1832" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(bladder.cox2<span class="sc">$</span>var, <span class="dv">4</span>)</span>
<span id="cb113-1833"><a href="#cb113-1833" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1834"><a href="#cb113-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1835"><a href="#cb113-1835" aria-hidden="true" tabindex="-1"></a>These are the ratios of correct confidence intervals to naive ones:</span>
<span id="cb113-1836"><a href="#cb113-1836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1839"><a href="#cb113-1839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1840"><a href="#cb113-1840" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(bladder.cox2, <span class="fu">diag</span>(var)<span class="sc">/</span><span class="fu">diag</span>(naive.var)) <span class="sc">|&gt;</span> <span class="fu">sqrt</span>()</span>
<span id="cb113-1841"><a href="#cb113-1841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1842"><a href="#cb113-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1843"><a href="#cb113-1843" aria-hidden="true" tabindex="-1"></a>We might try dropping the non-significant <span class="in">`size`</span> variable:</span>
<span id="cb113-1844"><a href="#cb113-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1847"><a href="#cb113-1847" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb113-1848"><a href="#cb113-1848" aria-hidden="true" tabindex="-1"></a><span class="co">#remove non-significant size variable:</span></span>
<span id="cb113-1849"><a href="#cb113-1849" aria-hidden="true" tabindex="-1"></a>bladder.cox3 <span class="ot">=</span> bladder.cox2 <span class="sc">|&gt;</span> <span class="fu">update</span>(. <span class="sc">~</span> . <span class="sc">-</span> size)</span>
<span id="cb113-1850"><a href="#cb113-1850" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bladder.cox3)</span>
<span id="cb113-1851"><a href="#cb113-1851" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb113-1852"><a href="#cb113-1852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1853"><a href="#cb113-1853" aria-hidden="true" tabindex="-1"></a>::: hidden</span>
<span id="cb113-1854"><a href="#cb113-1854" aria-hidden="true" tabindex="-1"></a>Ways to check PH assumption:</span>
<span id="cb113-1855"><a href="#cb113-1855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-1856"><a href="#cb113-1856" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>cloglog</span>
<span id="cb113-1857"><a href="#cb113-1857" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>schoenfeld residuals</span>
<span id="cb113-1858"><a href="#cb113-1858" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>interaction with time</span>
<span id="cb113-1859"><a href="#cb113-1859" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>