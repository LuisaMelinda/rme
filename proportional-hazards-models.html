<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Regression Models for Epidemiology - 6&nbsp; Proportional Hazards Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./coxph-model-building.html" rel="next">
<link href="./intro-to-survival-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./proportional-hazards-models.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Regression Models for Epidemiology</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/d-morrison/rme" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-GLMs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Statistical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalized Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linear-models-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Linear (Gaussian) Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Logistic Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./count-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Models for Count Outcomes</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./time-to-event-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time to Event Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-survival-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./proportional-hazards-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coxph-model-building.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric-survival-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#configuring-r" id="toc-configuring-r" class="nav-link active" data-scroll-target="#configuring-r">Configuring R</a></li>
  <li>
<a href="#the-proportional-hazards-model" id="toc-the-proportional-hazards-model" class="nav-link" data-scroll-target="#the-proportional-hazards-model"><span class="header-section-number">7</span> The proportional hazards model</a>
  <ul class="collapse">
<li><a href="#background-on-the-proportional-hazards-model" id="toc-background-on-the-proportional-hazards-model" class="nav-link" data-scroll-target="#background-on-the-proportional-hazards-model"><span class="header-section-number">7.1</span> Background on the Proportional Hazards Model</a></li>
  <li><a href="#coxs-proportional-hazards-model" id="toc-coxs-proportional-hazards-model" class="nav-link" data-scroll-target="#coxs-proportional-hazards-model"><span class="header-section-number">7.2</span> Cox’s Proportional Hazards Model</a></li>
  <li>
<a href="#additional-properties-of-the-proportional-hazards-model" id="toc-additional-properties-of-the-proportional-hazards-model" class="nav-link" data-scroll-target="#additional-properties-of-the-proportional-hazards-model"><span class="header-section-number">7.3</span> Additional properties of the proportional hazards model</a>
  <ul class="collapse">
<li><a href="#cumulative-hazards-are-also-proportional-to-h_0t" id="toc-cumulative-hazards-are-also-proportional-to-h_0t" class="nav-link" data-scroll-target="#cumulative-hazards-are-also-proportional-to-h_0t">Cumulative hazards are also proportional to <span class="math inline">\(H_0(t)\)</span></a></li>
  <li><a href="#survival-functions-are-exponential-multiples-of-s_0t" id="toc-survival-functions-are-exponential-multiples-of-s_0t" class="nav-link" data-scroll-target="#survival-functions-are-exponential-multiples-of-s_0t">Survival functions are exponential multiples of <span class="math inline">\(S_0(t)\)</span></a></li>
  </ul>
</li>
  <li><a href="#testing-the-proportional-hazards-assumption" id="toc-testing-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#testing-the-proportional-hazards-assumption"><span class="header-section-number">7.4</span> Testing the proportional hazards assumption</a></li>
  <li><a href="#smoothed-hazard-functions" id="toc-smoothed-hazard-functions" class="nav-link" data-scroll-target="#smoothed-hazard-functions"><span class="header-section-number">7.5</span> Smoothed hazard functions</a></li>
  <li><a href="#fitting-the-proportional-hazards-model" id="toc-fitting-the-proportional-hazards-model" class="nav-link" data-scroll-target="#fitting-the-proportional-hazards-model"><span class="header-section-number">7.6</span> Fitting the Proportional Hazards Model</a></li>
  </ul>
</li>
  <li>
<a href="#cox-model-for-the-bmt-data" id="toc-cox-model-for-the-bmt-data" class="nav-link" data-scroll-target="#cox-model-for-the-bmt-data"><span class="header-section-number">8</span> Cox Model for the <code>bmt</code> data</a>
  <ul class="collapse">
<li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model"><span class="header-section-number">8.1</span> Fit the model</a></li>
  <li><a href="#survival-curves-from-the-cox-model" id="toc-survival-curves-from-the-cox-model" class="nav-link" data-scroll-target="#survival-curves-from-the-cox-model"><span class="header-section-number">8.2</span> Survival Curves from the Cox Model</a></li>
  <li><a href="#examining-survfit" id="toc-examining-survfit" class="nav-link" data-scroll-target="#examining-survfit"><span class="header-section-number">8.3</span> Examining <code>survfit</code></a></li>
  </ul>
</li>
  <li>
<a href="#adjustment-for-ties-optional" id="toc-adjustment-for-ties-optional" class="nav-link" data-scroll-target="#adjustment-for-ties-optional"><span class="header-section-number">9</span> Adjustment for Ties (optional)</a>
  <ul class="collapse">
<li>
<a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">9.1</span> </a>
  <ul class="collapse">
<li><a href="#breslows-method-for-ties" id="toc-breslows-method-for-ties" class="nav-link" data-scroll-target="#breslows-method-for-ties">Breslow’s method for ties</a></li>
  <li><a href="#efrons-method-for-ties" id="toc-efrons-method-for-ties" class="nav-link" data-scroll-target="#efrons-method-for-ties">Efron’s method for ties</a></li>
  <li><a href="#example-breslows-method" id="toc-example-breslows-method" class="nav-link" data-scroll-target="#example-breslows-method">Example: Breslow’s method</a></li>
  <li><a href="#example-efrons-method" id="toc-example-efrons-method" class="nav-link" data-scroll-target="#example-efrons-method">Example: Efron’s method</a></li>
  </ul>
</li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/d-morrison/rme/edit/main/proportional-hazards-models.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified: 2023-07-07: 20:12:44 (PM)</p>
    </div>
  </div>
  
    
  </div>
  

</header><div class="hidden">

</div>
<section id="configuring-r" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="configuring-r">Configuring R</h2>
<p>Functions from these packages will be used throughout this document:</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/packages_eb8a7877838ec6819c7dab412713e365">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/">pander</a></span><span class="op">)</span> <span class="co"># format tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> <span class="co"># graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonocarroll/ggeasy">ggeasy</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># manipulate data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span> <span class="co"># format R output for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span> <span class="co"># Tools to help to create tidy data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span> <span class="co"># interactive graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dobson</span><span class="op">)</span> <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span> <span class="co"># check for conflicting function definitions</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are some R settings I use in this document:</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/options_f9eee48aeb59e9d6a0af315933a158d5">
<details><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># delete any data that's already loaded into R</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="st">'digits'</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="the-proportional-hazards-model" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> The proportional hazards model</h1>
<section id="background-on-the-proportional-hazards-model" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="background-on-the-proportional-hazards-model">
<span class="header-section-number">7.1</span> Background on the Proportional Hazards Model</h2>
<p>The exponential distribution has constant hazard:</p>
<p><span class="math display">\[
\begin{aligned}
f(t) &amp;= \lambda e^{-\lambda t}\\
S(t) &amp;= e^{-\lambda t}\\
h(t) &amp;= \lambda
\end{aligned}
\]</span></p>
<p>Let’s make two generalizations. First, we let the hazard depend on some covariates <span class="math inline">\(x_1,x_2, \dots, x_p\)</span>; we will indicate this dependence by extending our notation for hazard:</p>
<p><span class="math display">\[h(t|\boldsymbol x) \stackrel{\text{def}}{=}p(T=t|T\ge t, \boldsymbol X = \boldsymbol x)\]</span></p>
<p>Second, we let the base hazard depend on <span class="math inline">\(t\)</span>, but not on the covariates (for now). We can do this using either parametric or semi-parametric approaches.</p>
</section><section id="coxs-proportional-hazards-model" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="coxs-proportional-hazards-model">
<span class="header-section-number">7.2</span> Cox’s Proportional Hazards Model</h2>
<p>The generalization is that the hazard function is</p>
<p><span class="math display">\[
\begin{aligned}
h(t|x)&amp;= h_0(t)\theta(x)\\
\theta(x) &amp;= \exp\{\eta(x)\}\\
\eta(x) &amp;= x'\beta\\
&amp;\stackrel{\text{def}}{=}\beta_1x_1+\cdots+\beta_px_p
\end{aligned}
\]</span></p>
<p>The relationship between <span class="math inline">\(h(t|x)\)</span> and <span class="math inline">\(\eta(x)\)</span> has a log link (that is, <span class="math inline">\(\log\{h(t|x)\} = \log\{h_0(t)\} + \eta(x)\)</span>), as in a generalized linear model.</p>
<p>This model is <strong>semi-parametric</strong>, because the linear predictor depends on estimated parameters but the base hazard function is unspecified. There is no constant term in <span class="math inline">\(\eta(x)\)</span>, because it is absorbed in the base hazard.</p>
<p>Alternatively, we could define <span class="math inline">\(\beta_0(t) = \log\{h_0(t)\}\)</span>, and then <span class="math inline">\(\eta(x,t) = \beta_0(t) + \beta_1x_1+\cdots+\beta_px_p\)</span>.</p>
<p>For two different individuals with covariate patterns <span class="math inline">\(\boldsymbol x_1\)</span> and <span class="math inline">\(\boldsymbol x_2\)</span>, the ratio of the hazard functions (a.k.a. <strong>hazard ratio</strong>, a.k.a. <strong>relative hazard</strong>) is:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
&amp;=\frac{h_0(t)\theta(\boldsymbol x_1)}{h_0(t)\theta(\boldsymbol x_2)}\\
&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\\
\end{aligned}
\]</span></p>
<p>Under the proportional hazards model, this ratio (a.k.a. proportion) does not depend on <span class="math inline">\(t\)</span>. This property is a structural limitation of the model; it is called the <strong>proportional hazards assumption</strong>.</p>
<div id="def-pha" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.1 (proportional hazards) </strong></span>A conditional probability distribution <span class="math inline">\(p(T|X)\)</span> has <strong>proportional hazards</strong> if the hazard ratio <span class="math inline">\(h(t|\boldsymbol x_1)/h(t|\boldsymbol x_2)\)</span> does not depend on <span class="math inline">\(t\)</span>. Mathematically, it can be written as:</p>
<p><span class="math display">\[
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
= \theta(\boldsymbol x_1,\boldsymbol x_2)
\]</span></p>
</div>
<p>As we saw above, Cox’s proportional hazards model has this property, with <span class="math inline">\(\theta(\boldsymbol x_1,\boldsymbol x_2) = \frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are using two similar notations, <span class="math inline">\(\theta(\boldsymbol x_1,\boldsymbol x_2)\)</span> and <span class="math inline">\(\theta(\boldsymbol x)\)</span>. We can link these notations if we define <span class="math inline">\(\theta(\boldsymbol x) \stackrel{\text{def}}{=}\theta(\boldsymbol x, \boldsymbol 0)\)</span> and <span class="math inline">\(\theta(\boldsymbol 0) = 1\)</span>.</p>
</div>
</div>
<p>It also has additional notable properties:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}
&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}\\
&amp;=\frac{\exp\{\eta(\boldsymbol x_1)\}}{\exp\{\eta(\boldsymbol x_2)\}}\\
&amp;=\exp\{\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)\}\\
&amp;=\exp\{\boldsymbol x_1'\beta-\boldsymbol x_2'\beta\}\\
&amp;=\exp\{(\boldsymbol x_1 - \boldsymbol x_2)'\beta\}\\
\end{aligned}
\]</span></p>
<p>Hence on the log scale, we have:</p>
<p><span class="math display">\[
\begin{aligned}
\log\left\{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right\}
&amp;=\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)\\
&amp;= \boldsymbol x_1'\beta-\boldsymbol x_2'\beta\\
&amp;= (\boldsymbol x_1 - \boldsymbol x_2)'\beta
\end{aligned}
\]</span></p>
<p>If only one covariate <span class="math inline">\(x_j\)</span> is changing, then:</p>
<p><span class="math display">\[
\begin{aligned}
\log\left\{\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right\}
&amp;=  (x_{1j} - x_{2j}) \cdot \beta_j\\
&amp;\propto (x_{1j} - x_{2j})
\end{aligned}
\]</span></p>
<p>That is, under Cox’s model <span class="math inline">\(h(t|\boldsymbol x) = h_0(t)\exp\{\boldsymbol x'\beta\}\)</span>, the log of the hazard ratio is proportional to the difference in <span class="math inline">\(x_j\)</span>, with the proportionality coefficient equal to <span class="math inline">\(\beta_j\)</span>.</p>
<p>Further,</p>
<p><span class="math display">\[
\begin{aligned}
\log\left\{h(t|\boldsymbol x)\right\}
&amp;=\log\left\{h_0(t)\right\}  + x'\beta
\end{aligned}
\]</span></p>
<p>That is, the covariate effects are additive on the log-hazard scale.</p>
<p>See also:</p>
<p><a href="https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22" class="uri">https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22</a></p>
</section><section id="additional-properties-of-the-proportional-hazards-model" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="additional-properties-of-the-proportional-hazards-model">
<span class="header-section-number">7.3</span> Additional properties of the proportional hazards model</h2>
<p>If <span class="math inline">\(h(t|x)= h_0(t)\theta(x)\)</span>, then:</p>
<section id="cumulative-hazards-are-also-proportional-to-h_0t" class="level3"><h3 class="anchored" data-anchor-id="cumulative-hazards-are-also-proportional-to-h_0t">Cumulative hazards are also proportional to <span class="math inline">\(H_0(t)\)</span>
</h3>
<p><span class="math display">\[
\begin{aligned}
H(t|x)
&amp;\stackrel{\text{def}}{=}\int_{u=0}^t h(u)du\\
&amp;= \int_{u=0}^t h_0(u)\theta(x)du\\
&amp;= \theta(x)\int_{u=0}^t h_0(u)du\\
&amp;= \theta(x)H_0(t)
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(H_0(t) \stackrel{\text{def}}{=}H(t|0) = \int_{u=0}^t h_0(u)du\)</span>.</p>
</section><section id="survival-functions-are-exponential-multiples-of-s_0t" class="level3"><h3 class="anchored" data-anchor-id="survival-functions-are-exponential-multiples-of-s_0t">Survival functions are exponential multiples of <span class="math inline">\(S_0(t)\)</span>
</h3>
<p><span class="math display">\[
\begin{aligned}
S(t|x)
&amp;= \exp\{-H(t|x)\}\\
&amp;= \exp\{-\theta(x)\cdot H_0(t)\}\\
&amp;= \left(\exp\{- H_0(t)\}\right)^{\theta(x)}\\
&amp;= \left(S_0(t)\right)^{\theta(x)}\\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(S_0(t) \stackrel{\text{def}}{=}P(T\ge t | \boldsymbol X = 0)\)</span> is the survival function for an individual whose covariates are all equal to their default values.</p>
</section></section><section id="testing-the-proportional-hazards-assumption" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="testing-the-proportional-hazards-assumption">
<span class="header-section-number">7.4</span> Testing the proportional hazards assumption</h2>
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard and often the cumulative hazard.</p>
<p>If the hazards of the three groups are proportional, that means that the ratio of the hazards is constant over <span class="math inline">\(t\)</span>. We can test this using the ratios of the estimated cumulative hazards, which also would be proportional, as shown above.</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-1_cb5770c115616c8df65d6088f20e3aaa">
<details><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">KMsurv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span> </span>
<span>      <span class="va">group</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nafit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming-harrington"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>timevec <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">sf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    cumhaz1 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf1</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz2 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf2</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz3 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf3</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-2_f0dcbb4c387a74340bd8bdc1ccf863ce">
<details><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">bmt_rel_hazard_plot</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">timevec</span>,</span>
<span>      y <span class="op">=</span> <span class="va">cumhaz1</span><span class="op">/</span><span class="va">cumhaz2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"ALL/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Hazard Ratio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz1</span>, col <span class="op">=</span> <span class="st">"High Risk AML/ALL"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz2</span>, col <span class="op">=</span> <span class="st">"High Risk AML/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Comparison"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">bmt_rel_hazard_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Hazard Ratios by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can zoom in on 30-300 days to take a closer look:</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-3_2527e3025f2708be4d7cdfe2ddf8854c">
<details><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_rel_hazard_plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 729 rows containing missing values (`geom_line()`).
Removed 729 rows containing missing values (`geom_line()`).
Removed 729 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Hazard Ratios by Disease Group (30-300 Days)</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="smoothed-hazard-functions" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="smoothed-hazard-functions">
<span class="header-section-number">7.5</span> Smoothed hazard functions</h2>
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard. Since the hazard is the derivative of the cumulative hazard, we need a smooth estimate of the cumulative hazard, which is provided by smoothing the step-function cumulative hazard.</p>
<p>The R package <code>muhaz</code> handles this for us. What we are looking for is whether the hazard function is more or less the same shape, increasing, decreasing, constant, etc. Are the hazards “proportional”?</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-4_54db66fbd3f7ee42293871d46b6c1580">
<details><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span>,</span>
<span>  col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>  lwd<span class="op">=</span><span class="fl">2</span>,</span>
<span>  fun<span class="op">=</span><span class="st">"cumhaz"</span>,</span>
<span>  mark.time <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Disease-Free Cumulative Hazard by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-5_2b271091b769caf4d7bdf82f1c88e43a">
<details><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">muhaz</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"High Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"ALL"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"Low Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption class="figure-caption">Smoothed Hazard Rate Estimates by Disease Group</figcaption><p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Group 3 was plotted first because it has the highest hazard.</p>
<p>We will see that except for an initial blip in the high risk AML group, the hazards look roughly proportional . They are all strongly decreasing.</p>
</section><section id="fitting-the-proportional-hazards-model" class="level2" data-number="7.6"><h2 data-number="7.6" class="anchored" data-anchor-id="fitting-the-proportional-hazards-model">
<span class="header-section-number">7.6</span> Fitting the Proportional Hazards Model</h2>
<p>How do we fit a proportional hazards regression model? We need to estimate the coefficients of the covariates, and we need to estimate the base hazard <span class="math inline">\(h_0(t)\)</span>. For the covariates, supposing for simplicity that there are no tied event times, let the event times for the whole data set be <span class="math inline">\(t_1, t_2,\ldots,t_D\)</span>. Let the risk set at time <span class="math inline">\(t_i\)</span> be <span class="math inline">\(R(t_i)\)</span> and</p>
<p><span class="math display">\[
\begin{aligned}
\eta(\boldsymbol{x}) &amp;= \beta_1x_{1}+\cdots+\beta_p x_{p}\\
\theta(\boldsymbol{x}) &amp;= e^{\eta(\boldsymbol{x})}\\
h(t|X=x)&amp;= h_0(t)e^{\eta(\boldsymbol{x})}=\theta(\boldsymbol{x}) h_0(t)
\end{aligned}
\]</span></p>
<p>Conditional on a single failure at time <span class="math inline">\(t\)</span>, the probability that the event is due to subject <span class="math inline">\(f\in R(t)\)</span> is approximately</p>
<p><span class="math display">\[
\begin{aligned}
\Pr(f \text{ fails}|\text{1 failure at } t)
&amp;= \frac{h_0(t)e^{\eta(\boldsymbol{x}_f)}}{\sum_{k \in R(t)}h_0(t)e^{\eta(\boldsymbol{x}_f)}}\\
&amp;=\frac{\theta(\boldsymbol{x}_f)}{\sum_{k \in R(t)} \theta(\boldsymbol{x}_k)}
\end{aligned}
\]</span></p>
<p>The logic behind this has several steps. We first fix (ex post) the failure times and note that in this discrete context, the probability <span class="math inline">\(p_j\)</span> that a subject <span class="math inline">\(j\)</span> in the risk set fails at time <span class="math inline">\(t\)</span> is just the hazard of that subject at that time.</p>
<p>If all of the <span class="math inline">\(p_j\)</span> are small, the chance that exactly one subject fails is</p>
<p><span class="math display">\[
\sum_{k\in R(t)}p_k\left[\prod_{m\in R(t), m\ne k} (1-p_m)\right]\approx\sum_{k\in R(t)}p_k
\]</span></p>
<p>If subject <span class="math inline">\(i\)</span> is the one who experiences the event of interest at time <span class="math inline">\(t_i\)</span>, then the <strong>partial likelihood</strong> is</p>
<p><span class="math display">\[
\mathcal L^*(\beta|T)=
\prod_i \frac{\theta(x_i)}{\sum_{k \in R(t_i)} \theta(\boldsymbol{x}_k)}
\]</span></p>
<p>and we can numerically maximize this with respect to the coefficients <span class="math inline">\(\boldsymbol{\beta}\)</span> that specify <span class="math inline">\(\eta(\boldsymbol{x}) = \boldsymbol{x}'\boldsymbol{\beta}\)</span>. When there are tied event times adjustments need to be made, but the likelihood is still similar. Note that we don’t need to know the base hazard to solve for the coefficients.</p>
<p>Once we have coefficient estimates <span class="math inline">\(\hat{\boldsymbol{\beta}} =(\hat \beta_1,\ldots,\hat\beta_p)\)</span>, this also defines <span class="math inline">\(\hat\eta(x)\)</span> and <span class="math inline">\(\hat\theta(x)\)</span> and then the estimated base cumulative hazard function is <span class="math display">\[\hat H(t)=
\sum_{t_i &lt; t} \frac{d_i}{\sum_{k\in R(t_i)} \theta(x_k)}\]</span> which reduces to the Nelson-Aalen estimate when there are no covariates. There are numerous other estimates that have been proposed as well.</p>
</section></section><section id="cox-model-for-the-bmt-data" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Cox Model for the <code>bmt</code> data</h1>
<section id="fit-the-model" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="fit-the-model">
<span class="header-section-number">8.1</span> Fit the model</h2>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-6_3e23a21c25cf6229c9623878973607e2">
<details><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt.cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(t2, d3) ~ group, data = bmt)

  n= 137, number of events= 83 

                     coef exp(coef) se(coef)     z Pr(&gt;|z|)  
groupLow Risk AML  -0.574     0.563    0.287 -2.00    0.046 *
groupHigh Risk AML  0.383     1.467    0.267  1.43    0.152  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                   exp(coef) exp(-coef) lower .95 upper .95
groupLow Risk AML      0.563      1.776     0.321     0.989
groupHigh Risk AML     1.467      0.682     0.869     2.478

Concordance= 0.625  (se = 0.03 )
Likelihood ratio test= 13.4  on 2 df,   p=0.001
Wald test            = 13  on 2 df,   p=0.001
Score (logrank) test = 13.8  on 2 df,   p=0.001</code></pre>
</div>
</div>
<p>The table provides hypothesis tests comparing groups 2 and 3 to group 1. Group 3 has the highest hazard, so the most significant comparison is not directly shown.</p>
<p>The coefficient 0.3834 is on the log-hazard-ratio scale, as in log-risk-ratio. The next column gives the hazard ratio 1.4673, and a hypothesis (Wald) test.</p>
<p>The (not shown) group 3 vs.&nbsp;group 2 log hazard ratio is 0.3834 + 0.5742 = 0.9576. The hazard ratio is then exp(0.9576) or 2.605.</p>
<p>Inference on all coefficients and combinations can be constructed using <code>coef(bmt.cox)</code> and <code>vcov(bmt.cox)</code> as with logistic and poisson regression.</p>
<p><strong>Concordance</strong> is agreement of first failure between pairs of subjects and higher predicted risk between those subjects, omitting non-informative pairs.</p>
<p>The Rsquare value is Cox and Snell’s pseudo R-squared and is not very useful.</p>
<p><code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> prints three tests for whether the model with the group covariate is better than the one without</p>
<ul>
<li>
<code>Likelihood ratio test</code> (chi-squared)</li>
<li>
<code>Wald test</code> (also chi-squared), obtained by adding the squares of the z-scores</li>
<li>
<code>Score</code> = log-rank test, as with comparison of survival functions.</li>
</ul>
<p>The likelihood ratio test is probably best in smaller samples, followed by the Wald test.</p>
</section><section id="survival-curves-from-the-cox-model" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="survival-curves-from-the-cox-model">
<span class="header-section-number">8.2</span> Survival Curves from the Cox Model</h2>
<p>We can take a look at the resulting group-specific curves:</p>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-7_44e49c4eafd184844de2a0fad6290345">
<details><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#| fig-cap: "Survival Functions for Three Groups by KM and Cox Model"</span></span>
<span></span>
<span><span class="va">km_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cox_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  <span class="va">bmt.cox</span>, </span>
<span>  newdata <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>, </span>
<span>      row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>KM <span class="op">=</span> <span class="va">km_fit</span>, Cox <span class="op">=</span> <span class="va">cox_fit</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>    <span class="co"># facet.by = "group",</span></span>
<span>    legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    combine <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    fun <span class="op">=</span> <span class="st">'pct'</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>    ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    censor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>When we use <code><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit()</a></code> with a Cox model, we have to specify the covariate levels we are interested in; the argument <code>newdata</code> should include a <code>data.frame</code> with the same named columns as the predictors in the Cox model and one or more levels of each.</p>
<p>Otherwise (that is, if the <code>newdata</code> argument is missing), a curve is produced for a single “pseudo” subject with covariate values equal to the means component of the fit.</p>
<p>The resulting curve(s) almost never make sense, but the default remains due to an unwarranted attachment to the option shown by some users and by other packages.</p>
<p>Two particularly egregious examples are factor variables and interactions. Suppose one were studying interspecies transmission of a virus, and the data set has a factor variable with levels (“pig”, “chicken”) and about equal numbers of observations for each. The “mean” covariate level will be 0.5 – is this a flying pig?</p>
</section><section id="examining-survfit" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="examining-survfit">
<span class="header-section-number">8.3</span> Examining <code>survfit</code>
</h2>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-8_3f012a71299c03b2cfb6d9b0d31f2f51">
<details><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)

                     n events median 0.95LCL 0.95UCL
group=ALL           38     24    418     194      NA
group=Low Risk AML  54     25   2204     704      NA
group=High Risk AML 45     34    183     115     456</code></pre>
</div>
</div>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-9_9b9d65800d45983e95aa159d68783604">
<details><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span><span class="op">~</span><span class="va">group</span>,data<span class="op">=</span><span class="va">bmt</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)

                group=ALL 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1     38       1    0.974  0.0260        0.924        1.000
   55     37       1    0.947  0.0362        0.879        1.000
   74     36       1    0.921  0.0437        0.839        1.000
   86     35       1    0.895  0.0498        0.802        0.998
  104     34       1    0.868  0.0548        0.767        0.983
  107     33       1    0.842  0.0592        0.734        0.966
  109     32       1    0.816  0.0629        0.701        0.949
  110     31       1    0.789  0.0661        0.670        0.930
  122     30       2    0.737  0.0714        0.609        0.891
  129     28       1    0.711  0.0736        0.580        0.870
  172     27       1    0.684  0.0754        0.551        0.849
  192     26       1    0.658  0.0770        0.523        0.827
  194     25       1    0.632  0.0783        0.495        0.805
  230     23       1    0.604  0.0795        0.467        0.782
  276     22       1    0.577  0.0805        0.439        0.758
  332     21       1    0.549  0.0812        0.411        0.734
  383     20       1    0.522  0.0817        0.384        0.709
  418     19       1    0.494  0.0819        0.357        0.684
  466     18       1    0.467  0.0818        0.331        0.658
  487     17       1    0.439  0.0815        0.305        0.632
  526     16       1    0.412  0.0809        0.280        0.605
  609     14       1    0.382  0.0803        0.254        0.577
  662     13       1    0.353  0.0793        0.227        0.548

                group=Low Risk AML 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
   10     54       1    0.981  0.0183        0.946        1.000
   35     53       1    0.963  0.0257        0.914        1.000
   48     52       1    0.944  0.0312        0.885        1.000
   53     51       1    0.926  0.0356        0.859        0.998
   79     50       1    0.907  0.0394        0.833        0.988
   80     49       1    0.889  0.0428        0.809        0.977
  105     48       1    0.870  0.0457        0.785        0.965
  211     47       1    0.852  0.0483        0.762        0.952
  219     46       1    0.833  0.0507        0.740        0.939
  248     45       1    0.815  0.0529        0.718        0.925
  272     44       1    0.796  0.0548        0.696        0.911
  288     43       1    0.778  0.0566        0.674        0.897
  381     42       1    0.759  0.0582        0.653        0.882
  390     41       1    0.741  0.0596        0.633        0.867
  414     40       1    0.722  0.0610        0.612        0.852
  421     39       1    0.704  0.0621        0.592        0.837
  481     38       1    0.685  0.0632        0.572        0.821
  486     37       1    0.667  0.0642        0.552        0.805
  606     36       1    0.648  0.0650        0.533        0.789
  641     35       1    0.630  0.0657        0.513        0.773
  704     34       1    0.611  0.0663        0.494        0.756
  748     33       1    0.593  0.0669        0.475        0.739
 1063     26       1    0.570  0.0681        0.451        0.720
 1074     25       1    0.547  0.0691        0.427        0.701
 2204      6       1    0.456  0.1012        0.295        0.704

                group=High Risk AML 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    2     45       1    0.978  0.0220        0.936        1.000
   16     44       1    0.956  0.0307        0.897        1.000
   32     43       1    0.933  0.0372        0.863        1.000
   47     42       2    0.889  0.0468        0.802        0.986
   48     40       1    0.867  0.0507        0.773        0.972
   63     39       1    0.844  0.0540        0.745        0.957
   64     38       1    0.822  0.0570        0.718        0.942
   74     37       1    0.800  0.0596        0.691        0.926
   76     36       1    0.778  0.0620        0.665        0.909
   80     35       1    0.756  0.0641        0.640        0.892
   84     34       1    0.733  0.0659        0.615        0.875
   93     33       1    0.711  0.0676        0.590        0.857
  100     32       1    0.689  0.0690        0.566        0.838
  105     31       1    0.667  0.0703        0.542        0.820
  113     30       1    0.644  0.0714        0.519        0.801
  115     29       1    0.622  0.0723        0.496        0.781
  120     28       1    0.600  0.0730        0.473        0.762
  157     27       1    0.578  0.0736        0.450        0.742
  162     26       1    0.556  0.0741        0.428        0.721
  164     25       1    0.533  0.0744        0.406        0.701
  168     24       1    0.511  0.0745        0.384        0.680
  183     23       1    0.489  0.0745        0.363        0.659
  242     22       1    0.467  0.0744        0.341        0.638
  268     21       1    0.444  0.0741        0.321        0.616
  273     20       1    0.422  0.0736        0.300        0.594
  318     19       1    0.400  0.0730        0.280        0.572
  363     18       1    0.378  0.0723        0.260        0.550
  390     17       1    0.356  0.0714        0.240        0.527
  422     16       1    0.333  0.0703        0.221        0.504
  456     15       1    0.311  0.0690        0.201        0.481
  467     14       1    0.289  0.0676        0.183        0.457
  625     13       1    0.267  0.0659        0.164        0.433
  677     12       1    0.244  0.0641        0.146        0.409</code></pre>
</div>
</div>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-10_afe8d22639c11a8cde9546923fe08002">
<details><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = bmt.cox)

       n events median 0.95LCL 0.95UCL
[1,] 137     83    422     268      NA</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))

    n events median 0.95LCL 0.95UCL
1 137     83    422     268      NA
2 137     83     NA     625      NA
3 137     83    268     162     467</code></pre>
</div>
</div>
<div class="cell" data-hash="proportional-hazards-models_cache/html/unnamed-chunk-11_9fe1bd20c7db61a1e248d972edee659a">
<details><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt.cox</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))

 time n.risk n.event survival1 survival2 survival3
    1    137       1     0.993     0.996     0.989
    2    136       1     0.985     0.992     0.978
   10    135       1     0.978     0.987     0.968
   16    134       1     0.970     0.983     0.957
   32    133       1     0.963     0.979     0.946
   35    132       1     0.955     0.975     0.935
   47    131       2     0.941     0.966     0.914
   48    129       2     0.926     0.957     0.893
   53    127       1     0.918     0.953     0.882
   55    126       1     0.911     0.949     0.872
   63    125       1     0.903     0.944     0.861
   64    124       1     0.896     0.940     0.851
   74    123       2     0.881     0.931     0.830
   76    121       1     0.873     0.926     0.819
   79    120       1     0.865     0.922     0.809
   80    119       2     0.850     0.913     0.788
   84    117       1     0.843     0.908     0.778
   86    116       1     0.835     0.903     0.768
   93    115       1     0.827     0.899     0.757
  100    114       1     0.820     0.894     0.747
  104    113       1     0.812     0.889     0.737
  105    112       2     0.797     0.880     0.717
  107    110       1     0.789     0.875     0.707
  109    109       1     0.782     0.870     0.697
  110    108       1     0.774     0.866     0.687
  113    107       1     0.766     0.861     0.677
  115    106       1     0.759     0.856     0.667
  120    105       1     0.751     0.851     0.657
  122    104       2     0.735     0.841     0.637
  129    102       1     0.727     0.836     0.627
  157    101       1     0.720     0.831     0.617
  162    100       1     0.712     0.826     0.607
  164     99       1     0.704     0.821     0.598
  168     98       1     0.696     0.815     0.588
  172     97       1     0.688     0.810     0.578
  183     96       1     0.680     0.805     0.568
  192     95       1     0.672     0.800     0.558
  194     94       1     0.664     0.794     0.549
  211     93       1     0.656     0.789     0.539
  219     92       1     0.648     0.783     0.530
  230     90       1     0.640     0.778     0.520
  242     89       1     0.632     0.773     0.511
  248     88       1     0.624     0.767     0.501
  268     87       1     0.616     0.761     0.492
  272     86       1     0.608     0.756     0.482
  273     85       1     0.600     0.750     0.473
  276     84       1     0.592     0.745     0.464
  288     83       1     0.584     0.739     0.454
  318     82       1     0.576     0.733     0.445
  332     81       1     0.568     0.727     0.436
  363     80       1     0.560     0.722     0.427
  381     79       1     0.552     0.716     0.418
  383     78       1     0.544     0.710     0.409
  390     77       2     0.528     0.698     0.392
  414     75       1     0.520     0.692     0.383
  418     74       1     0.512     0.686     0.374
  421     73       1     0.504     0.680     0.366
  422     72       1     0.496     0.674     0.357
  456     71       1     0.488     0.667     0.349
  466     70       1     0.480     0.661     0.340
  467     69       1     0.472     0.655     0.332
  481     68       1     0.464     0.649     0.324
  486     67       1     0.455     0.642     0.315
  487     66       1     0.447     0.636     0.307
  526     65       1     0.439     0.629     0.299
  606     63       1     0.431     0.623     0.291
  609     62       1     0.423     0.616     0.283
  625     61       1     0.415     0.609     0.275
  641     60       1     0.407     0.603     0.267
  662     59       1     0.399     0.596     0.260
  677     58       1     0.391     0.589     0.252
  704     57       1     0.383     0.582     0.244
  748     56       1     0.374     0.575     0.237
 1063     47       1     0.365     0.567     0.228
 1074     46       1     0.356     0.559     0.220
 2204      9       1     0.313     0.520     0.182</code></pre>
</div>
</div>
</section></section><section id="adjustment-for-ties-optional" class="level1" data-number="9"><h1 data-number="9">
<span class="header-section-number">9</span> Adjustment for Ties (optional)</h1>
<section id="section" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="section">
<span class="header-section-number">9.1</span> </h2>
<p>At each time <span class="math inline">\(t_i\)</span> at which more than one of the subjects has an event, let <span class="math inline">\(d_i\)</span> be the number of events at that time, <span class="math inline">\(D_i\)</span> the set of subjects with events at that time, and let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Let <span class="math display">\[\bar\eta_i = \beta_1s_{i1}+\cdots+\beta_ps_{ip}\]</span> and <span class="math inline">\(\bar\theta_i = \exp(\bar\eta_i)\)</span>.</p>
<p>Let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Note that</p>
<p><span class="math display">\[
\begin{aligned}
\bar\eta_i &amp;=\sum_{j \in D_i}\beta_1x_{j1}+\cdots+\beta_px_{jp}\\
&amp;= \beta_1s_{i1}+\cdots+\beta_ps_{ip}\\
\bar\theta_i &amp;= \exp(\bar\eta_i)\\
&amp;= \prod_{j \in D_i}\theta_i
\end{aligned}
\]</span></p>
<section id="breslows-method-for-ties" class="level3"><h3 class="anchored" data-anchor-id="breslows-method-for-ties">Breslow’s method for ties</h3>
<p>Breslow’s method estimates the partial likelihood as</p>
<p><span class="math display">\[
\begin{aligned}
L(\beta|T) &amp;=
\prod_i \frac{\bar\theta_i}{[\sum_{k \in R(t_i)} \theta_k]^{d_i}}\\
&amp;= \prod_i \prod_{j \in D_i}\frac{\theta_j}{\sum_{k \in R(t_i)} \theta_k}
\end{aligned}
\]</span></p>
<p>This method is equivalent to treating each event as distinct and using the non-ties formula. It works best when the number of ties is small. It is the default in many statistical packages, including PROC PHREG in SAS.</p>
</section><section id="efrons-method-for-ties" class="level3"><h3 class="anchored" data-anchor-id="efrons-method-for-ties">Efron’s method for ties</h3>
<p>The other common method is Efron’s, which is the default in R.</p>
<p><span class="math display">\[L(\beta|T)=
\prod_i \frac{\bar\theta_i}{\prod_{j=1}^{d_i}[\sum_{k \in R(t_i)} \theta_k-\frac{j-1}{d_i}\sum_{k \in D_i} \theta_k]}\]</span> This is closer to the exact discrete partial likelihood when there are many ties.</p>
<p>The third option in R (and an option also in SAS as <code>discrete</code>) is the “exact” method, which is the same one used for matched logistic regression.</p>
</section><section id="example-breslows-method" class="level3"><h3 class="anchored" data-anchor-id="example-breslows-method">Example: Breslow’s method</h3>
<p>Suppose as an example we have a time <span class="math inline">\(t\)</span> where there are 20 individuals at risk and three failures. Let the three individuals have risk parameters <span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span> and let the sum of the risk parameters of the remaining 17 individuals be <span class="math inline">\(\theta_R\)</span>. Then the factor in the partial likelihood at time <span class="math inline">\(t\)</span> using Breslow’s method is</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\]</span></p>
</div>
<p>If on the other hand, they had died in the order 1,2, 3, then the contribution to the partial likelihood would be:</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_3}\right)
\]</span></p>
</div>
<p>as the risk set got smaller with each failure. The exact method roughly averages the results for the six possible orderings of the failures.</p>
</section><section id="example-efrons-method" class="level3"><h3 class="anchored" data-anchor-id="example-efrons-method">Example: Efron’s method</h3>
<p>But we don’t know the order they failed in, so instead of reducing the denominator by one risk coefficient each time, we reduce it by the same fraction. This is Efron’s method.</p>
<div class="smaller">
<p><span class="math display">\[\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+2(\theta_1+\theta_2+\theta_3)/3}\right)
\left(\frac{\theta_3}{\theta_R+(\theta_1+\theta_2+\theta_3)/3}\right)\]</span></p>
</div>


<!-- -->

</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./intro-to-survival-analysis.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./coxph-model-building.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building Cox Proportional Hazards models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Proportional Hazards Models"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="an">date-format:</span><span class="co"> "[Last modified:] YYYY-MM-DD: H:mm:ss (A)"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="an">subject:</span><span class="co"> "EPI 204 Spring 2023"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 2</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show the code"</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">  revealjs:</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: dark</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">    smaller: false</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 2</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co">    slide-number: true</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">    scrollable: true</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co">    echo: true</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "[R code]"</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co">    auto-stretch: false</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co">    # chalkboard: true</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">    # fig-width: 7</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co">    # fig-height: 5</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co">    # out-width: "100%"</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="co">  pdf:</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-cap-location: top</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="co">    number-depth: 3</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown:</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="co">    wrap: 72</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>::: hidden</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>\def\cd{\cdot}</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>\def\eqdef{\stackrel{\text{def}}{=}}</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>\def\se{\text{SE}}</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>\def\hse{\hat{\se}}</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>\def\hb{\hat\beta}</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>\def\za{z_{1 - \frac{\alpha}{2}}}</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>\def\cirad{\za \cd \hse(\hb)}</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>\def\ci{\hb {\color{red}\pm} \cirad}</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>\newcommand{\var}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\text{Var}\left(#1\right)}</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>\newcommand{\Var}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\text{Var}\left(#1\right)}</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>\newcommand{\varh}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\hat{\text{Var}}\left(#1\right)}</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>\newcommand{\vc}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\boldsymbol{#1}}</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>::: {.content-hidden when-format="revealjs"}</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Configuring R {.unnumbered}</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>Functions from these packages will be used throughout this document:</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{r packages, message = FALSE}</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pander) <span class="co"># format tables for markdown</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># graphics</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggeasy) <span class="co"># help with graphics</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># manipulate data</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven) <span class="co"># import Stata files</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co"># format R output for markdown</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># Tools to help to create tidy data</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly) <span class="co"># interactive graphics</span></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dobson) <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parameters) <span class="co"># format model output tables for markdown</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(conflicted) <span class="co"># check for conflicting function definitions</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>Here are some R settings I use in this document:</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r options, message=FALSE}</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>()) <span class="co"># delete any data that's already loaded into R</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">message =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>pander<span class="sc">::</span><span class="fu">panderOptions</span>(<span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span>)</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">'digits'</span> <span class="ot">=</span> <span class="dv">4</span>)</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a><span class="fu"># The proportional hazards model</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background on the Proportional Hazards Model</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>The exponential distribution has constant hazard:</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>f(t) &amp;= \lambda e^{-\lambda t}<span class="sc">\\</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>S(t) &amp;= e^{-\lambda t}<span class="sc">\\</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>h(t) &amp;= \lambda</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>Let's make two generalizations. First, we let the hazard depend on some</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>covariates $x_1,x_2, \dots, x_p$; we will indicate this dependence by extending our notation for hazard:</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>$$h(t|\boldsymbol x) \eqdef p(T=t|T\ge t, \boldsymbol X = \boldsymbol x)$$</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>Second, we let the base hazard depend on $t$, but not on the covariates (for now). We can do this using either parametric or semi-parametric approaches.</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cox's Proportional Hazards Model</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>The generalization is that the hazard function is </span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>h(t|x)&amp;= h_0(t)\theta(x)<span class="sc">\\</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>\theta(x) &amp;= \exp<span class="sc">\{</span>\eta(x)<span class="sc">\}\\</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>\eta(x) &amp;= x'\beta<span class="sc">\\</span></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>&amp;\eqdef \beta_1x_1+\cdots+\beta_px_p</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>The relationship between $h(t|x)$ and $\eta(x)$ has a log link (that is, $\log<span class="sc">\{</span>h(t|x)<span class="sc">\}</span> = \log<span class="sc">\{</span>h_0(t)<span class="sc">\}</span> + \eta(x)$), as in a generalized linear model.</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>This model is **semi-parametric**, because the linear predictor depends on estimated</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>parameters but the base hazard function is unspecified. </span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>There is no constant term in $\eta(x)$, because it is absorbed in the base hazard. </span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>Alternatively, we could define $\beta_0(t) = \log<span class="sc">\{</span>h_0(t)<span class="sc">\}</span>$, and then $\eta(x,t) = \beta_0(t) + \beta_1x_1+\cdots+\beta_px_p$.</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>For two different individuals with covariate patterns $\boldsymbol x_1$ and $\boldsymbol x_2$, the ratio of the hazard functions (a.k.a. **hazard ratio**, a.k.a. **relative hazard**) is:</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{h_0(t)\theta(\boldsymbol x_1)}{h_0(t)\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>Under the proportional hazards model, this ratio (a.k.a. proportion) does not depend on $t$. This property is a structural limitation of the model; it is called the **proportional hazards assumption**.</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>::: {#def-pha}</span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a><span class="fu">## proportional hazards</span></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>A conditional probability distribution $p(T|X)$ has **proportional hazards** if the hazard ratio $h(t|\boldsymbol x_1)/h(t|\boldsymbol x_2)$ does not depend on $t$. Mathematically, it can be written as:</span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>= \theta(\boldsymbol x_1,\boldsymbol x_2)</span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a>As we saw above, Cox's proportional hazards model has this property, with $\theta(\boldsymbol x_1,\boldsymbol x_2) = \frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}$.</span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>We are using two similar notations, $\theta(\boldsymbol x_1,\boldsymbol x_2)$ and $\theta(\boldsymbol x)$. We can link these notations if we define $\theta(\boldsymbol x) \eqdef \theta(\boldsymbol x, \boldsymbol 0)$ and $\theta(\boldsymbol 0) = 1$.</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a>It also has additional notable properties:</span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}</span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol x_1)}{\theta(\boldsymbol x_2)}<span class="sc">\\</span></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\exp<span class="sc">\{</span>\eta(\boldsymbol x_1)<span class="sc">\}</span>}{\exp<span class="sc">\{</span>\eta(\boldsymbol x_2)<span class="sc">\}</span>}<span class="sc">\\</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>&amp;=\exp<span class="sc">\{</span>\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)<span class="sc">\}\\</span></span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>&amp;=\exp<span class="sc">\{</span>\boldsymbol x_1'\beta-\boldsymbol x_2'\beta<span class="sc">\}\\</span></span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>&amp;=\exp<span class="sc">\{</span>(\boldsymbol x_1 - \boldsymbol x_2)'\beta<span class="sc">\}\\</span></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>Hence on the log scale, we have:</span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>\log\left<span class="sc">\{</span>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right<span class="sc">\}</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>&amp;=\eta(\boldsymbol x_1)-\eta(\boldsymbol x_2)<span class="sc">\\</span></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>&amp;= \boldsymbol x_1'\beta-\boldsymbol x_2'\beta<span class="sc">\\</span></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>&amp;= (\boldsymbol x_1 - \boldsymbol x_2)'\beta</span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>If only one covariate $x_j$ is changing, then:</span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>\log\left<span class="sc">\{</span>\frac{h(t|\boldsymbol x_1)}{h(t|\boldsymbol x_2)}\right<span class="sc">\}</span> </span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>&amp;=  (x_{1j} - x_{2j}) \cdot \beta_j<span class="sc">\\</span></span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>&amp;\propto (x_{1j} - x_{2j})</span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>That is, under Cox's model $h(t|\boldsymbol x) = h_0(t)\exp<span class="sc">\{</span>\boldsymbol x'\beta<span class="sc">\}</span>$, the log of the hazard ratio is proportional to the difference in $x_j$, with the proportionality coefficient equal to $\beta_j$.</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>Further,</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a>\log\left<span class="sc">\{</span>h(t|\boldsymbol x)\right<span class="sc">\}</span></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a>&amp;=\log\left<span class="sc">\{</span>h_0(t)\right<span class="sc">\}</span>  + x'\beta</span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a>That is, the covariate effects are additive on the log-hazard scale.</span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a>See also: </span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22&gt;</span></span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional properties of the proportional hazards model</span></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a>If $h(t|x)= h_0(t)\theta(x)$, then:</span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cumulative hazards are also proportional to $H_0(t)$</span></span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a>H(t|x)</span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a>&amp;\eqdef \int_{u=0}^t h(u)du<span class="sc">\\</span></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a>&amp;= \int_{u=0}^t h_0(u)\theta(x)du<span class="sc">\\</span></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a>&amp;= \theta(x)\int_{u=0}^t h_0(u)du<span class="sc">\\</span></span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a>&amp;= \theta(x)H_0(t)</span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a>where $H_0(t) \eqdef H(t|0) = \int_{u=0}^t h_0(u)du$.</span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a><span class="fu">### Survival functions are exponential multiples of $S_0(t)$</span></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a>S(t|x)</span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a>&amp;= \exp<span class="sc">\{</span>-H(t|x)<span class="sc">\}\\</span></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a>&amp;= \exp<span class="sc">\{</span>-\theta(x)\cdot H_0(t)<span class="sc">\}\\</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a>&amp;= \left(\exp<span class="sc">\{</span>- H_0(t)<span class="sc">\}</span>\right)^{\theta(x)}<span class="sc">\\</span></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a>&amp;= \left(S_0(t)\right)^{\theta(x)}<span class="sc">\\</span></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a>where $S_0(t) \eqdef P(T\ge t | \boldsymbol X = 0)$ is the survival function for an individual whose covariates are all equal to their default values.</span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing the proportional hazards assumption</span></span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard and often the cumulative hazard.</span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a>If the hazards of the three groups are proportional, that means that the ratio of the hazards is constant over $t$. We can test this using the ratios of the estimated cumulative hazards, which also would be</span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a>proportional, as shown above.</span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv)</span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(bmt)</span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">=</span> </span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a>  bmt <span class="sc">|&gt;</span> </span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> </span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a>      group <span class="sc">|&gt;</span> </span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>)))</span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a>nafit <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> <span class="fu">Surv</span>(t2,d3) <span class="sc">~</span> group,</span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"fleming-harrington"</span>,</span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> bmt)</span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>bmt_curves <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">timevec =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>)</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>sf1 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">1</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a>sf2 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">2</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>sf3 <span class="ot">&lt;-</span> <span class="fu">with</span>(nafit[<span class="dv">3</span>], <span class="fu">stepfun</span>(time,<span class="fu">c</span>(<span class="dv">1</span>,surv)))</span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>bmt_curves <span class="ot">=</span> </span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>  bmt_curves <span class="sc">|&gt;</span> </span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz1 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf1</span>(timevec)),</span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz2 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf2</span>(timevec)),</span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumhaz3 =</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">sf3</span>(timevec)))</span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hazard Ratios by Disease Group"</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a>bmt_rel_hazard_plot <span class="ot">=</span> </span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a>  bmt_curves <span class="sc">|&gt;</span> </span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> timevec,</span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> cumhaz1<span class="sc">/</span>cumhaz2)</span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"ALL/Low Risk AML"</span>)) <span class="sc">+</span> </span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Hazard Ratio"</span>) <span class="sc">+</span></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> </span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cumhaz3<span class="sc">/</span>cumhaz1, <span class="at">col =</span> <span class="st">"High Risk AML/ALL"</span>)) <span class="sc">+</span></span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> cumhaz3<span class="sc">/</span>cumhaz2, <span class="at">col =</span> <span class="st">"High Risk AML/Low Risk AML"</span>)) <span class="sc">+</span></span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Comparison"</span>) <span class="sc">+</span></span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bmt_rel_hazard_plot)</span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a>We can zoom in on 30-300 days to take a closer look:</span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hazard Ratios by Disease Group (30-300 Days)"</span></span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>bmt_rel_hazard_plot <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">300</span>))</span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothed hazard functions</span></span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a>The Nelson-Aalen estimate of the cumulative hazard is usually used for</span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a>estimates of the hazard. Since the hazard is the derivative of the</span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a>cumulative hazard, we need a smooth estimate of the cumulative hazard,</span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a>which is provided by smoothing the step-function cumulative hazard.</span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a>The R package <span class="in">`muhaz`</span> handles this for us. What we are looking for is</span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a>whether the hazard function is more or less the same shape, increasing,</span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a>decreasing, constant, etc. Are the hazards "proportional"?</span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Disease-Free Cumulative Hazard by Disease Group"</span></span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(t2,d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt),</span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun=</span><span class="st">"cumhaz"</span>,</span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark.time =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>,<span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-356"><a href="#cb23-356" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Smoothed Hazard Rate Estimates by Disease Group"</span></span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"High Risk AML"</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"ALL"</span>) <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a><span class="fu">muhaz</span>(bmt<span class="sc">$</span>t2,bmt<span class="sc">$</span>d3,bmt<span class="sc">$</span>group<span class="sc">==</span><span class="st">"Low Risk AML"</span>) <span class="sc">|&gt;</span> <span class="fu">lines</span>(<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,<span class="fu">c</span>(<span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a>Group 3 was plotted first because it has the highest hazard.</span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a>We will see that except for an initial blip in the high risk AML group,</span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a>the hazards look roughly proportional . They are all strongly</span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a>decreasing.</span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting the Proportional Hazards Model</span></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a>How do we fit a proportional hazards regression model? We need to</span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a>estimate the coefficients of the covariates, and we need to estimate the</span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a>base hazard $h_0(t)$. For the covariates, supposing for simplicity that</span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a>there are no tied event times, let the event times for the whole data</span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a>set be $t_1, t_2,\ldots,t_D$. Let the risk set at time $t_i$ be $R(t_i)$</span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a>and </span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a>\eta(\boldsymbol{x}) &amp;= \beta_1x_{1}+\cdots+\beta_p x_{p}<span class="sc">\\</span></span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a>\theta(\boldsymbol{x}) &amp;= e^{\eta(\boldsymbol{x})}<span class="sc">\\</span></span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a>h(t|X=x)&amp;= h_0(t)e^{\eta(\boldsymbol{x})}=\theta(\boldsymbol{x}) h_0(t)</span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a>Conditional on a single failure at time $t$, the probability that the</span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a>event is due to subject $f\in R(t)$ is approximately</span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-393"><a href="#cb23-393" aria-hidden="true" tabindex="-1"></a>\Pr(f \text{ fails}|\text{1 failure at } t) </span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{h_0(t)e^{\eta(\boldsymbol{x}_f)}}{\sum_{k \in R(t)}h_0(t)e^{\eta(\boldsymbol{x}_f)}}<span class="sc">\\</span></span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a>&amp;=\frac{\theta(\boldsymbol{x}_f)}{\sum_{k \in R(t)} \theta(\boldsymbol{x}_k)}</span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a>The logic behind this has several steps. We first fix (ex post) the</span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a>failure times and note that in this discrete context, the probability</span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a>$p_j$ that a subject $j$ in the risk set fails at time $t$ is just the</span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a>hazard of that subject at that time.</span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a>If all of the $p_j$ are small, the chance that exactly one subject fails</span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a>is</span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a>\sum_{k\in R(t)}p_k\left<span class="co">[</span><span class="ot">\prod_{m\in R(t), m\ne k} (1-p_m)\right</span><span class="co">]</span>\approx\sum_{k\in R(t)}p_k</span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a>If subject $i$ is the one who experiences the event of interest at time</span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a>$t_i$, then the **partial likelihood** is</span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a>\mathcal L^*(\beta|T)=</span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\theta(x_i)}{\sum_{k \in R(t_i)} \theta(\boldsymbol{x}_k)}</span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a>and we can numerically maximize this with respect to the coefficients</span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a>$\boldsymbol{\beta}$ that specify</span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a>$\eta(\boldsymbol{x}) = \boldsymbol{x}'\boldsymbol{\beta}$. When there</span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a>are tied event times adjustments need to be made, but the likelihood is</span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a>still similar. Note that we don't need to know the base hazard to solve</span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a>for the coefficients.</span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a>Once we have coefficient estimates</span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a>$\hat{\boldsymbol{\beta}} =(\hat \beta_1,\ldots,\hat\beta_p)$, this also</span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a>defines $\hat\eta(x)$ and $\hat\theta(x)$ and then the estimated base</span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a>cumulative hazard function is $$\hat H(t)=</span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a>\sum_{t_i &lt; t} \frac{d_i}{\sum_{k\in R(t_i)} \theta(x_k)}$$ which</span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>reduces to the Nelson-Aalen estimate when there are no covariates. There</span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a>are numerous other estimates that have been proposed as well.</span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a><span class="fu"># Cox Model for the `bmt` data</span></span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit the model</span></span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a>bmt.cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(t2, d3) <span class="sc">~</span> group, <span class="at">data =</span> bmt)</span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt.cox)</span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a>The table provides hypothesis tests comparing groups 2 and 3 to group 1.</span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a>Group 3 has the highest hazard, so the most significant comparison is</span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a>not directly shown.</span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>The coefficient 0.3834 is on the log-hazard-ratio scale, as in</span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>log-risk-ratio. The next column gives the hazard ratio 1.4673, and a</span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a>hypothesis (Wald) test.</span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a>The (not shown) group 3 vs. group 2 log hazard ratio is 0.3834 + 0.5742</span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a>= 0.9576. The hazard ratio is then exp(0.9576) or 2.605.</span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>Inference on all coefficients and combinations can be constructed using</span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a><span class="in">`coef(bmt.cox)`</span> and <span class="in">`vcov(bmt.cox)`</span> as with logistic and poisson</span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a>regression.</span>
<span id="cb23-459"><a href="#cb23-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-460"><a href="#cb23-460" aria-hidden="true" tabindex="-1"></a>**Concordance** is agreement of first failure between pairs of subjects</span>
<span id="cb23-461"><a href="#cb23-461" aria-hidden="true" tabindex="-1"></a>and higher predicted risk between those subjects, omitting</span>
<span id="cb23-462"><a href="#cb23-462" aria-hidden="true" tabindex="-1"></a>non-informative pairs.</span>
<span id="cb23-463"><a href="#cb23-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-464"><a href="#cb23-464" aria-hidden="true" tabindex="-1"></a>The Rsquare value is Cox and Snell's pseudo R-squared and is not very</span>
<span id="cb23-465"><a href="#cb23-465" aria-hidden="true" tabindex="-1"></a>useful.</span>
<span id="cb23-466"><a href="#cb23-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-467"><a href="#cb23-467" aria-hidden="true" tabindex="-1"></a><span class="in">`summary()`</span> prints three tests for whether the model with the group</span>
<span id="cb23-468"><a href="#cb23-468" aria-hidden="true" tabindex="-1"></a>covariate is better than the one without</span>
<span id="cb23-469"><a href="#cb23-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-470"><a href="#cb23-470" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Likelihood ratio test`</span> (chi-squared)</span>
<span id="cb23-471"><a href="#cb23-471" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Wald test`</span> (also chi-squared), obtained by adding the squares of the z-scores</span>
<span id="cb23-472"><a href="#cb23-472" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Score`</span> = log-rank test, as with comparison of survival functions.</span>
<span id="cb23-473"><a href="#cb23-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-474"><a href="#cb23-474" aria-hidden="true" tabindex="-1"></a>The likelihood ratio test is probably best in smaller samples, followed</span>
<span id="cb23-475"><a href="#cb23-475" aria-hidden="true" tabindex="-1"></a>by the Wald test.</span>
<span id="cb23-476"><a href="#cb23-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-477"><a href="#cb23-477" aria-hidden="true" tabindex="-1"></a><span class="fu">## Survival Curves from the Cox Model</span></span>
<span id="cb23-478"><a href="#cb23-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-479"><a href="#cb23-479" aria-hidden="true" tabindex="-1"></a>We can take a look at the resulting group-specific curves:</span>
<span id="cb23-480"><a href="#cb23-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-483"><a href="#cb23-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-484"><a href="#cb23-484" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival Functions for Three Groups by KM and Cox Model"</span></span>
<span id="cb23-485"><a href="#cb23-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-486"><a href="#cb23-486" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3) <span class="sc">~</span> group, <span class="at">data =</span> <span class="fu">as.data.frame</span>(bmt))</span>
<span id="cb23-487"><a href="#cb23-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-488"><a href="#cb23-488" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">=</span> <span class="fu">survfit</span>(</span>
<span id="cb23-489"><a href="#cb23-489" aria-hidden="true" tabindex="-1"></a>  bmt.cox, </span>
<span id="cb23-490"><a href="#cb23-490" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> </span>
<span id="cb23-491"><a href="#cb23-491" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb23-492"><a href="#cb23-492" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group), </span>
<span id="cb23-493"><a href="#cb23-493" aria-hidden="true" tabindex="-1"></a>      <span class="at">row.names =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group)))</span>
<span id="cb23-494"><a href="#cb23-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-495"><a href="#cb23-495" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb23-496"><a href="#cb23-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-497"><a href="#cb23-497" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">KM =</span> km_fit, <span class="at">Cox =</span> cox_fit) <span class="sc">|&gt;</span> </span>
<span id="cb23-498"><a href="#cb23-498" aria-hidden="true" tabindex="-1"></a>  survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb23-499"><a href="#cb23-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># facet.by = "group",</span></span>
<span id="cb23-500"><a href="#cb23-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend =</span> <span class="st">"bottom"</span>, </span>
<span id="cb23-501"><a href="#cb23-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">""</span>,</span>
<span id="cb23-502"><a href="#cb23-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine =</span> <span class="cn">TRUE</span>, </span>
<span id="cb23-503"><a href="#cb23-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> <span class="st">'pct'</span>, </span>
<span id="cb23-504"><a href="#cb23-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> .<span class="dv">5</span>,</span>
<span id="cb23-505"><a href="#cb23-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), </span>
<span id="cb23-506"><a href="#cb23-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb23-507"><a href="#cb23-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">censor =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-508"><a href="#cb23-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>() <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span>
<span id="cb23-509"><a href="#cb23-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-510"><a href="#cb23-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-511"><a href="#cb23-511" aria-hidden="true" tabindex="-1"></a>When we use <span class="in">`survfit()`</span> with a Cox model, we have to specify the covariate levels we are interested in; the argument <span class="in">`newdata`</span> should include a <span class="in">`data.frame`</span> with the same named columns as the predictors in the Cox model and one or more levels of each.</span>
<span id="cb23-512"><a href="#cb23-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-513"><a href="#cb23-513" aria-hidden="true" tabindex="-1"></a>Otherwise (that is, if the <span class="in">`newdata`</span> argument is missing), a curve is produced for a single "pseudo" subject with covariate values equal to the means component of the fit. </span>
<span id="cb23-514"><a href="#cb23-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-515"><a href="#cb23-515" aria-hidden="true" tabindex="-1"></a>The resulting curve(s) almost never make sense, but the default remains due to an unwarranted attachment to the</span>
<span id="cb23-516"><a href="#cb23-516" aria-hidden="true" tabindex="-1"></a>option shown by some users and by other packages.</span>
<span id="cb23-517"><a href="#cb23-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-518"><a href="#cb23-518" aria-hidden="true" tabindex="-1"></a>Two particularly egregious examples are factor variables and</span>
<span id="cb23-519"><a href="#cb23-519" aria-hidden="true" tabindex="-1"></a>interactions. Suppose one were studying interspecies transmission of a virus, and the data set has a factor variable with levels ("pig", "chicken") and about equal numbers of observations for each. The "mean" covariate level will be 0.5 -- is this a flying pig?</span>
<span id="cb23-520"><a href="#cb23-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-521"><a href="#cb23-521" aria-hidden="true" tabindex="-1"></a><span class="fu">## Examining `survfit`</span></span>
<span id="cb23-522"><a href="#cb23-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-525"><a href="#cb23-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-526"><a href="#cb23-526" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt)</span>
<span id="cb23-527"><a href="#cb23-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-528"><a href="#cb23-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-531"><a href="#cb23-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-532"><a href="#cb23-532" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(t2, d3)<span class="sc">~</span>group,<span class="at">data=</span>bmt) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb23-533"><a href="#cb23-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-534"><a href="#cb23-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-537"><a href="#cb23-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-538"><a href="#cb23-538" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(bmt.cox)</span>
<span id="cb23-539"><a href="#cb23-539" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(bmt.cox, <span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group)))</span>
<span id="cb23-540"><a href="#cb23-540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-541"><a href="#cb23-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-544"><a href="#cb23-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-545"><a href="#cb23-545" aria-hidden="true" tabindex="-1"></a>bmt.cox <span class="sc">|&gt;</span> </span>
<span id="cb23-546"><a href="#cb23-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">survfit</span>(<span class="at">newdata =</span> <span class="fu">tibble</span>(<span class="at">group =</span> <span class="fu">unique</span>(bmt<span class="sc">$</span>group))) <span class="sc">|&gt;</span> </span>
<span id="cb23-547"><a href="#cb23-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb23-548"><a href="#cb23-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-549"><a href="#cb23-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-550"><a href="#cb23-550" aria-hidden="true" tabindex="-1"></a><span class="fu"># Adjustment for Ties (optional)</span></span>
<span id="cb23-551"><a href="#cb23-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-552"><a href="#cb23-552" aria-hidden="true" tabindex="-1"></a>##</span>
<span id="cb23-553"><a href="#cb23-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-554"><a href="#cb23-554" aria-hidden="true" tabindex="-1"></a>At each time $t_i$ at which more than one of the subjects has an event,</span>
<span id="cb23-555"><a href="#cb23-555" aria-hidden="true" tabindex="-1"></a>let $d_i$ be the number of events at that time, $D_i$ the set of</span>
<span id="cb23-556"><a href="#cb23-556" aria-hidden="true" tabindex="-1"></a>subjects with events at that time, and let $s_i$ be a covariate vector</span>
<span id="cb23-557"><a href="#cb23-557" aria-hidden="true" tabindex="-1"></a>for an artificial subject obtained by adding up the covariate values for</span>
<span id="cb23-558"><a href="#cb23-558" aria-hidden="true" tabindex="-1"></a>the subjects with an event at time $t_i$. Let</span>
<span id="cb23-559"><a href="#cb23-559" aria-hidden="true" tabindex="-1"></a>$$\bar\eta_i = \beta_1s_{i1}+\cdots+\beta_ps_{ip}$$ and</span>
<span id="cb23-560"><a href="#cb23-560" aria-hidden="true" tabindex="-1"></a>$\bar\theta_i = \exp(\bar\eta_i)$.</span>
<span id="cb23-561"><a href="#cb23-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-562"><a href="#cb23-562" aria-hidden="true" tabindex="-1"></a>Let $s_i$ be a covariate vector for an artificial subject obtained by</span>
<span id="cb23-563"><a href="#cb23-563" aria-hidden="true" tabindex="-1"></a>adding up the covariate values for the subjects with an event at time</span>
<span id="cb23-564"><a href="#cb23-564" aria-hidden="true" tabindex="-1"></a>$t_i$. Note that </span>
<span id="cb23-565"><a href="#cb23-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-566"><a href="#cb23-566" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-567"><a href="#cb23-567" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-568"><a href="#cb23-568" aria-hidden="true" tabindex="-1"></a>\bar\eta_i &amp;=\sum_{j \in D_i}\beta_1x_{j1}+\cdots+\beta_px_{jp}<span class="sc">\\</span></span>
<span id="cb23-569"><a href="#cb23-569" aria-hidden="true" tabindex="-1"></a>&amp;= \beta_1s_{i1}+\cdots+\beta_ps_{ip}<span class="sc">\\</span></span>
<span id="cb23-570"><a href="#cb23-570" aria-hidden="true" tabindex="-1"></a>\bar\theta_i &amp;= \exp(\bar\eta_i)<span class="sc">\\</span></span>
<span id="cb23-571"><a href="#cb23-571" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_{j \in D_i}\theta_i</span>
<span id="cb23-572"><a href="#cb23-572" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-573"><a href="#cb23-573" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-574"><a href="#cb23-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-575"><a href="#cb23-575" aria-hidden="true" tabindex="-1"></a><span class="fu">### Breslow's method for ties</span></span>
<span id="cb23-576"><a href="#cb23-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-577"><a href="#cb23-577" aria-hidden="true" tabindex="-1"></a>Breslow's method estimates the partial likelihood as</span>
<span id="cb23-578"><a href="#cb23-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-579"><a href="#cb23-579" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-580"><a href="#cb23-580" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-581"><a href="#cb23-581" aria-hidden="true" tabindex="-1"></a>L(\beta|T) &amp;=</span>
<span id="cb23-582"><a href="#cb23-582" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\bar\theta_i}{<span class="co">[</span><span class="ot">\sum_{k \in R(t_i)} \theta_k</span><span class="co">]</span>^{d_i}}<span class="sc">\\</span></span>
<span id="cb23-583"><a href="#cb23-583" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_i \prod_{j \in D_i}\frac{\theta_j}{\sum_{k \in R(t_i)} \theta_k}</span>
<span id="cb23-584"><a href="#cb23-584" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-585"><a href="#cb23-585" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-586"><a href="#cb23-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-587"><a href="#cb23-587" aria-hidden="true" tabindex="-1"></a>This method is equivalent to treating each event as distinct and using the non-ties formula. </span>
<span id="cb23-588"><a href="#cb23-588" aria-hidden="true" tabindex="-1"></a>It works best when the number of ties is small. </span>
<span id="cb23-589"><a href="#cb23-589" aria-hidden="true" tabindex="-1"></a>It is the default in many statistical packages, including PROC PHREG in SAS.</span>
<span id="cb23-590"><a href="#cb23-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-591"><a href="#cb23-591" aria-hidden="true" tabindex="-1"></a><span class="fu">### Efron's method for ties</span></span>
<span id="cb23-592"><a href="#cb23-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-593"><a href="#cb23-593" aria-hidden="true" tabindex="-1"></a>The other common method is Efron's, which is the default in R.</span>
<span id="cb23-594"><a href="#cb23-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-595"><a href="#cb23-595" aria-hidden="true" tabindex="-1"></a>$$L(\beta|T)=</span>
<span id="cb23-596"><a href="#cb23-596" aria-hidden="true" tabindex="-1"></a>\prod_i \frac{\bar\theta_i}{\prod_{j=1}^{d_i}<span class="co">[</span><span class="ot">\sum_{k \in R(t_i)} \theta_k-\frac{j-1}{d_i}\sum_{k \in D_i} \theta_k</span><span class="co">]</span>}$$</span>
<span id="cb23-597"><a href="#cb23-597" aria-hidden="true" tabindex="-1"></a>This is closer to the exact discrete partial likelihood when there are</span>
<span id="cb23-598"><a href="#cb23-598" aria-hidden="true" tabindex="-1"></a>many ties.</span>
<span id="cb23-599"><a href="#cb23-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-600"><a href="#cb23-600" aria-hidden="true" tabindex="-1"></a>The third option in R (and an option also in SAS as <span class="in">`discrete`</span>) is the</span>
<span id="cb23-601"><a href="#cb23-601" aria-hidden="true" tabindex="-1"></a>"exact" method, which is the same one used for matched logistic</span>
<span id="cb23-602"><a href="#cb23-602" aria-hidden="true" tabindex="-1"></a>regression.</span>
<span id="cb23-603"><a href="#cb23-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-604"><a href="#cb23-604" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: Breslow's method</span></span>
<span id="cb23-605"><a href="#cb23-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-606"><a href="#cb23-606" aria-hidden="true" tabindex="-1"></a>Suppose as an example we have a time $t$ where there are 20 individuals</span>
<span id="cb23-607"><a href="#cb23-607" aria-hidden="true" tabindex="-1"></a>at risk and three failures. Let the three individuals have risk</span>
<span id="cb23-608"><a href="#cb23-608" aria-hidden="true" tabindex="-1"></a>parameters $\theta_1, \theta_2, \theta_3$ and let the sum of the risk</span>
<span id="cb23-609"><a href="#cb23-609" aria-hidden="true" tabindex="-1"></a>parameters of the remaining 17 individuals be $\theta_R$. Then the</span>
<span id="cb23-610"><a href="#cb23-610" aria-hidden="true" tabindex="-1"></a>factor in the partial likelihood at time $t$ using Breslow's method is</span>
<span id="cb23-611"><a href="#cb23-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-612"><a href="#cb23-612" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb23-613"><a href="#cb23-613" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-614"><a href="#cb23-614" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb23-615"><a href="#cb23-615" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb23-616"><a href="#cb23-616" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb23-617"><a href="#cb23-617" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-618"><a href="#cb23-618" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-619"><a href="#cb23-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-620"><a href="#cb23-620" aria-hidden="true" tabindex="-1"></a>If on the other hand, they had died in the order 1,2, 3, then the</span>
<span id="cb23-621"><a href="#cb23-621" aria-hidden="true" tabindex="-1"></a>contribution to the partial likelihood would be:</span>
<span id="cb23-622"><a href="#cb23-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-623"><a href="#cb23-623" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb23-624"><a href="#cb23-624" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-625"><a href="#cb23-625" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb23-626"><a href="#cb23-626" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+\theta_2+\theta_3}\right)</span>
<span id="cb23-627"><a href="#cb23-627" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+\theta_3}\right)</span>
<span id="cb23-628"><a href="#cb23-628" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-629"><a href="#cb23-629" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-630"><a href="#cb23-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-631"><a href="#cb23-631" aria-hidden="true" tabindex="-1"></a>as the risk set got smaller with each failure. The exact method roughly</span>
<span id="cb23-632"><a href="#cb23-632" aria-hidden="true" tabindex="-1"></a>averages the results for the six possible orderings of the failures.</span>
<span id="cb23-633"><a href="#cb23-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-634"><a href="#cb23-634" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: Efron's method</span></span>
<span id="cb23-635"><a href="#cb23-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-636"><a href="#cb23-636" aria-hidden="true" tabindex="-1"></a>But we don't know the order they failed in, so instead of reducing the</span>
<span id="cb23-637"><a href="#cb23-637" aria-hidden="true" tabindex="-1"></a>denominator by one risk coefficient each time, we reduce it by the same</span>
<span id="cb23-638"><a href="#cb23-638" aria-hidden="true" tabindex="-1"></a>fraction. This is Efron's method.</span>
<span id="cb23-639"><a href="#cb23-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-640"><a href="#cb23-640" aria-hidden="true" tabindex="-1"></a>::: smaller</span>
<span id="cb23-641"><a href="#cb23-641" aria-hidden="true" tabindex="-1"></a>$$\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)</span>
<span id="cb23-642"><a href="#cb23-642" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_2}{\theta_R+2(\theta_1+\theta_2+\theta_3)/3}\right)</span>
<span id="cb23-643"><a href="#cb23-643" aria-hidden="true" tabindex="-1"></a>\left(\frac{\theta_3}{\theta_R+(\theta_1+\theta_2+\theta_3)/3}\right)$$</span>
<span id="cb23-644"><a href="#cb23-644" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
 Copyright 2023, Douglas Ezra Morrison
  </li>  
</ul>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
    <a class="nav-link" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">License</a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>